# Passport 统一认证中心 - 视图 5：测试工程视图（QA）

> 说明：本视图从测试工程（QA）角度，基于《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版）中的 FL-01 ～ FL-05，整理每个功能点的正向测试、反向测试、异常场景与已知“信息缺口”，以便生成测试用例或自动化测试代码时有清晰边界。所有 US/BR/FL/AC 引用均以主 PRD 为准，本视图仅提供测试视角的整理与补充说明，如与主 PRD 存在任何不一致，应一律以主 PRD 为准。

---

## 1. 功能点（FL）总览

| FL ID | 名称                         | 关联 US | 关联 BR | 备注 |
|-------|------------------------------|--------|--------|------|
| FL-01 | 手机号登录/注册流程          | US-01  | BR-02, BR-03, BR-09(建议新增) | 登录/注册主流程 |
| FL-02 | Token 刷新流程               | US-01, US-02 | BR-03, BR-04 | Access/Refresh 生命周期与刷新策略 |
| FL-03 | Token 验证流程               | -      | BR-03, BR-05 | API-04 语义，与通用认证中间件一致 |
| FL-04 | 跨客户端 SSO 流程            | US-02  | BR-03, BR-04, BR-06 | 依赖本地会话文件与刷新流程 |
| FL-05 | 会话销毁（退出登录）流程     | US-04  | BR-07, BR-08 | 退出/封禁后的全局会话清理 |

---

## 2. 各功能点测试点与缺口

### 2.1 FL-01 手机号登录/注册流程

**正向测试点**

1. **已有用户登录**
   - 前置：用户已存在，User.status = 1。 
   - 步骤：输入合法手机号 + 有效验证码，点击登录。
   - 预期：
     - API-02 返回 200，`data` 中包含 `guid`、`access_token`、`refresh_token` 等；
     - Redis 中存在 `session:{guid}`；
     - LocalSession 中写入对应字段（由客户端验证）；
     - 用户信息表中 last_login_at 更新，login_count +1，login_days 按天累加。

2. **新用户注册 + 登录**
   - 前置：手机号未在 User 表中出现。  
   - 预期：
     - 生成新的 GUID，写入 User 表；
     - 后续流程同“已有用户登录”。

**反向测试点**

1. 非法手机号格式：
   - 预期：前端本地校验失败，不发送请求；或 API-02 返回参数错误码（需 ERR 补充）。
2. 验证码错误、过期、频率超限：
   - 预期：API-02 返回对应的错误码（如 ERR_CODE_INVALID、ERR_CODE_EXPIRED、ERR_CODE_TOO_FREQUENT），不创建/更新会话。
3. 封禁用户（User.status=0）：
   - 预期：API-02 返回 403 + ERR_USER_BANNED，不签发 Token，不创建/更新会话。

**异常场景**

1. 短信网关失败：应产生告警，返回通用错误码，提示用户稍后重试。
2. Redis 暂时不可用：登录业务应如何降级（当前 PRD 未定义，属于缺口）。
3. MySQL 写入失败（注册或更新登录信息时）：需保证不会产生“半注册”状态。

**信息缺口（需 PRD/技术方案补充）**

- 具体错误码与 HTTP 状态（参考视图 4 建议）；
- 验证码规则（有效期、长度、限流）结构化描述（参考视图 1/4 中 BR-09 建议）；
- Redis/MySQL 故障时的降级策略（14/16 章可补）。

---

### 2.2 FL-02 Token 刷新流程

**正向测试点**

1. 正常刷新：
   - 前置：已有有效会话，Refresh Token 未过期；
   - 步骤：客户端在配置的时间点调用 API-03；
   - 预期：返回新的 Access Token，更新 Redis 中对应 app_id 的 access_token 和过期时间。

2. 幂等刷新：
   - 同一 Refresh Token + app_id 在短时间内多次调用 API-03；
   - 预期：返回相同或等价的结果（例如同一有效期窗口内返回同一个 Access Token 或新的但前一个立即失效），整体行为幂等。

**反向测试点**

1. 使用过期的 Refresh Token：
   - 预期：API-03 返回 ERR_REFRESH_EXPIRED（401），不更新 Redis。
2. 使用伪造/不匹配的 Refresh Token：
   - 预期：返回 ERR_REFRESH_MISMATCH（401），不更新 Redis。

**异常场景**

1. Redis 不可用或网络抖动：
   - 预期：服务端返回 5xx，客户端按 FL-02 定义重试最多 2 次；超过后不再自动重试，前端提示用户重新登录。

**信息缺口**

- 具体错误码与 HTTP 状态（需在 13 章补充）；
- 多区域/多实例部署下 Refresh Token 校验的一致性（当前 PRD 假设单机 Redis）。

---

### 2.3 FL-03 Token 验证流程

**正向测试点**

1. 合法 Access Token + app_id：
   - 预期：API-04 返回 valid=true，guid 与 Redis 中一致，expires_at 正确。

**反向测试点**

1. Access Token 过期；
2. Access Token 对应的 app_id 与请求 app_id 不符；
3. Access Token 被篡改或签名验证失败。

**异常场景**

1. Redis 与 JWT 中的 Token 不一致（例如 Redis 中已被刷新/销毁）。

**信息缺口**

- 不同错误场景对应的错误码及 HTTP 状态仍需在 ERR 中细化（视图 4 中已给建议）。

---

### 2.4 FL-04 跨客户端 SSO 流程

**正向测试点**

1. A 客户端登录后 B 客户端自动登录：
   - 确认九尾狐登录完成后生成的 session.dat 可被游利社通过壳层/原生模块读取并完成自动登录；
   - 验证 B 客户端是否获得自己的 Access Token，且用户信息与 Redis 会话一致。

**反向测试点**

1. session.dat 创建时间超过 2 小时：
   - 预期：壳层在启动时删除文件，B 客户端必须出现登录页，不得自动登录。
2. session.dat 内容被部分篡改（删字段/伪造 guid 等）：
   - 预期：原生模块完整性校验失败，壳层删除文件并要求重新登录。

**异常场景**

1. Windows 未正常清理 Temp 目录，但 ProgramData 中 session.dat 仍在；
2. 同一机器上存在多个 Windows 用户切换登录。

**信息缺口**

- 多 Windows 用户切换时，session.dat 与 Refresh Token 的行为尚未定义（当前假设“DPAPI 对当前用户生效”）；
- 对篡改检测后的审计日志与监控指标尚未在 12 章中详细列出。

---

### 2.5 FL-05 会话销毁（退出登录）流程

**正向测试点**

1. 用户在任一客户端点击退出登录：
   - Redis 中 `session:{guid}` 被删除；
   - 本地 session.dat 被删除；
   - 当前客户端回到登录页，其他客户端下次请求收到 401 并要求重新登录。

**反向测试点**

1. 使用已退出会话的 Access Token 调用业务接口：
   - 预期：返回未登录错误码（ERR_ACCESS_EXPIRED 或类似），不允许继续访问。

**异常场景**

1. 退出请求途中网络中断；
2. 会话已经被封禁流程删除。

**信息缺口**

- 并发退出/封禁的详细行为（以封禁结果为准）需要在 BR-07/BR-08 中明确；
- 退出/封禁产生的审计日志内容尚未在 12 章中具体列出。

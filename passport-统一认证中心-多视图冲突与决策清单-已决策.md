# Passport 统一认证中心 - 多视图冲突与决策清单（已决策）

> 说明：本文件基于《Passport 统一认证中心 - PRD（V1 多视图对齐版）》及六个工程视图文档（Web 前端 / 客户端壳层 / 原生模块 / 后端服务 / 测试工程 / 架构与产品合理性），汇总跨角色视角下的冲突点与**最终决策结果**。它**不替代**《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》（Q-01 ～ Q-19），后者仍是业务语义与范围的主决策源，本清单只补充工程实现与架构层面的决策信息。

---

## 1. 冲突与决策项总览

| 编号 | 主题                                       | 涉及条目                         | PRD 中采用的处理方式                      | 是否已决策 |
|------|--------------------------------------------|----------------------------------|------------------------------------------|------------|
| C-01 | User.status = -1 时的登录/注册行为        | BR-02, US-01, DM-01             | 采纳方案 A：注销账号不再参与登录，新注册生成新 GUID | 是         |
| C-02 | Redis 故障时的业务降级策略                | NFR 10.2, 16.2 RISK-02          | 采纳保守策略：Redis 不可用时登录/刷新/验证统一失败并提示重试 | 是         |
| C-03 | SSO 有效期 2 天 vs 网吧安全               | G-02/G-03, BR-03, 16.2          | 保持 2 天 + 2 小时阈值组合，后续版本再评估网吧模式 | 是         |
| C-04 | 多 Windows 用户切换下 LocalSession 行为   | BR-06, FL-04, DM-03             | 保持现状，视为实现与安全评审问题，在技术方案/测试中覆盖 | 是         |
| C-05 | `ERR_SESSION_NOT_FOUND` 双重语义          | ERR 13.2, 13.3, FL-04           | 采纳方案 A：复用同一 code，由上下文/接口名/子系统区分 | 是         |
| C-06 | 兼容性与迁移的具体方案                    | 14 章                           | 保持现状，迁移细节放入独立《迁移方案》文档 | 是         |
| C-07 | Redis 高可用与多机部署下一致性细节        | BR-04, BR-07, 6.2, 16.2         | 保持现状，PRD 仅约束业务语义，一致性细节交由架构设计 | 是         |
| C-08 | 管理后台隔离（无域名条件）                | NFR 16.2, SEC                   | 采纳端口隔离 + app_id 隔离 + 反代阻断 | 是         |

---

## 2. 各冲突点与最终决策说明

> 说明：本节按 C-01 ～ C-07 展开多视图审查时的问题背景与可选方案，便于回溯各角色视角的考虑过程。  
> - 顶部第 1 章总览表 + 《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版）中的相关 BR / NFR / 流程条目，代表**最终采纳的决策结果**；  
> - 下文每个 C-xx 小节中仍保留当时的“PRD 当前处理 / 建议决策”等历史描述，仅用于追溯，不再具有约束力；如与主 PRD 存在表述差异，一律以主 PRD 为准。

### C-01 User.status = -1（注销/删除）时的行为

- **涉及内容**：
  - BR-02 手机号登录/注册判定规则；
  - DM-01 User.status 字段语义；
  - US-01 登录/注册流程；
  - 测试视图 FL-01 的反向测试与异常场景。（来源：后端视图 2.2，QA 视图，架构视图）
- **问题描述**：
  - 当前仅定义了 1=正常、0=封禁、-1=注销/删除，但未说明当手机号对应用户为 -1 时，用户再次登录的行为；
  - 不同选择将影响 GUID 是否复用、用户生命周期统计、迁移策略等。
- **PRD 当前处理**：
  - 在 BR-02 中列出两种方案并标记“当前信息不足，需产品与风控评审后决定”：
    - 方案 A：允许重新注册，生成新的 GUID；
    - 方案 B：禁止重新注册，视同封禁。
- **建议决策**：
  - 若重运营、弱风控：偏向方案 A（方便用户恢复）；
  - 若重风控、合规要求高：偏向方案 B，并在注销前提示不可恢复。

---

### C-02 Redis 故障时的业务降级策略

- **涉及内容**：
  - NFR 10.2 可用性/稳定性；
  - 16.2 RISK-02；
  - 后端服务视图 2.1/2.2；
  - 测试视图 FL-01/FL-02 异常场景。
- **问题描述**：
  - 若 Redis 故障或网络分区，登录/刷新/验证等核心能力受影响；
  - 是否允许在一定时间内依赖本地 Token 或缓存“放行”，存在明显安全风险。
- **PRD 当前处理**：
  - 建议采用保守策略：Redis 不可用时，登录/刷新/验证统一失败，并提示“稍后重试”，即不引入本地绕过机制；
  - 将具体重试、告警和高可用部署等细节下沉至技术设计与运维方案。
- **建议决策**：
  - 确认是否接受“安全优先”的默认策略；
  - 如需更复杂的降级（如只在极端情况下短期信任本地 Token），需额外安全评审与合规评估。

---

### C-03 SSO 有效期（2 天）与网吧安全

- **涉及内容**：
  - G-02/G-03、BR-03、BR-06；
  - 架构/产品合理性视图 2.1；
  - QA 视图 FL-04。
- **问题描述**：
  - 当前设计：Refresh Token 有效期 2 天，SSO 有效期与之对齐，再加上 LocalSession 创建时间 2 小时阈值与 Windows 注销清理作为安全兜底；
  - 对个人设备体验友好，但对网吧等公共设备是否足够安全存在争议。
- **PRD 当前处理**：
  - 保留现有 2 天策略 + 2 小时 LocalSession 强制删除；
  - 在架构视图中建议未来评估“网吧模式”或“设备类型区分”。
- **建议决策**：
  - V1：保持现状，但将“公共设备模式/网吧模式”纳入 V2/V3 规划；
  - 若安全团队认为当前组合仍不足，可在 V1 中直接缩短 Refresh Token/SSO 有效期或引入额外交互（如定期强制回到登录页）。

---

### C-04 多 Windows 用户切换时 LocalSession 行为

- **涉及内容**：
  - BR-06 本地会话文件规则；
  - FL-04 SSO 流程；
  - DM-03 LocalSession；
  - 测试视图 FL-04 异常场景。
- **问题描述**：
  - session.dat 位于 ProgramData，而 DPAPI 绑定当前 Windows 用户；
  - 需确认多用户切换/远程桌面等复杂场景下不会出现跨用户解密或访问。
- **PRD 当前处理**：
  - 视为实现与系统安全评审问题，PRD 未进一步约束；
  - QA 视图建议将多用户切换纳入测试用例集。
- **建议决策**：
  - 在技术设计/安全评审中明确：
    - session.dat 的 ACL 配置策略；
    - 不同 Windows 登录用户下读取/解密行为的验证计划；
  - 如有需要，可在后续 PRD 版本补充更严格的权限约束描述。

---

### C-05 `ERR_SESSION_NOT_FOUND` 的双重语义

- **涉及内容**：
  - ERR 13.2 Token 与会话相关错误码；
  - ERR 13.3 本地会话文件/原生模块错误码；
  - FL-04 SSO 流程；
  - 原生/壳层视图。
- **问题描述**：
  - 同一错误码字符串 `ERR_SESSION_NOT_FOUND` 同时用于：
    - 远端：Redis 中无 `session:{guid}`；
    - 本地：`read_session_file()` 未找到 `session.dat`；
  - 在日志、监控和告警中，若仅按错误码聚合，可能混淆两种不同层面的问题。
- **PRD 当前处理**：
  - 沿用相同 code，但依赖接口名称/日志字段区分场景；
  - 在 19 章中将此列为显式冲突点。
- **建议决策**：
  - 方案 A：保留统一 code，在监控平台中增加“接口名/子系统”维度；
  - 方案 B：拆分为 `ERR_SESSION_NOT_FOUND_REMOTE` 与 `ERR_SESSION_NOT_FOUND_LOCAL` 等更细粒度代码。

---

### C-06 兼容性与迁移策略

- **涉及内容**：
  - 14 章《兼容性 & 迁移》；
  - 架构视图 2.5。
- **问题描述**：
  - 存量九尾狐/游利社用户的 GUID 生成策略；
  - 是否需要老系统 ID ↔ GUID 映射；
  - 历史登录日志是否迁移至 Passport 体系以及如何展示。
- **PRD 当前处理**：
  - 目前仅占位，未给出具体方案。
- **建议决策**：
  - 输出独立《Passport 统一认证中心 - 迁移方案》文档，包括：
    - 老用户 GUID 生成与映射；
    - 历史数据迁移/不迁移的选择与影响评估；
  - 决策结果回填至 PRD 14 章与本清单。

---

### C-07 Redis 高可用与多机部署下一致性

- **涉及内容**：
  - BR-04、BR-07、6.2 状态机、16.2 风险；
  - 后端服务视图 2.4/2.5；
  - 架构视图 3.2。
- **问题描述**：
  - 在 Redis 主从/集群部署、网络分区、主从切换等场景下，Token 刷新、验证与退出/封禁的一致性如何保证；
  - 不同架构方案（单机 + RDB/AOF、哨兵、Cluster）会导致故障行为差异。
- **PRD 当前处理**：
  - PRD 层仅要求 API 行为在业务语义上幂等与一致（如“退出 = 全局退出”、“封禁后不得再登录”）；
  - 不强制指定具体 Redis 部署架构，将其视为架构/运维设计范围。
- **建议决策**：
  - 是否在产品层面追加“必须使用 Redis 高可用部署”的硬性约束；
  - 是否需要在技术文档中定义更严格的一致性保证（如业务侧的补偿任务、审计对账等）。

---

### C-08 管理后台隔离（无域名条件）

- **涉及内容**：
  - NFR 16.2 风险项（越权/误操作/攻击面）；
  - 后台管理 UI 与 `/api/admin/*` 的暴露策略（SEC）。
- **问题描述**：
  - 在域名不可用或无法分配 `admin.<domain>` 的情况下，若管理后台与用户前端同源同入口，会带来：
    - 前端本地存储（localStorage/sessionStorage）与登录态更容易被混用；
    - 管理操作入口暴露面扩大（扫描/撞库/探测成本更低）；
    - 管理员误在“用户前端入口”进行后台操作，难以从运维层做访问控制（如安全组白名单）。
- **可选方案**：
  - 方案 A：独立域名（`admin.*`）+ HTTPS + WAF/白名单（理想方案，但当前不可用）；
  - 方案 B：同域同端口按路径隔离（`/admin`），但同源下存储与浏览器策略难以隔离；
  - 方案 C：独立端口（`ADMIN_PORT`）+ 独立 `app_id`（`ADMIN_APP_ID`）+ 反代层阻断（采纳）。
- **最终决策**：
  - 采纳方案 C，并采用“多层防护”：
    - 反代层（用户前端）阻断 `/admin` 与 `/api/admin`；
    - 管理前端走独立端口（独立 origin），并 build-time 设置 `VITE_APP_ID=ADMIN_APP_ID`；
    - 后端 `/api/admin/*` 强制校验 `app_id === ADMIN_APP_ID`，避免普通应用的 token 访问后台接口。
  - 运维约束：
    - ECS 安全组只对白名单 IP 开放 `ADMIN_PORT`；
    - 域名可用后可平滑迁移至独立子域名，策略保持不变（隔离层从“端口”升级为“域名”）。

---

## 3. 与其它文档的关系

- 《passport-统一认证中心-PRD-草稿.md》（当前 V1 多视图对齐版）：
  - 是功能、业务规则、流程、错误码等的主规格文档；
  - 本清单中的每一条冲突/决策点在 PRD 中均有对应标记或引用（主要在 BR、NFR、16、19 章）。

- 《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》：
  - 记录 Q-01 ～ Q-19 对原始需求模糊点的业务层决策；
  - 与本清单互补：该文档偏“做什么”和“业务口径”，本清单偏“怎么做”和“实现/架构口径”。

- 六个工程视图文档：
  - Web 前端 / 客户端壳层 / 原生模块 / 后端服务 / 测试工程 / 架构与产品合理性视图；
  - 是本清单的直接来源，具体技术建议与测试点仍以各视图原文为准，本清单只保留跨视角共有的冲突与待决策点。

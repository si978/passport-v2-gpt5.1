# Passport 统一认证中心 - 视图 3：原生模块工程视图（C++/C#/Rust）

> 说明：本视图从原生模块（C++/C#/Rust 等）角度审查《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版）中对系统能力（文件系统、加密、设备访问）、性能与接口形态的描述，对原生模块代码实现时的歧义点进行梳理。所有 US/BR/FL/ERR 编号与主 PRD 保持一致。本视图仅作为工程实现视角补充，如与主 PRD 存在任何不一致，应一律以主 PRD 为准。

---

## 1. 与原生模块相关的 US / BR / FL 覆盖总览

| 类型 | ID   | 在主 PRD 中的位置              | 对原生模块的相关性 | 视图结论 |
|------|------|--------------------------------|--------------------|----------|
| US   | US-01 | 登录/注册                     | 低                 | 主要为后端与前端逻辑 |
| US   | US-02 | 跨客户端 SSO                  | 高                 | 需要原生模块支持本地文件读写与 DPAPI 加解密 |
| US   | US-03 | 网吧下机自动登出              | 高                 | 启动时文件校验和删除由壳层+原生能力共同实现 |
| US   | US-04 | 用户主动退出登录               | 中                 | 删除本地会话文件时可能通过原生模块封装 |
| US   | US-05 | 后台功能                       | 无                 | 与原生模块无关 |
| BR   | BR-03 | Token 有效期                  | 低                 | 由后端与壳层/前端使用，无原生逻辑 |
| BR   | BR-06 | 本地会话文件读写与过期规则     | 很高               | 直接定义原生模块需要实现的核心逻辑 |
| BR   | BR-07 | 会话 TTL 与全局退出规则        | 中                 | 本地会话清理依赖原生模块，但规则在后端侧定义 |
| FL   | FL-04 | 跨客户端 SSO 流程              | 高                 | 涉及读取/解密/校验 `session.dat` |

---

## 2. 关键歧义点与建议

### 2.1 DPAPI 使用与接口定义（BR-06, FL-04）

**问题描述**

- PRD 指定“使用 Windows DPAPI 加密”，但未说明原生模块对壳层/前端暴露的接口形态：
  - 函数名、输入输出类型（字节数组 vs JSON 字符串）；
  - 同步/异步模型；
  - 错误返回方式（返回码还是异常）。
- AI 在生成 C#/Rust/C++ 封装时，会根据语言习惯自行选择接口风格，不利于与壳层（Electron/WebView2）统一。

**建议补充接口约定（示意）**

```md
原生模块接口建议（示例）：

- `Result<string, Error> read_session_file()`
  - 读取 `C:\\ProgramData\\Passport\\session.dat`，完成解密与完整性校验（见 BR-06），返回 JSON 字符串；
  - 若文件不存在，返回特定错误代码 `ERR_SESSION_NOT_FOUND`；
  - 若文件损坏或校验失败，返回 `ERR_SESSION_CORRUPTED`。
- `Result<void, Error> write_session_file(string session_json)`
  - 接收未经加密的 JSON 字符串，使用 DPAPI 加密后写入 session.dat；
  - 写入失败或加密失败时返回具体错误代码，不进行部分写入。
- `Result<void, Error> delete_session_file()`
  - 删除 session.dat 文件（若存在），不存在时视为成功（幂等）。
```

并在 BR-06 中说明：

- 原生模块只负责上述读/写/删与校验，不主动调用任何网络接口；
- 壳层基于错误码决定是否提示用户或重建会话。

---

### 2.2 完整性校验错误的处理模式（BR-06）

**问题描述**

- 当前 BR-06 只定义了“需验证内容完整性”和“视为文件损坏需删除”，但未明确：
  - 删除文件是由原生模块执行，还是由壳层根据错误码删除；
  - 对上层调用者的反馈是“返回空会话”还是“返回错误”。
- AI 在生成原生模块时，可能在内部直接 `DeleteFile` 并返回空 JSON，使得壳层无法区分“本来就不存在”和“存在但损坏”。

**建议补充（示意）**

在 BR-06 末尾增加：

```md
- 原生模块在发现完整性校验失败时：
  - 不直接删除 session.dat 文件；
  - 返回错误码 `ERR_SESSION_CORRUPTED`；
- 壳层在收到该错误码后，负责：
  - 删除 session.dat 文件；
  - 向前端发出 `session.status = "none"` 的通知，引导用户重新登录。
```

---

### 2.3 文件系统异常与容错（2.3 前置假设, BR-06, 16.2 风险）

**问题描述**

- PRD 假设可以在 ProgramData 写入，但未说明：
  - 若运行账户没有写权限，原生模块应如何反馈；
  - 磁盘满/只读时写入失败的行为；
  - DPAPI 调用失败（如用户配置异常）时的降级策略。
- AI 容易忽略这些错误分支，导致实际运行时静默失败。

**建议补充（示意）**

在 16.2 “风险概览”中新增一条：

```md
RISK-03：本地文件/DPAPI 失败风险

- 场景：
  - 当前 Windows 用户对 `C:\\ProgramData\\Passport` 没有写权限；
  - 磁盘已满或只读；
  - DPAPI 调用失败（系统配置异常等）。
- 原则：
  - 此类异常视为“无法建立本地 SSO 能力”，但不应影响在线登录本身；
  - 原生模块需返回明确错误码，壳层需记录日志并降级为“仅支持本次登录，不写入本地会话文件”。
```

---

### 2.4 性能与异步模型（10.1 性能）

**问题描述**

- 性能目标中只提到 SSO 整体验证 P95 ≤ T ms，没有给到原生模块的时间预算；
  - AI 可能生成完全同步 IO 与 JSON 解析逻辑，导致在低性能机器上阻塞 UI。

**建议补充（示意）**

在 10.1 中增加一条建议（不改变业务要求，只提供工程指导）：

```md
原生模块性能建议：

- 本地会话文件的读取 + 解密 + JSON 解析整体 P95 耗时建议不超过 T 的 50%；
- 原生模块接口可采用异步模型（如 async/await 或回调），避免在 UI 线程同步阻塞；
- 对于频繁访问的数据（如 guid、device_id），可在内存中做一次性缓存，减少重复读写磁盘。
```

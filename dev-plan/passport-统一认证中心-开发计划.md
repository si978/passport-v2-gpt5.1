# Passport 统一认证中心 - 开发计划（Dev Plan v1.1）

> 基线需求：`passport-统一认证中心-PRD-草稿.md`（Passport 统一认证中心 - PRD（V1 多视图对齐版），v1.1，SSoT）  
> 本文档仅负责从 PRD → 构建开发计划（Epic / Story / Task + Cycle 别名），不包含任何具体代码实现。

---

## 🟣 一、开发结构总览

### 1. 模块（Module）列表与 MOD 代码

| Epic / Module 名称                             | MOD 代码  | 简述 |
|-----------------------------------------------|----------|------|
| 身份认证与登录注册模块                        | AUTH-01  | 手机号登录/注册、GUID 生成、Token 发放/刷新/验证 |
| 跨客户端 SSO 与本地会话模块                   | SSO-02   | LocalSession 文件、安全规则、跨客户端自动登录、网吧场景 |
| 会话管理与退出/封禁联动模块                   | SESS-03  | Redis 会话 TTL、退出登录、会话销毁、封禁与会话联动 |
| 后台管理与用户活跃分析模块                    | ADMIN-04 | 用户信息表、用户活跃表、封禁/解封后台操作 |

> 说明：ADMIN-04 在 PRD 中有 US（US-05），但未给出独立 FL，后文一致性检查会标出。

### 2. Module → US → FL 映射

#### AUTH-01 模块（身份认证与登录注册）

- **US-01**：手机号登录/注册（PRD 4.1 US-01）
  - 关联 FL：
    - **FL-01**：手机号登录/注册流程（PRD 6.1 FL-01）
    - **FL-02**：Token 刷新流程（PRD 6.1 FL-02）
    - **FL-03**：Token 验证流程（PRD 6.1 FL-03）

#### SSO-02 模块（跨客户端 SSO 与本地会话）

- **US-02**：跨客户端自动登录（SSO）（PRD 4.1 US-02）
  - 关联 FL：
    - **FL-04**：跨客户端 SSO 流程（PRD 6.1 FL-04）
    - 依赖 FL-02 刷新流程作为子流程
- **US-03**：网吧下机后自动登出（PRD 4.1 US-03）
  - 主要依赖：
    - FL-04 + BR-06 本地会话文件规则 + AC-04 网吧下机验收

#### SESS-03 模块（会话管理与退出/封禁联动）

- **US-04**：用户主动退出登录（全局退出）（PRD 4.1 US-04）
  - 关联 FL：
    - **FL-05**：会话销毁（退出登录）流程（PRD 6.1 FL-05）
    - 同时与 BR-07（会话 TTL 与全局退出）、BR-08（封禁/解封）强相关

#### ADMIN-04 模块（后台管理与用户活跃分析）

- **US-05**：后台查看用户信息与活跃明细（PRD 4.1 US-05）
  - 关联内容：
    - 数据模型：DM-01 User、DM-04 LoginLog（PRD 8.2 / 8.5）
    - UI：7.2 管理后台界面
  - 当前 PRD 未定义独立 FL-0X，后文一致性检查会说明。

---

## 🔵 二、Epic（模块级拆分）

### Epic 1：AUTH-01 身份认证与登录注册模块

- **目标**：实现统一的手机号登录/注册能力，生成全局唯一 GUID，并提供 Access/Refresh Token 生命周期管理、刷新与验证能力，为所有接入客户端提供统一认证基础。
- **边界**：
  - 只支持手机号 + 验证码登录/注册（不含用户名密码/三方登录）；
  - 涉及的 Token 行为限于 Passport 本身（签发 / 刷新 / 验证），业务系统使用 Token 调用自身接口在本 Epic 之外。

### Epic 2：SSO-02 跨客户端 SSO 与本地会话模块

- **目标**：在同一 Windows 用户下，为九尾狐 / 游利社等客户端提供基于本地加密会话文件的自动登录能力，并在网吧等公共环境下避免串号。
- **边界**：
  - 只处理单机内 SSO，不考虑跨机器 SSO；
  - 依赖 AUTH 模块提供的 Refresh Token 与会话结构，不负责 Token 语义本身。

### Epic 3：SESS-03 会话管理与退出/封禁联动模块

- **目标**：统一管理 Redis 会话生命周期、退出登录行为与封禁联动，保证“退出 = 全局退出”、“封禁 = 立即失效”，并通过客户端清理本地会话信息。
- **边界**：
  - 不负责 Redis 高可用架构选型（由架构文档负责）；
  - 不处理迁移策略（PRD 第 14 章为占位，由迁移方案文档负责）。

### Epic 4：ADMIN-04 后台管理与用户活跃分析模块

- **目标**：为运营 / 客服 / 技术支持提供按手机号、来源、渠道查询用户与登录活跃记录的能力，支持封禁/解封操作。
- **边界**：
  - 不定义后台登录/权限管理实现细节（依赖公司统一权限系统）；
  - 不定义复杂报表/BI，只覆盖基础查询与导出。

---

## 🟢 三、Story（用户故事级）

> 每个 US = 一个 Story，标题中包含 [MOD-XX][US-XX]。

### Story 1：[AUTH-01][US-01] 手机号登录/注册统一认证

- **用户价值**：用户无需区分“注册”与“登录”，只需手机号 + 验证码一次操作即可完成账号创建或登录，并获得统一 GUID 和 Token。
- **关联 BR/FL**：
  - BR-01 GUID 生成与唯一性
  - BR-02 手机号登录/注册判定规则
  - BR-03 Token 类型与有效期
  - FL-01 手机号登录/注册流程
  - FL-02 Token 刷新流程
  - FL-03 Token 验证流程
- **AC（验收标准）**：
  1. 已存在手机号且 `User.status=1` 时，输入正确验证码必定走“登录”路径，不创建新用户；新/旧 GUID 一致。
  2. 不存在的手机号登录时，会自动创建新 User、生成唯一 GUID，并在用户表中可见；GUID 符合 20 位规则且不重复。
  3. 登录成功后，客户端可获得 Access Token（4 小时）与 Refresh Token（2 天），后端能根据 Token 验证并识别 GUID 与 app_id，一致性符合 BR-03/04/05。

### Story 2：[SSO-02][US-02] 同机跨客户端自动登录（SSO）

- **用户价值**：用户在同一台机器、同一 Windows 用户下只需登录一次，便可在九尾狐 / 游利社之间无感切换，无需重复输入验证码。
- **关联 BR/FL**：
  - BR-03 Token 类型与有效期
  - BR-06 本地会话文件读写与过期规则
  - FL-02 Token 刷新流程（作为子流程）
  - FL-04 跨客户端 SSO 流程
- **AC**：
  1. 用户在九尾狐登录成功后 2 天内首次打开游利社时，在有合法 LocalSession 的前提下应直接进入登录态，无需输入验证码。
  2. LocalSession 不存在、损坏或 `created_at` 超过 2 小时时，游利社应直接展示登录页，不出现悬空半登录状态。
  3. 自动登录过程中，Refresh Token 刷新失败（过期/不匹配）时，客户端需清理本地会话并回到登录页，不允许继续尝试使用失效会话。

### Story 3：[SSO-02][US-03] 网吧下机后的安全退出

- **用户价值**：在网吧等公共环境中，用户下机后下一个用户无法直接进入前一个用户的账号，防止串号风险。
- **关联 BR/FL**：
  - BR-06 本地会话文件读写与过期规则
  - BR-07 会话 TTL 与全局退出规则
  - AC-02 / AC-04 网吧下机与串号相关验收标准
- **AC**：
  1. 在网吧场景下，当前用户 Windows 注销后，再次打开任一客户端时不得出现直接进入前一用户账号的情况。
  2. 当 Windows 未正常清理临时目录导致 `session.dat` 残留时，客户端启动应基于创建时间 >2 小时强制删除该文件。
  3. QA 提供的网吧场景用例（多用户轮换 / 非正常关机 / 多客户端组合）全部通过，未发现账号串用。

### Story 4：[SESS-03][US-04] 用户主动退出登录 = 全局退出

- **用户价值**：用户在任一客户端点击“退出登录”后，所有关联会话（Redis、本地文件、内存 Token）都被统一清理，避免残留会话带来的风险。
- **关联 BR/FL**：
  - BR-07 会话 TTL 与全局退出规则
  - BR-08 管理后台封禁/解封规则（封禁 = 强制退出）
  - FL-05 会话销毁（退出登录）流程
- **AC**：
  1. 用户在任一客户端点击“退出登录”后，对应 GUID 的 Redis 会话 `session:{guid}` 被删除，再次调用业务接口返回未登录/Token 失效。
  2. 退出操作完成后，本地 `session.dat` 文件与内存中的 Token 均被清理，重新打开客户端仅展示登录页。
  3. 当封禁与退出并发发生时，无论顺序如何，最终 Redis 中不存在该 GUID 的会话，客户端处于未登录状态。

### Story 5：[ADMIN-04][US-05] 后台用户与活跃明细查询

- **用户价值**：运营 / 客服 / 技术支持可以按手机号、账户来源、渠道等维度查看用户基本信息与登录活跃记录，并执行封禁/解封操作，以支持运营与风控。
- **关联 BR/FL/DM**：
  - BR-08 管理后台封禁/解封规则
  - DM-01 User（用户信息表）
  - DM-04 LoginLog（登录/活跃记录）
  - UI 7.2 管理后台界面（未定义独立 FL）
- **AC**：
  1. 在用户信息表中，运营可按手机号模糊搜索、按账户来源筛选，并对选中用户执行封禁/解封操作，行为符合 BR-08。
  2. 在用户活跃表中，可按登录时间、登录渠道筛选，并导出满足条件的记录，导出数量与筛选条件一致。
  3. 被封禁用户在前端登录时会收到 `ERR_USER_BANNED`，且后台能看到封禁时间与执行人信息。

> 注：US-05 目前在 PRD 中未定义单独 FL，后文一致性检查会建议补充“后台查询/导出流程”型 FL。

---

## 🟡 四、Task（功能点按角色拆分）

### 0. Cycle 别名总表

```text
Cycle1  = [AUTH-01][US-01][FL-01][FE]
Cycle2  = [AUTH-01][US-01][FL-01][BE]
Cycle3  = [AUTH-01][US-01][FL-01][QA]

Cycle4  = [AUTH-01][US-01][FL-02][FE]
Cycle5  = [AUTH-01][US-01][FL-02][SH]
Cycle6  = [AUTH-01][US-01][FL-02][BE]
Cycle7  = [AUTH-01][US-01][FL-02][QA]

Cycle8  = [AUTH-01][US-01][FL-03][FE]
Cycle9  = [AUTH-01][US-01][FL-03][BE]
Cycle10 = [AUTH-01][US-01][FL-03][QA]

Cycle11 = [SSO-02][US-02][FL-04][FE]
Cycle12 = [SSO-02][US-02][FL-04][SH]
Cycle13 = [SSO-02][US-02][FL-04][NM]
Cycle14 = [SSO-02][US-02][FL-04][BE]
Cycle15 = [SSO-02][US-02][FL-04][QA]

Cycle16 = [SESS-03][US-04][FL-05][FE]
Cycle17 = [SESS-03][US-04][FL-05][SH]
Cycle18 = [SESS-03][US-04][FL-05][NM]
Cycle19 = [SESS-03][US-04][FL-05][BE]
Cycle20 = [SESS-03][US-04][FL-05][QA]
```

> 后续只要说“实现 CycleX”，即可唯一映射到对应 Task。

---

### FL-01：手机号登录/注册流程（AUTH-01 / US-01）

#### Cycle1 — [AUTH-01][US-01][FL-01][FE] 实现手机号登录/注册前端表单与交互

- **描述**：实现手机号登录/注册页面（手机号输入、验证码获取与倒计时、验证码输入、协议勾选、登录按钮），按 BR-02/BR-09/FL-01 处理前端校验与错误提示。
- **输入/输出**：
  - 输入：用户手机号、验证码、协议勾选状态。
  - 输出：调用 API-01/02 的 HTTP 请求；登录成功后在前端全局状态中保存 `guid`、`access_token`、`refresh_token`、`user_status` 等。
- **依赖任务**：Cycle2（后端登录接口）；Cycle3（QA 用例）。
- **完成标准（DoD）**：
  - 所有前端校验规则符合 BR-09，错误文案可配置；
  - 成功/失败路径均已在 UI 中可见，并触发正确的全局状态变更；
  - 基本单元测试 / 交互用例通过，可与后端联调。

#### Cycle2 — [AUTH-01][US-01][FL-01][BE] 实现手机号登录/注册后端接口与用户创建

- **描述**：实现 API-02 `/api/passport/login-by-phone` 后端逻辑：根据 BR-02 处理“已有用户 / 新用户 / 封禁 / 注销”四种情况，并按 BR-01 生成 GUID、写会话数据。
- **输入/输出**：
  - 输入：`phone`, `code`, `app_id`。
  - 输出：成功时返回 `guid`, `access_token`, `refresh_token`, `user_status`, `account_source`；失败时返回对应错误码（ERR_CODE_INVALID / EXPIRED / ERR_USER_BANNED 等）。
- **依赖任务**：无硬前置，可并行；为 Cycle1/3 的上游。
- **DoD**：
  - 用户表 / 会话数据写入逻辑符合 DM-01/DM-02；
  - 所有错误分支使用 PRD 第 13 章定义的错误码；
  - 单元测试覆盖正常/封禁/注销/验证码错误等关键分支。

#### Cycle3 — [AUTH-01][US-01][FL-01][QA] 编写手机号登录/注册端到端测试用例

- **描述**：基于 FL-01 和 BR-02/BR-09 设计并实现 E2E 测试：已有用户登录、新用户注册、封禁用户登录、验证码错误/过期、频率限制等。
- **输入/输出**：
  - 输入：测试数据（手机号集、验证码场景、User.status 不同值）。
  - 输出：自动化测试脚本或测试用例文档 + 执行报告。
- **依赖任务**：Cycle1、Cycle2。
- **DoD**：
  - 覆盖 AC-01 相关场景，所有断言基于 PRD 约定的返回字段和错误码；
  - 测试可在 CI 中自动运行，并稳定通过。

---

### FL-02：Token 刷新流程（AUTH-01 / US-01，壳层参与）

#### Cycle4 — [AUTH-01][US-01][FL-02][FE] 实现前端会话状态管理与刷新结果处理

- **描述**：在前端全局状态中管理当前会话有效性，根据壳层 IPC 通知和刷新结果更新 UI（如续期提示、自动回到登录页），不自行调度刷新定时器。
- **输入/输出**：
  - 输入：壳层 IPC 消息（如 `session.refresh.success` / `session.refresh.failed`）、HTTP 错误码。
  - 输出：前端状态更新（登录态/过期态）、页面跳转。
- **依赖任务**：Cycle5（壳层调度）、Cycle6（刷新接口）。
- **DoD**：
  - 前端不持有定时器，只响应壳层事件；
  - 刷新失败（ERR_REFRESH_EXPIRED/MISMATCH）时，前端能正确清理状态并跳转登录页；
  - 与 QA 用例（Cycle7）联调通过。

#### Cycle5 — [AUTH-01][US-01][FL-02][SH] 实现壳层统一 Token 刷新调度与 IPC 通知

- **描述**：在壳层实现 Token 刷新调度逻辑：从登录/上次刷新成功时起，每 3 小时+抖动调用 API-03，处理失败重试（5 分钟内至多 2 次），通过 IPC 将结果通知前端。
- **输入/输出**：
  - 输入：登录成功事件（来自前端）、当前时间、本地存储的 Refresh Token。
  - 输出：调用 `/api/passport/refresh-token` 请求；IPC 通知前端刷新成功/失败。
- **依赖任务**：Cycle6（后端刷新接口）。
- **DoD**：
  - 调度策略符合 FL-02 描述（间隔、抖动、重试次数）；
  - 刷新成功时本地 Token 状态更新一致；刷新失败时发送明确 IPC 事件；
  - 壳层日志记录关键路径错误，便于 QA & 运维排查。

#### Cycle6 — [AUTH-01][US-01][FL-02][BE] 实现 Refresh Token 刷新接口及会话更新逻辑

- **描述**：实现 API-03 `/api/passport/refresh-token`，根据 BR-04 校验 Refresh Token 与 Redis 会话，生成新 Access Token，并更新 `apps.{app_id}` 子结构。
- **输入/输出**：
  - 输入：`refresh_token`, `app_id`。
  - 输出：成功时返回新的 `access_token` 与 `expires_in`；失败时返回 ERR_REFRESH_EXPIRED / MISMATCH / ERR_APP_ID_MISMATCH 等。
- **依赖任务**：Cycle2 中生成会话结构（Session DM-02）。
- **DoD**：
  - Redis 更新幂等且线程安全（并发刷新不会产生脏数据）；
  - 错误码与 HTTP 状态符合 PRD 第 13.2 章节；
  - 单元测试涵盖正常刷新、过期、不匹配、app_id 不匹配等情况。

#### Cycle7 — [AUTH-01][US-01][FL-02][QA] 编写 Token 刷新流程测试用例

- **描述**：基于 FL-02 为 FE/SH/BE 刷新联合作整体测试用例，验证调度、错误处理与重试行为。
- **输入/输出**：
  - 输入：不同剩余有效期的 Refresh Token、网络错误/Redis 故障模拟。
  - 输出：自动化测试脚本 + 测试报告。
- **依赖任务**：Cycle4、Cycle5、Cycle6。
- **DoD**：
  - 覆盖正常刷新、过期、伪造、Redis 故障时统一失败（C-02）等场景；
  - 日志与监控中能够看见刷新失败/成功的统计。

---

### FL-03：Token 验证流程（AUTH-01 / US-01）

#### Cycle8 — [AUTH-01][US-01][FL-03][FE] 实现前端 Access Token 错误处理与自动跳转逻辑

- **描述**：在前端通用请求层处理 401/403 与特定错误码（ERR_ACCESS_EXPIRED / INVALID / ERR_APP_ID_MISMATCH），实现自动跳转登录页或展示无权限提示。
- **输入/输出**：
  - 输入：后端接口返回的 HTTP 状态与错误码。
  - 输出：前端路由跳转、用户提示、全局状态更新。
- **依赖任务**：Cycle9。
- **DoD**：
  - 不同错误码导致的前端行为与 PRD 错误码语义一致；
  - 不出现“假登录态”（Token 已过期但前端仍显示已登录）。

#### Cycle9 — [AUTH-01][US-01][FL-03][BE] 实现 Token 验证接口与通用鉴权中间件

- **描述**：实现 API-04 `/api/passport/verify-token` 以及服务端通用鉴权中间件，根据 BR-05/ERR 规则校验 Access Token。
- **输入/输出**：
  - 输入：`access_token`, `app_id` 或相关 Header。
  - 输出：校验通过时返回 `guid` / `expires_at` 等；失败时返回相应错误码与 HTTP 状态。
- **依赖任务**：Cycle2、Cycle6（生成的 Token 与会话结构）。
- **DoD**：
  - 中间件可被业务服务统一复用，行为与 API-04 一致；
  - 日志记录 Token 解析失败、过期、app_id 不匹配等关键信息。

#### Cycle10 — [AUTH-01][US-01][FL-03][QA] 编写 Token 验证与鉴权相关测试用例

- **描述**：为 Token 验证接口与鉴权中间件设计测试：有效 Token、过期 Token、伪造 Token、app_id 不匹配等。
- **输入/输出**：
  - 输入：不同状态的 Access Token 样本；
  - 输出：测试脚本/用例 + 报告。
- **依赖任务**：Cycle8、Cycle9。
- **DoD**：
  - 覆盖所有主要错误码分支；
  - 与登录/刷新用例联通，保证端到端调用链正确。

---

### FL-04：跨客户端 SSO 流程（SSO-02 / US-02，壳层 + 原生）

#### Cycle11 — [SSO-02][US-02][FL-04][FE] 实现前端 SSO 自动登录触发与 UI 状态切换

- **描述**：在前端实现基于壳层 IPC `session.status`（如 `sso_available` / `none`）的自动登录流程：有 SSO 可用时调用刷新接口，无则展示登录页。
- **输入/输出**：
  - 输入：壳层 IPC 会话状态、刷新结果。
  - 输出：登录态 UI / 登录页 UI、错误提示。
- **依赖任务**：Cycle12（壳层）、Cycle14（刷新/验证接口）。
- **DoD**：
  - 在 `sso_available` 且刷新成功时，前端无感切换至登录态；
  - 刷新失败或会话损坏时，回退到登录页并清理 UI。

#### Cycle12 — [SSO-02][US-02][FL-04][SH] 实现壳层启动时 LocalSession 检查与 SSO IPC 通知

- **描述**：壳层在进程启动且首次创建主窗口时，调用原生模块读取/解密 `session.dat`，按 BR-06 与 2 小时阈值决定是否视为可用 SSO，并通过 IPC 通知前端。
- **输入/输出**：
  - 输入：应用启动事件、原生模块提供的 LocalSession 或错误码。
  - 输出：IPC 事件：`session.status = "sso_available" | "none"`。
- **依赖任务**：Cycle13。
- **DoD**：
  - 启动时只进行一次文件检查（单实例策略），避免重复 IO；
  - 对 `ERR_SESSION_NOT_FOUND` / `ERR_SESSION_CORRUPTED` 的处理与 PRD 13.3/FL-04 一致；
  - 日志记录关键路径错误。

#### Cycle13 — [SSO-02][US-02][FL-04][NM] 封装原生 LocalSession 文件读写与完整性校验

- **描述**：在原生模块中实现 `read_session_file` / `write_session_file` / `delete_session_file`，使用 DPAPI 加密并按 BR-06 完整性校验。
- **输入/输出**：
  - 输入：文件系统、DPAPI API 调用。
  - 输出：LocalSession 对象或错误码（`ERR_SESSION_NOT_FOUND` / `ERR_SESSION_CORRUPTED`）。
- **依赖任务**：无硬前置，为 Cycle12/17/18 的基础。
- **DoD**：
  - 文件结构、加密、权限符合 BR-06；
  - 错误码行为与 PRD 13.3 一致；
  - 单元测试覆盖文件不存在、损坏、权限异常等情况。

#### Cycle14 — [SSO-02][US-02][FL-04][BE] 支持基于 Refresh Token 的跨客户端 SSO 后端行为

- **描述**：确保在 SSO 场景下使用 LocalSession 中的 Refresh Token 调用 API-03 刷新时，行为与普通刷新一致，同时支持多 app_id 子会话结构。
- **输入/输出**：
  - 输入：来自不同 app 的刷新请求（同一 GUID，不同 `app_id`）。
  - 输出：新的 Access Token，更新 `apps.{app_id}`。
- **依赖任务**：Cycle6。
- **DoD**：
  - 支持同 GUID 在多个 app 上各自维护 Access Token；
  - Redis 会话结构与 PRD DM-02 一致；
  - 对 Refresh Token 不匹配等异常返回的错误码可被前端/壳层正确处理。

#### Cycle15 — [SSO-02][US-02][FL-04][QA] 编写跨客户端 SSO 与网吧串号防护测试用例

- **描述**：针对网吧 / 共享设备场景设计测试：A 先登录九尾狐，B 后打开游利社；正常 SSO、LocalSession 损坏、过期、残留等。
- **输入/输出**：
  - 输入：不同 LocalSession 状态、不同 Windows 用户 / 机器环境。
  - 输出：测试用例/脚本 + 报告。
- **依赖任务**：Cycle11～Cycle14。
- **DoD**：
  - 覆盖 AC-02（串号定义）与 AC-04（网吧下机）所有关键场景；
  - 任一场景中不出现“B 直接进 A 账号”的情况。

---

### FL-05：会话销毁（退出登录）流程（SESS-03 / US-04，壳层 + 原生）

#### Cycle16 — [SESS-03][US-04][FL-05][FE] 实现退出登录前端交互与全局状态清理

- **描述**：在前端实现统一的“退出登录”入口（≤2 次点击可达），调用壳层/后端退出逻辑，并在成功后清理本地 UI 状态。
- **输入/输出**：
  - 输入：用户点击退出按钮、壳层/后端退出结果。
  - 输出：路由跳转到登录页、前端状态清理。
- **依赖任务**：Cycle17、Cycle19。
- **DoD**：
  - 所有已登录页面都在 2 次点击内可达退出入口；
  - 退出后 UI 不再显示用户信息，任何刷新后仍是登录页。

#### Cycle17 — [SESS-03][US-04][FL-05][SH] 实现壳层退出登录广播与本地会话清理

- **描述**：在壳层实现退出登录处理：调用后端退出接口，删除本地 `session.dat`，清空内存 Token，通过 IPC 通知所有前端窗口。
- **输入/输出**：
  - 输入：前端退出请求、后端退出 API 响应。
  - 输出：删除本地文件、清空内存 Token、IPC 广播 `session.status = "logged_out" | "banned"`。
- **依赖任务**：Cycle18、Cycle19。
- **DoD**：
  - 多窗口情况下，所有窗口都能同步收到退出事件；
  - 本地会话文件删除失败时有日志与错误上报，且前端不会误认为仍登录。

#### Cycle18 — [SESS-03][US-04][FL-05][NM] 实现原生模块会话删除与错误处理接口

- **描述**：在原生模块中实现安全删除 `session.dat` 的接口，并在权限不足、文件不存在时返回明确错误码。
- **输入/输出**：
  - 输入：文件路径、删除请求。
  - 输出：成功/失败结果，错误码。
- **依赖任务**：Cycle13（读写能力）可复用。
- **DoD**：
  - 删除行为幂等（文件不存在视为成功）；
  - 所有异常情况有明确错误码与日志。

#### Cycle19 — [SESS-03][US-04][FL-05][BE] 实现会话销毁与封禁联动的后端接口

- **描述**：实现 API-05 `/api/passport/logout` 以及封禁操作中的 Redis 会话删除逻辑，根据 BR-07/BR-08 确保“退出 = 全局退出”、“封禁 = 立即失效”。
- **输入/输出**：
  - 输入：带有效 Access Token 的退出请求，或后台封禁操作。
  - 输出：HTTP 200（幂等成功），错误时返回相应错误码。
- **依赖任务**：Cycle2、Cycle6（会话结构）。
- **DoD**：
  - 多次调用退出接口结果一致（幂等）；
  - 封禁操作执行后，不再存在对应 `session:{guid}` 记录。

#### Cycle20 — [SESS-03][US-04][FL-05][QA] 编写退出登录与封禁全局效果测试用例

- **描述**：设计覆盖退出登录、封禁、退出+封禁并发等场景的测试，验证会话在 Redis、本地文件、前端 UI 三端的一致性。
- **输入/输出**：
  - 输入：不同顺序的退出/封禁操作、多客户端并发。
  - 输出：测试脚本/用例 + 报告。
- **依赖任务**：Cycle16～Cycle19。
- **DoD**：
  - 测试结果证明无论操作顺序如何，最终状态均为“无会话 & 未登录界面”；
  - 所有关键场景在 CI 或手工测试中可重复验证。

---

## 🟤 五、任务树结构（可视化）

```text
Epic AUTH-01 身份认证与登录注册模块
  └─ Story [AUTH-01][US-01] 手机号登录/注册统一认证
       ├─ Cycle1  : [AUTH-01][US-01][FL-01][FE]
       ├─ Cycle2  : [AUTH-01][US-01][FL-01][BE]
       ├─ Cycle3  : [AUTH-01][US-01][FL-01][QA]
       ├─ Cycle4  : [AUTH-01][US-01][FL-02][FE]
       ├─ Cycle5  : [AUTH-01][US-01][FL-02][SH]
       ├─ Cycle6  : [AUTH-01][US-01][FL-02][BE]
       ├─ Cycle7  : [AUTH-01][US-01][FL-02][QA]
       ├─ Cycle8  : [AUTH-01][US-01][FL-03][FE]
       ├─ Cycle9  : [AUTH-01][US-01][FL-03][BE]
       └─ Cycle10 : [AUTH-01][US-01][FL-03][QA]

Epic SSO-02 跨客户端 SSO 与本地会话模块
  ├─ Story [SSO-02][US-02] 同机跨客户端自动登录（SSO）
  │    ├─ Cycle11 : [SSO-02][US-02][FL-04][FE]
  │    ├─ Cycle12 : [SSO-02][US-02][FL-04][SH]
  │    ├─ Cycle13 : [SSO-02][US-02][FL-04][NM]
  │    ├─ Cycle14 : [SSO-02][US-02][FL-04][BE]
  │    └─ Cycle15 : [SSO-02][US-02][FL-04][QA]
  └─ Story [SSO-02][US-03] 网吧下机后的安全退出
       └─ （复用 FL-04/FL-05 的实现与测试，不新增独立 FL；在 Story 层约束验收场景）

Epic SESS-03 会话管理与退出/封禁联动模块
  └─ Story [SESS-03][US-04] 用户主动退出登录 = 全局退出
       ├─ Cycle16 : [SESS-03][US-04][FL-05][FE]
       ├─ Cycle17 : [SESS-03][US-04][FL-05][SH]
       ├─ Cycle18 : [SESS-03][US-04][FL-05][NM]
       ├─ Cycle19 : [SESS-03][US-04][FL-05][BE]
       └─ Cycle20 : [SESS-03][US-04][FL-05][QA]

Epic ADMIN-04 后台管理与用户活跃分析模块
  └─ Story [ADMIN-04][US-05] 后台用户与活跃明细查询
       └─ （当前 PRD 未给出独立 FL，暂不拆 Task；在一致性检查中给出建议）
```

---

## 🔴 六、一致性检查

### 1. 是否有 US 未转成 Story

- US-01～US-05 均已转为 Story。  
- 特殊情况：
  - US-03 通过 AC-04 与 BR-06/FL-04 组合表达，无独立 FL；
  - US-05 通过 DM-01/DM-04 和 UI 7.2 表达，无独立 FL。

**建议修复**：后续在 PRD 小版本中补充：

- FL-06：后台用户信息查询/封禁流程（挂在 US-05）；
- FL-07：后台用户活跃查询/导出流程；

然后为 ADMIN-04 创建对应 FE/BE/QA 任务。

### 2. 是否有 FL 未转成 Task

- PRD 中定义的 FL-01～FL-05 均已拆分为 FE/BE/QA Task；
- 涉及壳层/原生模块的 FL-02/04/05 也拆分了 SH/NM 任务。

**结论**：无遗漏 FL。

### 3. 是否有角色任务缺失

- 每个 FL 至少有 FE/BE/QA 三类 Task；
- 涉及壳层/原生模块的 FL-02/04/05 有 SH/NM 任务；

**结论**：无强制角色缺失。

### 4. 是否有重复命名（MOD/US/FL/ROLE / Cycle）

- MOD：AUTH-01 / SSO-02 / SESS-03 / ADMIN-04 —— 全局唯一；
- US：US-01～US-05 复用 PRD 编号，无重复；
- FL：FL-01～FL-05 复用 PRD 编号，无重复；
- Cycle：Cycle1～Cycle20 严格单调无重复。

**结论**：命名一致、无冲突。

### 5. 是否有前端需要后端但后端未提供

- FL-01：FE（Cycle1）依赖 BE 登录接口（Cycle2） —— 已有；
- FL-02：FE/SH（Cycle4/5）依赖 BE 刷新接口（Cycle6） —— 已有；
- FL-03：FE（Cycle8）依赖 BE 验证/鉴权（Cycle9） —— 已有；
- FL-04：FE（Cycle11）依赖 BE 刷新行为（Cycle14） —— 已有；
- FL-05：FE/SH（Cycle16/17）依赖 BE 会话销毁/封禁行为（Cycle19） —— 已有。

**结论**：所有前端/壳层 Task 都有对应后端实现 Task 支撑，无“悬空前端”。

### 6. 是否有壳层/原生模块能力未补齐

- 壳层（SH）：
  - 刷新调度（Cycle5）、SSO 启动检查（Cycle12）、退出广播与本地清理（Cycle17）三大职责已覆盖。
- 原生模块（NM）：
  - LocalSession 读写/校验（Cycle13）、删除接口（Cycle18）覆盖 BR-06 与 ERR 13.3 要求。

**潜在补充点**：

- PRD 中 RISK-03（本地文件/DPAPI 失败）提示壳层需将本地异常降级为“仅本次在线登录”，目前在 Task 描述中已提及日志与错误处理，但可在设计阶段扩展：
  - 在 Cycle12/Cycle17/Cycle18 的实现细节中，明确如何将 DPAPI 失败映射为“禁用本地 SSO，不影响在线登录”的行为。

### 7. Cycle 是否唯一且可映射

- Cycle1～Cycle20 显式列出映射关系，每个 Cycle 只对应一个 Task ID，无复用。

**结论**：Cycle 体系满足“一一映射”的要求。

### 8. 任务结构是否完整（整体视角）

- 从“登录/注册 → 刷新 → 验证 → SSO → 退出/封禁”的主链路上，FE/SH/NM/BE/QA 均有对应 Task，覆盖了 PRD 的主要 US/FL/BR/ERR。
- 存在的结构性待补点主要集中在：
  1. **ADMIN-04 模块**：
     - 有 Story（US-05），但缺少明确 FL，当前未拆分 FE/BE/QA 任务；
     - 建议后续在 PRD 中补充后台流程型 FL（如“后台用户查询流程”、“后台活跃查询/导出流程”），再按本模式扩展 Task。
  2. **日志与监控实现细节**：
     - NFR 10.2、12.2 中的监控指标目前主要依托 BE/QA Task 在测试与实现中体现；
     - 若后续需要专门的“监控接入”工作，可新增一个 OBS 模块（如 OBS-05），在 BE/OPS 侧拆出独立 Task。

**总体结论（更新前）**：

- 针对核心登录 / 会话 / SSO / 退出能力，任务结构完整且与 PRD 一致；
- 后台模块与监控模块暂作为“下一步 PRD 补充”方向，不阻塞当前 Passport V1 开发路径。

---

## 🟣 七、补充 Task 与 Cycle（覆盖验证码 / 后台 / 日志监控等缺口）

> 说明：本节在不改变已存在 Cycle1～Cycle20 的前提下，补充对 BR-09、API-01、US-05（后台）、DM-04、NFR（性能/监控/日志）等内容的开发任务，新增 Cycle21～Cycle29。后续 Cycle 号仍然全局唯一，对应各自 Task ID。

### 7.1 新增 Cycle 别名（扩展）

```text
Cycle21 = [AUTH-01][US-01][FL-06][FE]
Cycle22 = [AUTH-01][US-01][FL-06][BE]
Cycle23 = [AUTH-01][US-01][FL-06][QA]

Cycle24 = [ADMIN-04][US-05][FL-06][FE]
Cycle25 = [ADMIN-04][US-05][FL-06][BE]
Cycle26 = [ADMIN-04][US-05][FL-06][QA]

Cycle27 = [ADMIN-04][US-05][FL-07][FE]
Cycle28 = [ADMIN-04][US-05][FL-07][BE]
Cycle29 = [ADMIN-04][US-05][FL-07][QA]
```

> 说明：
> - 这里的 FL-06/FL-07 为**计划内的流程编号**，用于开发管理，与 PRD 中现有 FL-01～FL-05 不冲突；后续如在 PRD 中正式补录后台/验证码流程，可直接沿用这些编号。

---

### 7.2 AUTH-01：补充验证码发送流程（BR-09 / API-01）

> 关联 PRD：BR-09、ERR 13.1（验证码相关错误码）、API-01（发送验证码，语义层）。

#### Cycle21 — [AUTH-01][US-01][FL-06][FE] 实现发送验证码前端交互与校验

- **描述**：在登录页面实现“获取验证码”按钮及倒计时交互，按 BR-09 对手机号/验证码格式进行前置校验，结合错误码映射展示统一错误提示。
- **输入/输出**：
  - 输入：手机号输入、点击“获取验证码”事件；
  - 输出：调用 API-01 的请求（`phone` + 可选场景标识），倒计时 UI、错误提示。
- **依赖任务**：Cycle22（后端 API-01 实现），Cycle23（QA 用例）。
- **DoD**：
  - 手机号格式校验使用 PRD 中定义的正则 `^1[3-9][0-9]{9}$`；
  - 成功发送后按钮进入 60 秒倒计时，倒计时内禁用重复请求；
  - 收到 ERR_CODE_TOO_FREQUENT / ERR_PHONE_INVALID / ERR_INTERNAL 等错误码时，前端展示对应文案。

#### Cycle22 — [AUTH-01][US-01][FL-06][BE] 实现发送验证码 API-01 与频率控制

- **描述**：实现 API-01 `/api/passport/send-code` 后端逻辑：校验手机号合法性、生成 6 位数字验证码、写入缓存并设置 5 分钟有效期，同时根据 BR-09 进行频率限制与错误码返回。
- **输入/输出**：
  - 输入：`phone`（必要）、可选 `scene`（登录/注册）。
  - 输出：成功时返回 200（可选返回 `expire_at` / `request_id`），失败时返回：
    - `ERR_PHONE_INVALID`（手机号格式不合法）；
    - `ERR_CODE_TOO_FREQUENT`（命中频率限制）；
    - 其它内部错误使用 `ERR_INTERNAL`。
- **依赖任务**：短信网关配置与接入（外部依赖，可在设计文档中详细描述）。
- **DoD**：
  - 验证码为 6 位数字，存储时带过期时间（5 分钟），与登录验证逻辑一致；
  - 频率限制策略落地（例如：单手机号/单 IP 在一定窗口内限制请求次数），并使用 ERR_CODE_TOO_FREQUENT；
  - 对短信网关异常（超时/错误）有日志与统一错误码行为。

#### Cycle23 — [AUTH-01][US-01][FL-06][QA] 编写验证码发送与频率限制测试用例

- **描述**：设计验证码发送相关测试：合法/非法手机号、正常发送、频率超限、短信通道失败等。
- **输入/输出**：
  - 输入：多组手机号（合法/非法）、高频请求场景、模拟短信网关错误；
  - 输出：测试用例/脚本 + 报告。
- **依赖任务**：Cycle21、Cycle22。
- **DoD**：
  - 覆盖 ERR_PHONE_INVALID / ERR_CODE_TOO_FREQUENT / ERR_INTERNAL 等主要分支；
  - 验证码写入缓存的过期行为与 5 分钟有效期一致；
  - 频率限制行为符合 BR-09 预期。

---

### 7.3 ADMIN-04：补充后台用户与活跃明细相关流程与任务

> 关联 PRD：US-05、BR-08、DM-01/DM-04、UI 7.2 管理后台界面。

为便于开发管理，这里虚拟两个后台流程编号（建议后续在 PRD 中补录）：

- **FL-06（后台用户信息查询与封禁流程）**
- **FL-07（后台活跃记录查询与导出流程）**

#### Cycle24 — [ADMIN-04][US-05][FL-06][FE] 实现后台用户信息表页面与封禁/解封操作

- **描述**：在后台管理前端实现“用户信息表”页面：按手机号模糊搜索、按账号来源筛选、分页展示，并提供封禁/解封操作入口。
- **输入/输出**：
  - 输入：查询条件（手机号、来源、状态）、分页参数、封禁/解封操作指令；
  - 输出：调用后台用户查询 API 和封禁/解封 API 的请求；UI 上的表格、状态标签和操作按钮。
- **依赖任务**：Cycle25（BE API）、Cycle26（QA）。
- **DoD**：
  - 查询条件/分页行为与 PRD UI 7.2 中字段定义一致；
  - 封禁/解封按钮仅对有权限的角色显示（配合权限控制）；
  - 封禁后 UI 状态实时更新，展示正确的账户状态。

#### Cycle25 — [ADMIN-04][US-05][FL-06][BE] 实现后台用户查询与封禁/解封 API 及权限控制

- **描述**：实现后台用户信息查询 API（支持筛选/分页）与封禁/解封 API，严格按照 BR-08 和 MD-01 字段定义处理 User.status 变更，并结合 11 章角色矩阵控制权限。
- **输入/输出**：
  - 输入：查询请求（手机号、来源、状态、分页参数）、封禁/解封操作请求（用户标识 + 操作类型）；
  - 输出：用户列表结果（含总数、分页数据）、操作结果状态（成功/失败原因）。
- **依赖任务**：用户表结构（DM-01）落地，可与 AUTH-01 模块共用；封禁时需调用/复用退出逻辑（Cycle19）。
- **DoD**：
  - 查询接口支持按手机号模糊、账号来源和状态筛选，并按注册时间/最后登录时间排序；
  - 封禁/解封行为对 User.status 的变更与 BR-08 完全一致，并与会话删除逻辑（Redis）联动；
  - 权限控制：仅运营角色可封禁/解封，客服/技术支持仅可读；越权操作返回 403/ERR_FORBIDDEN 并记录审计日志。

#### Cycle26 — [ADMIN-04][US-05][FL-06][QA] 编写后台用户信息表与封禁/解封测试用例

- **描述**：设计测试用例验证后台用户信息表查询与封禁/解封逻辑含权限控制：不同角色的可见/可操作范围、封禁后登录行为等。
- **输入/输出**：
  - 输入：不同后台角色账号（运营/客服/技术支持）、多个用户样本数据、封禁/解封操作序列；
  - 输出：测试用例/脚本 + 报告（包括越权尝试）。
- **依赖任务**：Cycle24、Cycle25。
- **DoD**：
  - 封禁后前台登录收到 `ERR_USER_BANNED`，且后台可看到对应状态与操作记录；
  - 客服/技术支持用户无法执行封禁/解封，操作返回无权限错误；
  - 查询结果与数据库记录一致，分页与筛选逻辑正确。

#### Cycle27 — [ADMIN-04][US-05][FL-07][FE] 实现后台用户活跃表页面与导出能力

- **描述**：在后台实现“用户活跃表”页面：支持按手机号、时间区间、登录渠道等条件查询，并提供按当前筛选条件导出 CSV 的功能。
- **输入/输出**：
  - 输入：查询条件（手机号、时间区间、渠道等）、导出操作指令；
  - 输出：调用活跃记录查询 API / 导出 API；在前端触发文件下载。
- **依赖任务**：Cycle28（BE API）、Cycle29（QA）。
- **DoD**：
  - 界面字段与 PRD 7.2/DM-04 一致（登录时间、退出时间、登录渠道、IP、MAC、腾讯网关、网吧名称等）；
  - 导出行为符合限制（如最大行数限制、超限时提示用户缩小范围）；
  - 过滤条件对列表显示与导出结果都生效且一致。

#### Cycle28 — [ADMIN-04][US-05][FL-07][BE] 实现登录活跃记录查询与导出 API，并写入 LoginLog

- **描述**：实现基于 DM-04 的登录活跃查询与导出 API，并确保在登录/退出/封禁等关键行为发生时写入 LoginLog 表；同时埋点相关监控指标（登录成功率、错误率、验证码发送失败率等）。
- **输入/输出**：
  - 输入：查询/导出请求（手机号、时间区间、渠道、分页/导出参数）；
  - 输出：分页列表或导出文件链接/流；
  - 行为：在登录成功/失败、刷新失败、退出/封禁时写入 LoginLog 并上报监控指标。
- **依赖任务**：AUTH-01/SSO-02/SESS-03 的核心登录/会话逻辑（Cycle2/6/19等）。
- **DoD**：
  - LoginLog 表结构与 DM-04 一致（字段齐全）；
  - 查询 API 支持多条件筛选与分页；
  - 导出 API 按筛选条件输出数据，且控制最大导出行数（如 >10 万行时拒绝并提示）；
  - 针对 PRD 12.2 要求的关键监控指标（登录成功率、错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口错误率）完成埋点并能在监控平台查询。

#### Cycle29 — [ADMIN-04][US-05][FL-07][QA] 编写用户活跃查询与导出及监控指标验证用例

- **描述**：设计并实现测试用例验证活跃查询/导出与监控指标上报：确认筛选条件、分页、导出文件正确，且监控平台上的各项指标与实际行为一致。
- **输入/输出**：
  - 输入：模拟多种登录/退出/错误场景、构造活跃记录；
  - 输出：测试脚本/用例 + 报告（包括监控平台截图或查询结果）。
- **依赖任务**：Cycle27、Cycle28。
- **DoD**：
  - 查询/导出结果与底层 LoginLog 数据一致；
  - 登录成功/失败、验证码发送失败、Token 刷新失败、Redis 会话错误等场景的监控指标在平台上可观测且数值正确；
  - 对导出超量情况有明确错误提示，不影响服务稳定性。


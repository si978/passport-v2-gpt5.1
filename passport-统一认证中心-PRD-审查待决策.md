# Passport 统一认证中心 - PRD 审查待决策事项（已归档）

> 状态：**已归档，仅保留历史审查过程**。当前最新的审查与决策结果请参见：`passport-统一认证中心-PRD-审查与决策汇总-已决策.md`。
>
> 说明：本文件基于 `passport-统一认证中心-PRD-草稿.md` 的早期版本审查结果，只汇总「描述不够精确 / 需进一步产品决策」的问题点，供回溯使用。

---

## 1. 待决策问题一览

| 问题 ID | 章节位置 | 问题简述 | 待决策要点 |
| ------- | -------- | -------- | ---------- |
| Q-01 | 1.3 本版本目标 G-02 | “一次登录、多客户端共享会话的体验”缺少时间/客户端范围定义 | 明确免二次登录适用的客户端列表与时间窗口（如绑定 Refresh Token 有效期、是否仅限同一 Windows 用户会话）。 |
| Q-02 | 1.3 本版本目标 G-03 | “安全可控的 Token 能力”表述笼统 | 明确安全性衡量维度（如过期时间、绑定 app_id、加密算法约束），形成可验证的验收标准。 |
| Q-03 | 1.3 本版本目标 G-04 | “本地额外保险机制”未在目标处说明具体机制 | 在目标层明确额外保险机制的具体做法（如基于创建时间 2 小时阈值的强制删除策略）。 |
| Q-04 | 2.1 In Scope 用户端 | “未来其他客户端”范围不清晰 | 列出首批计划接入的具体客户端清单，并约定后续新增客户端的准入标准。 |
| Q-05 | 2.3 前置假设 | “清理用户临时目录，用于删除部分 Token 文件”中“部分”不清楚 | 明确哪些 Token/会话文件放在临时目录、哪些在 ProgramData，分别依赖什么清理机制。 |
| Q-06 | 3.2 核心术语 AC-17 | “设备信息等”中“等”不明确 | 列出 LocalSession 中计划承载的设备相关字段完整清单，并约定是否允许扩展字段。 |
| Q-07 | US-03 网吧下机后自动登出 | “本地 Token 文件被系统删除”未区分具体文件 | 区分 Temp 目录中的 Token 缓存文件与 ProgramData 下的 session.dat，分别说明是否依赖系统清理或客户端自清理。 |
| Q-08 | BR-06 本地会话文件规则 | “验证文件内容完整性”未给出可见规则 | 确认采用何种完整性校验方案（如结构校验 / 版本号 / 签名），并形成可实现的规则描述。 |
| Q-09 | FL-02 Token 刷新流程 | “客户端每 3 小时自动刷新”起算点/容差不明确 | 明确刷新周期从何时起算（登录成功时间或上次刷新时间）、是否允许提前/延后刷新以及失败重试策略。 |
| Q-10 | 7.1 登录后状态与退出入口 | “明显的‘退出登录’入口”缺乏可测试标准 | 约定退出入口在 UI 中的具体层级/点击步数上限，形成可验收的交互标准。 |
| Q-11 | 8.2 User.status 字段 | 类型定义为 string/int，语义和枚举值不清晰 | 统一 status 字段类型（字符串或整数），并列出完整枚举值及对应含义。 |
| Q-12 | 8.4 LocalSession.expires_at | “具体计算方式当前信息不足” | 决定本地会话文件 expires_at 的计算规则（与 Refresh Token、文件创建时间等的关系）。 |
| Q-13 | 8.5 LoginLog.logout_time | “未做心跳时可为空”含义不清 | 约定为空时的存储形式（NULL/0/默认值）以及缺失退出时间在报表/统计中的处理方式。 |
| Q-14 | 9.1 API 概览 | 多数接口仅有语义，无 HTTP Method/URL | 为每个 API 明确 Method、URL Path、鉴权方式及是否幂等，避免实现时各自理解。 |
| Q-15 | 10.1 性能 | “响应速度应明显优于远程校验”无法量化 | 为本地 SSO 能力设定可量化的性能目标（如 P95 耗时上限或相对远程校验的倍数提升）。 |
| Q-16 | 11 权限与安全控制 | “封禁/解封等敏感操作”及后台角色不清 | 明确后台角色类型（运营/客服/技术等）及各自可执行的敏感操作范围。 |
| Q-17 | 12.2 监控与告警 | 日志和监控指标大量以“需补充”带过 | 列出首批必需的监控指标（登录成功率、验证码失败率等）及触发告警的阈值占位。 |
| Q-18 | 17 验收标准 AC-02 | “不应出现异常账号串用”表述主观 | 定义什么情况被视为“账号串用”，并给出对应的检测/验证场景示例。 |
| Q-19 | BR-08 管理后台封禁规则 | 封禁与现有会话和已登录端关系未定义 | 决定封禁后是否立即使在线会话失效/强制踢下线，以及对本地 session.dat 的处理策略。 |

---

## 2. 使用建议

1. 建议在下一轮产品/技术联合评审中，按上述问题 ID 逐条确认决策，并在原 PRD 中同步更新相应表述。
2. 对涉及安全与性能的条目（如 Q-02、Q-08、Q-15、Q-17），建议邀请安全/架构同学共同给出可实现且可验证的指标或规则。
3. 对涉及后台权限与运营流程的条目（如 Q-16、Q-19），建议由产品与运营/客服共同定义，以避免后期出现越权或流程不兼容的情况。

---

## 3. 逐条问题决策依据与建议

> 说明：本节为每个问题补充「为什么需要决策」「有哪些可选方案」「推荐方案及理由」，方便在评审会上直接对号入座。

### Q-01：G-02 一次登录、多客户端共享会话

- **问题回顾**：目前仅描述为“一次登录、多客户端共享会话”，未限定时间窗口、客户端范围、是否仅限同一 Windows 用户。
- **风险 / 影响**：
  - 若时间窗口过长，安全风险变大（尤其网吧共享设备场景）。
  - 若范围不清，未来新增客户端可能被误认为“天然支持 SSO”，带来额外交付压力。
- **可选方案**：
  - **方案 A：绑定 Refresh Token 生命周期（2 天）**  
    - 描述：在 Refresh Token 有效期 2 天内，同一 Windows 用户下的所有已接入客户端均可复用本地会话文件完成免二次登录。  
    - 优点：实现简单，规则统一；与现有 Token 设计一致。  
    - 风险：2 天时间对网吧等公共场景可能偏长，需要依赖本地文件清理机制兜底。
  - **方案 B：绑定当前 Windows 登录会话 / 短窗口**  
    - 描述：仅在当前 Windows 登录会话期间生效，一旦用户注销系统或超过例如 4 小时窗口，必须重新登录。  
    - 优点：安全性更高，更贴合网吧“下机即结束”的预期。  
    - 风险：实现上需要更精细的时间和会话管理，且对家庭 PC 用户可能稍微打扰频率更高。
- **PM 推荐**：
  - 在当前“网吧安全”是显性诉求的前提下，**推荐方案 B：以 Windows 会话 + 短时间窗口为主**，并明确：
    - 默认 SSO 有效期为 `min(当前 Windows 会话存续时间, 4 小时)`；
    - 超出该窗口或系统注销后，必须重新登录。

### Q-02：G-03 安全可控的 Token 能力

- **问题回顾**：“安全可控”缺少可验证的具体标准。
- **风险 / 影响**：安全评审和开发可能对“安全”的理解不一致，难以形成统一验收口径。
- **可选方案**：
  - **方案 A：列出最小安全要求清单**（推荐）  
    - 包括：必须绑定 `guid`、`user_type`、`account_source`、`app_id`；Access/Refresh 过期时间固定；必须通过 HTTPS 传输；Token 验证必须校验 `app_id` 与调用方一致。  
  - **方案 B：仅引用公司通用安全规范**  
    - 在 PRD 中简单写“参见统一安全规范 X 章”，细节完全由安全团队定义。
- **PM 推荐**：
  - **推荐方案 A**：在 PRD 中直接列出本项目的“最小安全要求”，方便研发和测试落地；同时在安全评审材料里再挂接公司统一规范即可。

### Q-03：G-04 本地额外保险机制

- **问题回顾**：目标中提到“额外保险机制”，但未说明具体做法，需要靠阅读 5.4 才能理解。
- **风险 / 影响**：目标层不透明，会让评审时低估该机制的重要性，影响优先级和实现质量。
- **可选方案**：
  - **方案 A：在目标中显式写出“2 小时阈值强制删除”**（推荐）。
  - **方案 B：仅在详细章节说明，不在目标中表述。**
- **PM 推荐**：
  - **推荐方案 A**，将“客户端启动时，如检测到 session.dat 创建时间超过 2 小时则强制删除”写入 G-04，以强调其是产品级承诺，而非“可以做也可以不做的优化”。

### Q-04：2.1 未来其他客户端

- **问题回顾**：“未来其他客户端”未限定清单，模糊了本期范围。
- **风险 / 影响**：
  - RD/QA/运维可能误以为需要对“所有潜在客户端”负责；
  - 新业务方可能误解为“一上来就能接入 Passport”，产生预期偏差。
- **可选方案**：
  - **方案 A：本期仅支持九尾狐 & 游利社，其他客户端不在范围内**（推荐）。
  - **方案 B：允许指定 1–2 个新增客户端作为试点，但需要单独列入范围表。**
- **PM 推荐**：
  - **推荐方案 A**，并在 PRD 中增加“首批接入客户端清单”表格，将其他客户端接入作为下一版本需求进入需求池管理。

### Q-05：2.3 “部分 Token 文件”位置不清

- **问题回顾**：未明确哪些文件放在 Temp，哪些放在 ProgramData，会影响清理策略设计。
- **风险 / 影响**：
  - 误把 session.dat 设计到 Temp，导致下机清理后无法实现 SSO；
  - 或反之，误以为系统会处理 ProgramData，导致安全残留。
- **可选方案**：
  - **方案 A：强约定“缓存类 Token 在 Temp，核心会话在 ProgramData”**（推荐）。
  - **方案 B：全部放在 ProgramData，仅靠应用清理，不依赖 Temp。**
- **PM 推荐**：
  - **推荐方案 A**：缓存类短期 Token（如 `tokens.dat`）存 Temp，核心会话 `session.dat` 存 ProgramData，由应用逻辑管理，能在安全和易实现之间取得平衡。

### Q-06：AC-17 LocalSession 字段“等”

- **问题回顾**：“设备信息等”未明确具体字段，既不方便实现，也容易在版本间偷偷加字段。
- **风险 / 影响**：
  - 新增字段可能影响兼容性（老版本客户端不认识新字段）；
  - 安全上可能引入不必要的设备指纹数据泄露风险。
- **可选方案**：
  - **方案 A：定义一份 LocalSession 字段白名单**（推荐），明确当前字段集合，不允许随意增加。  
  - **方案 B：允许扩展字段，但必须带版本号并要求向后兼容检查。**
- **PM 推荐**：
  - 作为 MVP，**推荐方案 A**，字段白名单可以控制复杂度；未来若有明确场景再引入版本化策略（方案 B）。

### Q-07：US-03 “本地 Token 文件被系统删除”

- **问题回顾**：“本地 Token 文件”未具体到文件名与路径，可能与 session.dat 混淆。
- **风险 / 影响**：
  - 若误以为 session.dat 也依赖系统清理，则实际产品行为和预期不一致，安全评审有漏洞。
- **可选方案**：
  - **方案 A：明确写出“仅限 Temp\\Passport\\tokens.dat 等临时文件”**（推荐）。
  - **方案 B：在 US-03 中同时提到 session.dat 的清理方式，做对比说明。**
- **PM 推荐**：
  - **推荐方案 A + B 结合**：US-03 内文中明确“系统自动删的是 Temp 下的 Token 缓存文件；session.dat 则由客户端在启动时按 2 小时规则清理”。

### Q-08：BR-06 完整性校验黑盒

- **问题回顾**：只说“验证文件内容完整性”，没指明具体规则。
- **风险 / 影响**：
  - 实现可能仅做“能解析 JSON 即算完整”，而忽略字段、签名、版本兼容等问题。
- **可选方案**：
  - **方案 A：定义结构级完整性校验**（必选），包括“能解密、是合法 JSON、必填字段齐全”。
  - **方案 B：在方案 A 基础上增加签名校验（HMAC 签名字段 sign）”。**
- **PM 推荐**：
  - **推荐起步采用方案 A**，满足大多数安全需求；若公司安全规范要求对本地敏感文件签名，可升级为 A+B。

### Q-09：FL-02 刷新周期细节

- **问题回顾**：只说“每 3 小时自动刷新”，起算点、提前刷新、失败重试未定义。
- **风险 / 影响**：
  - 不同客户端团队实现不同，导致服务器在某一时间点刷 Token 洪峰；
  - 失败重试缺失可能导致长时间使用过期 Token。
- **可选方案**：
  - **方案 A：固定“从登录成功起，每 3 小时 + 若干随机抖动”**（推荐）。
  - **方案 B：按剩余有效期百分比触发，如剩余 ≤ 25% 时刷新。**
- **PM 推荐**：
  - **推荐方案 A**，简单可控，并可以在工程实现中引入 0–10 分钟随机抖动，避免集体同时刷新。

### Q-10：“明显的退出入口”的可测性

- **问题回顾**：“明显”是主观描述，难以测试。
- **风险 / 影响**：
  - UI 设计可能将退出藏在不易发现的位置；
  - 用户在网吧找不到退出入口，引发安全问题。
- **可选方案**：
  - **方案 A：要求“2 步内可达 + 统一位置”**（推荐）。
  - **方案 B：由 UX 提供统一设计规范文档，再在 PRD 中引用。**
- **PM 推荐**：
  - **推荐方案 A**，即“所有已登录状态页面，用户在不超过 2 次点击内，可以从固定位置（例如右上角头像菜单）找到退出入口。”

### Q-11：User.status 类型和枚举

- **问题回顾**：`status` 同时写成 string/int，且未列出完整取值。
- **风险 / 影响**：
  - 不同系统用不同约定，导致数据清洗复杂；
  - QA 无法用统一规则验证封禁逻辑。
- **可选方案**：
  - **方案 A：统一为 int 枚举**（如 1=正常，0=封禁，-1=注销）。
  - **方案 B：统一为 string 枚举**（如 `normal`、`banned`、`deleted`）。
- **PM 推荐**：
  - 数据层面更偏向 **方案 A（int 枚举）**，便于统计与索引，但无论选哪种，都需在 PRD 中列出完整枚举值与含义。

### Q-12：LocalSession.expires_at 计算

- **问题回顾**：未明确 expires_at 与 Refresh Token 关系。
- **风险 / 影响**：
  - 可能出现本地文件早于 Refresh Token 失效或晚于其失效，造成行为不一致。
- **可选方案**：
  - **方案 A：expires_at = created_at + 2 天，与 Refresh Token 一致**（推荐）。
  - **方案 B：expires_at = min(created_at + 2 天, refresh_token_expires_at)**，预留未来调整空间。
- **PM 推荐**：
  - 基于当前需求稳定性，**推荐方案 A**，简单清晰；如未来调整 Refresh Token 规则，再同步调整此定义即可。

### Q-13：LoginLog.logout_time 为空的处理

- **问题回顾**：只说“可为空”，未规定存储/展示/统计行为。
- **风险 / 影响**：
  - 统计用户在线时长时，可能将空值当成“当前仍在线”，产生错误报表。
- **可选方案**：
  - **方案 A：数据库层统一使用 NULL 表示未知退出时间**（推荐），报表中单独处理。  
  - **方案 B：使用特殊时间值（如 1970-01-01），但要求前端隐藏该值。**
- **PM 推荐**：
  - **推荐方案 A**，使用 NULL 语义明确，避免滥用时间“魔法值”。

### Q-14：API 概览缺少 Method/URL

- **问题回顾**：API 只有“语义名”，缺乏开发落地所需信息。
- **风险 / 影响**：
  - 多团队接入时可能各自定义路径；
  - 无法统一网关路由和权限控制。
- **可选方案**：
  - **方案 A：在 PRD 中为每个 API 补充 Method + Path + 鉴权方式 + 是否幂等**（推荐）。
  - **方案 B：另起一份 API 规格文档，仅在 PRD 中引用。**
- **PM 推荐**：
  - 对于 Passport 这种底座类服务，**推荐方案 A + B 结合**：PRD 中保留概要表（含 Method/Path），详细请求/响应字段放在技术规格文档中。

### Q-15：性能“明显优于”的量化

- **问题回顾**：没有可度量指标。
- **风险 / 影响**：
  - 测试无法判断是否达标；
  - 性能优化工作缺乏目标，容易被忽略。
- **可选方案**：
  - **方案 A：为本地 SSO 登录设定绝对阈值**（如 P95 ≤ X ms）。
  - **方案 B：设定相对阈值**（如对比远程校验方案提升 ≥ Y%）。
- **PM 推荐**：
  - 建议先用 **方案 A（绝对阈值）** 作为基础目标，X 由性能测试和实际环境评估给出；在后续优化阶段再考虑方案 B 作为“进阶目标”。

### Q-16：后台角色与敏感操作

- **问题回顾**：“封禁/解封等敏感操作”的主体不清，缺乏角色与权限矩阵。
- **风险 / 影响**：
  - 运营/客服/技术之间的越权风险；
  - 合规审计时无法证明“谁能做什么”。
- **可选方案**：
  - **方案 A：定义 2–3 个标准角色**（如运营、客服、技术支持），并给出操作矩阵（推荐）。
  - **方案 B：将权限模型完全交给 IAM/权限系统配置，PRD 中不做约束。**
- **PM 推荐**：
  - **推荐方案 A**，至少在产品层给出角色与操作范围建议，后续再映射到权限系统；这样方便在需求侧审视是否有越权风险。

### Q-17：监控与告警指标

- **问题回顾**：当前仅说“需补充”，没有列出最小集合。
- **风险 / 影响**：
  - 上线后不易发现问题（如验证码突然大量失败、Token 刷新失败率飙升）。
- **可选方案**：
  - **方案 A：定义 Passport 最小监控指标集合**（推荐），例如：登录成功率、验证码发送失败率、Token 刷新失败率、Redis 会话读写错误率、接口整体错误率等。  
  - **方案 B：只要求接入统一监控平台，不列具体指标。**
- **PM 推荐**：
  - **推荐方案 A**，并在 PRD 中以表格列出指标名称、数据来源和初步报警阈值（阈值可以标记为“待运维最终确认”）。

### Q-18：AC-02 “异常账号串用”定义

- **问题回顾**：“不应出现异常账号串用”是主观判断，没有可测试场景。
- **风险 / 影响**：
  - QA 难以设计覆盖串号场景的用例；
  - 线上一旦发生账号串用事件，也难以追责“是否 PRD 未定义清楚”。
- **可选方案**：
  - **方案 A：给出若干典型“不允许出现”的串号场景**（推荐），如：A 用户退出后 B 用户打开客户端仍能直接进入 A 账号。  
  - **方案 B：给出判定规则**，如“只要当前 Windows 用户与 LocalSession 中记录的 device_id、guid 不匹配，则必须要求重新登录”。
- **PM 推荐**：
  - **推荐方案 A + B 组合**：既给出判定规则，又给出 2–3 个具体用例，方便开发和测试理解边界。

### Q-19：封禁与现有会话联动

- **问题回顾**：未说明封禁对当前在线会话的影响。
- **风险 / 影响**：
  - 如果封禁只影响“后续登录”，已有会话可以继续调用接口，会削弱封禁效果；
  - 如果封禁会立即踢下线，又需要额外实现和通知逻辑。
- **可选方案**：
  - **方案 A：封禁 = 立即全局失效**（推荐），即删除 Redis 会话、通知客户端下次请求强制退出，并在本地删除 session.dat。  
  - **方案 B：封禁仅影响新登录，不主动清理已有会话**，保守处理，减少实现成本。
- **PM 推荐**：
  - 考虑本项目对安全的重视程度，**推荐方案 A**：封禁即视为严重风险用户，应立即失效所有会话；但需同步评估对用户体验和运营误操作的影响，并可在后台提供“解封后自动允许重新登录”的流程。


---

## 3. 逐条问题决策依据与建议

> 说明：本节为每个问题补充「为什么需要决策」「有哪些可选方案」「推荐方案及理由」，方便在评审会上直接对号入座。

### Q-01：G-02 一次登录、多客户端共享会话

- **问题回顾**：目前仅描述为“一次登录、多客户端共享会话”，未限定时间窗口、客户端范围、是否仅限同一 Windows 用户。
- **风险 / 影响**：
  - 若时间窗口过长，安全风险变大（尤其网吧共享设备场景）。
  - 若范围不清，未来新增客户端可能被误认为“天然支持 SSO”，带来额外交付压力。
- **可选方案**：
  - **方案 A：绑定 Refresh Token 生命周期（2 天）**  
    - 描述：在 Refresh Token 有效期 2 天内，同一 Windows 用户下的所有已接入客户端均可复用本地会话文件完成免二次登录。  
    - 优点：实现简单，规则统一；与现有 Token 设计一致。  
    - 风险：2 天时间对网吧等公共场景可能偏长，需要依赖本地文件清理机制兜底。
  - **方案 B：绑定当前 Windows 登录会话 / 短窗口**  
    - 描述：仅在当前 Windows 登录会话期间生效，一旦用户注销系统或超过例如 4 小时窗口，必须重新登录。  
    - 优点：安全性更高，更贴合网吧“下机即结束”的预期。  
    - 风险：实现上需要更精细的时间和会话管理，且对家庭 PC 用户可能稍微打扰频率更高。
- **PM 推荐**：
  - 在当前“网吧安全”是显性诉求的前提下，**推荐方案 B：以 Windows 会话 + 短时间窗口为主**，并明确：
    - 默认 SSO 有效期为 `min(当前 Windows 会话存续时间, 4 小时)`；
    - 超出该窗口或系统注销后，必须重新登录。

### Q-02：G-03 安全可控的 Token 能力

- **问题回顾**：“安全可控”缺少可验证的具体标准。
- **风险 / 影响**：安全评审和开发可能对“安全”的理解不一致，难以形成统一验收口径。
- **可选方案**：
  - **方案 A：列出最小安全要求清单**（推荐）  
    - 包括：必须绑定 `guid`、`user_type`、`account_source`、`app_id`；Access/Refresh 过期时间固定；必须通过 HTTPS 传输；Token 验证必须校验 `app_id` 与调用方一致。  
  - **方案 B：仅引用公司通用安全规范**  
    - 在 PRD 中简单写“参见统一安全规范 X 章”，细节完全由安全团队定义。
- **PM 推荐**：
  - **推荐方案 A**：在 PRD 中直接列出本项目的“最小安全要求”，方便研发和测试落地；同时在安全评审材料里再挂接公司统一规范即可。

### Q-03：G-04 本地额外保险机制

- **问题回顾**：目标中提到“额外保险机制”，但未说明具体做法，需要靠阅读 5.4 才能理解。
- **风险 / 影响**：目标层不透明，会让评审时低估该机制的重要性，影响优先级和实现质量。
- **可选方案**：
  - **方案 A：在目标中显式写出“2 小时阈值强制删除”**（推荐）。
  - **方案 B：仅在详细章节说明，不在目标中表述。**
- **PM 推荐**：
  - **推荐方案 A**，将“客户端启动时，如检测到 session.dat 创建时间超过 2 小时则强制删除”写入 G-04，以强调其是产品级承诺，而非“可以做也可以不做的优化”。

### Q-04：2.1 未来其他客户端

- **问题回顾**：“未来其他客户端”未限定清单，模糊了本期范围。
- **风险 / 影响**：
  - RD/QA/运维可能误以为需要对“所有潜在客户端”负责；
  - 新业务方可能误解为“一上来就能接入 Passport”，产生预期偏差。
- **可选方案**：
  - **方案 A：本期仅支持九尾狐 & 游利社，其他客户端不在范围内**（推荐）。
  - **方案 B：允许指定 1–2 个新增客户端作为试点，但需要单独列入范围表。**
- **PM 推荐**：
  - **推荐方案 A**，并在 PRD 中增加“首批接入客户端清单”表格，将其他客户端接入作为下一版本需求进入需求池管理。

### Q-05：2.3 “部分 Token 文件”位置不清

- **问题回顾**：未明确哪些文件放在 Temp，哪些放在 ProgramData，会影响清理策略设计。
- **风险 / 影响**：
  - 误把 session.dat 设计到 Temp，导致下机清理后无法实现 SSO；
  - 或反之，误以为系统会处理 ProgramData，导致安全残留。
- **可选方案**：
  - **方案 A：强约定“缓存类 Token 在 Temp，核心会话在 ProgramData”**（推荐）。
  - **方案 B：全部放在 ProgramData，仅靠应用清理，不依赖 Temp。**
- **PM 推荐**：
  - **推荐方案 A**：缓存类短期 Token（如 `tokens.dat`）存 Temp，核心会话 `session.dat` 存 ProgramData，由应用逻辑管理，能在安全和易实现之间取得平衡。

### Q-06：AC-17 LocalSession 字段“等”

- **问题回顾**：“设备信息等”未明确具体字段，既不方便实现，也容易在版本间偷偷加字段。
- **风险 / 影响**：
  - 新增字段可能影响兼容性（老版本客户端不认识新字段）；
  - 安全上可能引入不必要的设备指纹数据泄露风险。
- **可选方案**：
  - **方案 A：定义一份 LocalSession 字段白名单**（推荐），明确当前字段集合，不允许随意增加。  
  - **方案 B：允许扩展字段，但必须带版本号并要求向后兼容检查。**
- **PM 推荐**：
  - 作为 MVP，**推荐方案 A**，字段白名单可以控制复杂度；未来若有明确场景再引入版本化策略（方案 B）。

### Q-07：US-03 “本地 Token 文件被系统删除”

- **问题回顾**：“本地 Token 文件”未具体到文件名与路径，可能与 session.dat 混淆。
- **风险 / 影响**：
  - 若误以为 session.dat 也依赖系统清理，则实际产品行为和预期不一致，安全评审有漏洞。
- **可选方案**：
  - **方案 A：明确写出“仅限 Temp\Passport\tokens.dat 等临时文件”**（推荐）。
  - **方案 B：在 US-03 中同时提到 session.dat 的清理方式，做对比说明。**
- **PM 推荐**：
  - **推荐方案 A + B 结合**：US-03 内文中明确“系统自动删的是 Temp 下的 Token 缓存文件；session.dat 则由客户端在启动时按 2 小时规则清理”。

### Q-08：BR-06 完整性校验黑盒

- **问题回顾**：只说“验证文件内容完整性”，没指明具体规则。
- **风险 / 影响**：实现可能仅做“能解析 JSON 即算完整”，而忽略字段、签名、版本兼容等问题。
- **可选方案**：
  - **方案 A：定义结构级完整性校验**（必选），包括“能解密、是合法 JSON、必填字段齐全”。
  - **方案 B：在方案 A 基础上增加签名校验（HMAC 签名字段 sign）”。**
- **PM 推荐**：
  - **推荐起步采用方案 A**，满足大多数安全需求；若公司安全规范要求对本地敏感文件签名，可升级为 A+B。

### Q-09：FL-02 刷新周期细节

- **问题回顾**：只说“每 3 小时自动刷新”，起算点、提前刷新、失败重试未定义。
- **风险 / 影响**：
  - 不同客户端团队实现不同，导致服务器在某一时间点刷 Token 洪峰；
  - 失败重试缺失可能导致长时间使用过期 Token。
- **可选方案**：
  - **方案 A：固定“从登录成功起，每 3 小时 + 若干随机抖动”**（推荐）。
  - **方案 B：按剩余有效期百分比触发，如剩余 ≤ 25% 时刷新。**
- **PM 推荐**：
  - **推荐方案 A**，简单可控，并可以在工程实现中引入 0–10 分钟随机抖动，避免集体同时刷新。

### Q-10：“明显的退出入口”的可测性

- **问题回顾**：“明显”是主观描述，难以测试。
- **风险 / 影响**：
  - UI 设计可能将退出藏在不易发现的位置；
  - 用户在网吧找不到退出入口，引发安全问题。
- **可选方案**：
  - **方案 A：要求“2 步内可达 + 统一位置”**（推荐）。
  - **方案 B：由 UX 提供统一设计规范文档，再在 PRD 中引用。**
- **PM 推荐**：
  - **推荐方案 A**，即“所有已登录状态页面，用户在不超过 2 次点击内，可以从固定位置（例如右上角头像菜单）找到退出入口。”

### Q-11：User.status 类型和枚举

- **问题回顾**：`status` 同时写成 string/int，且未列出完整取值。
- **风险 / 影响**：
  - 不同系统用不同约定，导致数据清洗复杂；
  - QA 无法用统一规则验证封禁逻辑。
- **可选方案**：
  - **方案 A：统一为 int 枚举**（如 1=正常，0=封禁，-1=注销）。
  - **方案 B：统一为 string 枚举**（如 `normal`、`banned`、`deleted`）。
- **PM 推荐**：
  - 数据层面更偏向 **方案 A（int 枚举）**，便于统计与索引，但无论选哪种，都需在 PRD 中列出完整枚举值与含义。

### Q-12：LocalSession.expires_at 计算

- **问题回顾**：未明确 expires_at 与 Refresh Token 关系。
- **风险 / 影响**：
  - 可能出现本地文件早于 Refresh Token 失效或晚于其失效，造成行为不一致。
- **可选方案**：
  - **方案 A：expires_at = created_at + 2 天，与 Refresh Token 一致**（推荐）。
  - **方案 B：expires_at = min(created_at + 2 天, refresh_token_expires_at)**，预留未来调整空间。
- **PM 推荐**：
  - 基于当前需求稳定性，**推荐方案 A**，简单清晰；如未来调整 Refresh Token 规则，再同步调整此定义即可。

### Q-13：LoginLog.logout_time 为空的处理

- **问题回顾**：只说“可为空”，未规定存储/展示/统计行为。
- **风险 / 影响**：
  - 统计用户在线时长时，可能将空值当成“当前仍在线”，产生错误报表。
- **可选方案**：
  - **方案 A：数据库层统一使用 NULL 表示未知退出时间**（推荐），报表中单独处理。  
  - **方案 B：使用特殊时间值（如 1970-01-01），但要求前端隐藏该值。**
- **PM 推荐**：
  - **推荐方案 A**，使用 NULL 语义明确，避免滥用时间“魔法值”。

### Q-14：API 概览缺少 Method/URL

- **问题回顾**：API 只有“语义名”，缺乏开发落地所需信息。
- **风险 / 影响**：
  - 多团队接入时可能各自定义路径；
  - 无法统一网关路由和权限控制。
- **可选方案**：
  - **方案 A：在 PRD 中为每个 API 补充 Method + Path + 鉴权方式 + 是否幂等**（推荐）。
  - **方案 B：另起一份 API 规格文档，仅在 PRD 中引用。**
- **PM 推荐**：
  - 对于 Passport 这种底座类服务，**推荐方案 A + B 结合**：PRD 中保留概要表（含 Method/Path），详细请求/响应字段放在技术规格文档中。

### Q-15：性能“明显优于”的量化

- **问题回顾**：没有可度量指标。
- **风险 / 影响**：
  - 测试无法判断是否达标；
  - 性能优化工作缺乏目标，容易被忽略。
- **可选方案**：
  - **方案 A：为本地 SSO 登录设定绝对阈值**（如 P95 ≤ X ms）。
  - **方案 B：设定相对阈值**（如对比远程校验方案提升 ≥ Y%）。
- **PM 推荐**：
  - 建议先用 **方案 A（绝对阈值）** 作为基础目标，X 由性能测试和实际环境评估给出；在后续优化阶段再考虑方案 B 作为“进阶目标”。

### Q-16：后台角色与敏感操作

- **问题回顾**：“封禁/解封等敏感操作”的主体不清，缺乏角色与权限矩阵。
- **风险 / 影响**：
  - 运营/客服/技术之间的越权风险；
  - 合规审计时无法证明“谁能做什么”。
- **可选方案**：
  - **方案 A：定义 2–3 个标准角色**（如运营、客服、技术支持），并给出操作矩阵（推荐）。
  - **方案 B：将权限模型完全交给 IAM/权限系统配置，PRD 中不做约束。**
- **PM 推荐**：
  - **推荐方案 A**，至少在产品层给出角色与操作范围建议，后续再映射到权限系统；这样方便在需求侧审视是否有越权风险。

### Q-17：监控与告警指标

- **问题回顾**：当前仅说“需补充”，没有列出最小集合。
- **风险 / 影响**：
  - 上线后不易发现问题（如验证码突然大量失败、Token 刷新失败率飙升）。
- **可选方案**：
  - **方案 A：定义 Passport 最小监控指标集合**（推荐），例如：登录成功率、验证码发送失败率、Token 刷新失败率、Redis 会话读写错误率、接口整体错误率等。  
  - **方案 B：只要求接入统一监控平台，不列具体指标。**
- **PM 推荐**：
  - **推荐方案 A**，并在 PRD 中以表格列出指标名称、数据来源和初步报警阈值（阈值可以标记为“待运维最终确认”）。

### Q-18：AC-02 “异常账号串用”定义

- **问题回顾**：“不应出现异常账号串用”是主观判断，没有可测试场景。
- **风险 / 影响**：
  - QA 难以设计覆盖串号场景的用例；
  - 线上一旦发生账号串用事件，也难以追责“是否 PRD 未定义清楚”。
- **可选方案**：
  - **方案 A：给出若干典型“不允许出现”的串号场景**（推荐），如：A 用户退出后 B 用户打开客户端仍能直接进入 A 账号。  
  - **方案 B：给出判定规则**，如“只要当前 Windows 用户与 LocalSession 中记录的 device_id、guid 不匹配，则必须要求重新登录”。
- **PM 推荐**：
  - **推荐方案 A + B 组合**：既给出判定规则，又给出 2–3 个具体用例，方便开发和测试理解边界。

### Q-19：封禁与现有会话联动

- **问题回顾**：未说明封禁对当前在线会话的影响。
- **风险 / 影响**：
  - 如果封禁只影响“后续登录”，已有会话可以继续调用接口，会削弱封禁效果；
  - 如果封禁会立即踢下线，又需要额外实现和通知逻辑。
- **可选方案**：
  - **方案 A：封禁 = 立即全局失效**（推荐），即删除 Redis 会话、通知客户端下次请求强制退出，并在本地删除 session.dat。  
  - **方案 B：封禁仅影响新登录，不主动清理已有会话**，保守处理，减少实现成本。
- **PM 推荐**：
  - 考虑本项目对安全的重视程度，**推荐方案 A**：封禁即视为严重风险用户，应立即失效所有会话；但需同步评估对用户体验和运营误操作的影响，并可在后台提供“解封后自动允许重新登录”的流程。


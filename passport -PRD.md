**passport统一认证中心 - 需求文档（原始输入，仅供追溯）**

> 【重要】本文件为最初整理的「passport统一认证中心 - 需求文档」导出版本，内容相对零散，仅作为**历史原始需求素材**保留。当前项目开发 / 测试 / 运维的唯一权威需求，请以《passport-统一认证中心-PRD-草稿.md》（Passport 统一认证中心 - PRD（V1 多视图对齐版））为准；如本文件与主 PRD 存在任何不一致或缺失，以主 PRD 的描述为最终依据。

**1、背景与目标**

**1.1、业务背景**

公司旗下【九尾狐】、【游利社】两个Windows客户端产品，采用分散的账户体系，导致：

❌ 用户在不同产品间需要重复注册登录

❌ 用户身份分散，无法跨产品定位用户

❌ 扩展性差，新产品接入困难

**1.2 解决方案**

建立 **Passport 统一认证中心**，实现：

✅ **身份统一**: 所有用户拥有全局唯一的 GUID

✅ **统一登录**: 登录一次，跨产品流动

✅ **网吧适配**: 下机时自动清除用户信息，保证安全

**1.3 MVP版本范围**

**本版本实现**:

✅ 手机号 + 验证码登录/注册

✅ 统一身份标识（GUID）

✅ 跨客户端自动登录（基于本地文件共享）

✅ Token管理（JWT）

✅ 网吧下机自动清理



**1.4、系统架构图**

  ------------------------------------------------------------------
  Plain Text\
  ┌─────────────────────────────────────────────────────────────┐\
  │ 客户端层 │\
  ├─────────────────────────────────────────────────────────────┤\
  │ 九尾狐客户端 游利社客户端 其他客户端 │\
  │ ↓ ↓ ↓ │\
  │ 读写本地会话文件 ←────────────────────────────→ │\
  │ (C:\\ProgramData\\Passport\\session.dat) │\
  │ (Windows DPAPI 加密) │\
  └─────────────────────────────────────────────────────────────┘\
  ↓ HTTPS\
  ┌─────────────────────────────────────────────────────────────┐\
  │ Passport 服务端 │\
  ├─────────────────────────────────────────────────────────────┤\
  │ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │\
  │ │ 认证模块 │ │ Token模块 │ │ 会话模块 │ │\
  │ │ - 验证码 │ │ - JWT签发 │ │ - 会话管理 │ │\
  │ │ - 登录注册 │ │ - Token刷新 │ │ - 跨应用登录 │ │\
  │ │ - 用户管理 │ │ - Token验证 │ │ - 会话续期 │ │\
  │ └──────────────┘ └──────────────┘ └──────────────┘ │\
  └─────────────────────────────────────────────────────────────┘\
  ↓\
  ┌─────────────────────────────────────────────────────────────┐\
  │ 存储层 │\
  ├─────────────────────────────────────────────────────────────┤\
  │ ┌──────────────────┐ ┌────────────────────┐ │\
  │ │ Redis (单机) │ │ MySQL │ │\
  │ │ - 会话数据 │ │ - 用户表 │ │\
  │ │ - Token缓存 │ │ - 凭证表 │ │\
  │ │ - 验证码缓存 │ │ - 验证码表 │ │\
  │ │ │ │ - 登录日志 │ │\
  │ └──────────────────┘ └────────────────────┘ │\
  └─────────────────────────────────────────────────────────────┘

  ------------------------------------------------------------------

**2、基础定义**

**2.1、用户类型定义**

  -------------- ------------ -------------- ---------------------- --------------------
  用户类型       类型代码     说明           来源系统               典型场景

  **C 端用户**   user         普通个人用户   游利社、商城、九尾狐   网吧用户、游戏玩家
  -------------- ------------ -------------- ---------------------- --------------------

**2.2、身份标识体系**

全局唯一标识（GUID），生成时校验不可重复

格式：20位数字字符串，示例：20251114011234567890

生成规则：

├─ 前8位：年月日（20251114 = 2025年11月14日）

├─ 中间2位：用户类型（01=C端，等等）

└─ 后10位：随机序列号

特性：

├─ 全局唯一，不可重复

├─ 跨业务系统通用

└─ 永久不变（即使修改手机号）

**2.3、账户身份来源**

为了区分用户来自哪个业务系统，需要记录账户来源：

  ---------------- ------------------ ----------------------------
  来源代码         来源名称           说明

  jiuweihu         九尾狐             从九尾狐系统注册的用户

  youlishe         游利社             从游利社系统注册的用户

  passport         Passport           直接从 Passport 注册的用户

  待定             待定               新业务
  ---------------- ------------------ ----------------------------

**3、登录方式与注册流程**

**3.1 手机号注册/登录（唯一登录方式）**

流程图:

  --------------------------------------------------------------
  Plain Text\
  步骤1: 输入手机号\
  ↓\
  步骤2: 获取并输入验证码\
  ↓\
  步骤3: 同意用户协议\
  ↓\
  步骤4: 系统判断\
  ├─ 手机号已存在 → 直接登录\
  └─ 手机号不存在 → 自动注册 + 登录\
  ├─ 生成全局唯一 GUID\
  ├─ 创建用户记录\
  └─ 签发 Token

  --------------------------------------------------------------

**业务规则**:

![](md_output\passport统一认证中心 - 需求文档\media/media/image1.png)

**点击图片可查看完整电子表格**

**异常处理**:

![](md_output\passport统一认证中心 - 需求文档\media/media/image2.png)

**点击图片可查看完整电子表格**

![](md_output\passport统一认证中心 - 需求文档\media/media/image3.png){width="4.729166666666667in" height="4.197916666666667in"}

**流程图**

![](md_output\passport统一认证中心 - 需求文档\media/media/image4.png){width="5.75in" height="4.375in"}

**4、Token 管理**

**4.1 、token类型**

  ------------------- ------------------- ------------ ----------------------------
  Token 类型          用途                有效期       刷新机制

  **Access Token**    访问业务接口        4小时        可刷新

  **Refresh Token**   刷新 Access Token   2天          不可刷新，过期失效需要重登
  ------------------- ------------------- ------------ ----------------------------

**4.2 、token结构**

**Header(示例)**:

  --------------------------------------------------------------
  JSON\
  {\
  \"alg\": \"HS256\",\
  \"typ\": \"JWT\"\
  }

  --------------------------------------------------------------

**Payload(示例)**:

  --------------------------------------------------------------
  JSON\
  {\
  \"guid\": \"20251114011234567890\",\
  \"user_type\": \"user\",\
  \"account_source\": \"youlishe\",\
  \"device_id\": \"00-16-EA-AE-3C-40\",//mac地址\
  \"app_id\": \"youlishe\",\
  \"iat\": 1705298400,*// 签发时间*\
  \"exp\": 1705299300,*// 过期时间*\
  \"jti\": \"token_unique_id\"\
  }

  --------------------------------------------------------------

**4.3 Token 生命周期**

  --------------------------------------------------------------
  Plain Text\
  代码块\
  用户登录\
  ↓\
  签发 Access Token (4小时) + Refresh Token (2天)\
  ↓\
  客户端每 3小时 自动刷新 Access Token\
  ↓\
  Refresh Token 过期后，需重新登录

  --------------------------------------------------------------

**token状态图**

![](md_output\passport统一认证中心 - 需求文档\media/media/image5.png){width="2.5104166666666665in" height="5.729166666666667in"}

**4.4 Token 刷新流程**

使用refresh_token与app_id请求获得access token。示例如下：

**请求(示例)**:

  -------------------------------------------------------------------
  JSON\
  {\
  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"app_id\": \"jiuweihu\"\
  }

  -------------------------------------------------------------------

**响应(示例)**:

  ------------------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"message\": \"刷新成功\",\
  \"data\": {\
  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"expires_in\": 14400\
  }\
  }

  ------------------------------------------------------------------

**业务逻辑**:

验证 Refresh Token，获取GUID

查询 Redis 会话：session:{guid}

检查 Refresh Token 是否匹配

检查 Refresh Token 是否过期（2天）

生成新的 Access Token（4小时有效期）

更新 Redis 会话：apps.{app_id}.access_token

**客户端刷新策略**：

每3小时自动刷新

**说明**：

必须传递 app_id

Access Token 有效期4小时（14400秒）

Refresh Token 不刷新，不续期，仍然是原来的2天有效期

**时序图**:

![](md_output\passport统一认证中心 - 需求文档\media/media/image6.png){width="5.75in" height="5.135416666666667in"}

**4.5、验证 Token**

验证token是否有效，进行通信

**请求**:

  ------------------------------------------------------------------
  JSON\
  {\
  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"app_id\": \"jiuweihu\"\
  }

  ------------------------------------------------------------------

**响应**:

  --------------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"message\": \"Token有效\",\
  \"data\": {\
  \"valid\": true,\
  \"guid\": \"20251114011234567890\",\
  \"expires_at\": 1705327200\
  }\
  }

  --------------------------------------------------------------

**验证流程**:

解析 Access Token，获取GUID和app_id

检查 app_id 是否匹配

查询 Redis 会话：session:{guid}

检查应用是否存在：apps.{app_id}

比对 Token 是否匹配

检查 Token 是否过期（4小时）

**4.6 Token 存储（客户端）**

![](md_output\passport统一认证中心 - 需求文档\media/media/image7.png)

**点击图片可查看完整电子表格**

**存储位置**:

  -------------------------------------------------------------------
  Plain Text\
  C:\\Users\\{username}\\AppData\\Local\\Temp\\Passport\\tokens.dat

  -------------------------------------------------------------------

  --------------------------------------------------------------
  **网吧适配**: Windows 注销时，系统自动清理 Temp 目录

  --------------------------------------------------------------

**5、跨客户端 SSO 流程**

**5.1 方案说明**

**核心思路**: 使用本地加密文件共享会话信息，无需进程间通信

**优势**:

✅ 天然支持网吧下机清理

✅ 无需网络请求，响应速度快

**5.2 详细流程**

**场景**: 用户在九尾狐已登录，打开游利社时自动登录

  -------------------------------------------------------------------
  Plain Text\
  代码块\
  步骤1: 用户在九尾狐登录成功\
  ↓\
  步骤2: 九尾狐将会话信息写入本地文件\
  文件路径: C:\\ProgramData\\Passport\\session.dat\
  加密方式: Windows DPAPI（只有当前用户可解密）\
  ↓\
  步骤3: 用户打开游利社客户端\
  ↓\
  步骤4: 游利社检测本地会话文件\
  ├─ 文件存在 → 读取并解密\
  │ ├─ 检查会话是否过期（超过4小时）\
  │ ├─ 未过期 → 使用该会话的 Refresh Token 获取自己的 Access Token\
  │ └─ 已过期 → 显示登录页面\
  └─ 文件不存在 → 显示登录页面\
  ↓\
  步骤5: 游利社自动登录成功\
  ↓\
  步骤6: 游利社更新本地会话文件（更新 last_app 字段）

  -------------------------------------------------------------------

**请求示例**

  -------------------------------------------------------------------
  JSON\
  {\
  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"app_id\": \"youlishe\"\
  }

  -------------------------------------------------------------------

**响应**:

  ------------------------------------------------------------------
  JSON\
  {\
  \"code\": 200,\
  \"data\": {\
  \"guid\": \"20251114011234567890\",\
  \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"expires_in\": 14400\
  }\
  }

  ------------------------------------------------------------------

**业务逻辑**:

验证 Refresh Token，获取GUID

查询 Redis 会话：session:{guid}

检查 Refresh Token 是否匹配

检查 Refresh Token 是否过期（2天）

为目标应用生成新的 Access Token（4小时有效期）

更新 Redis 会话：apps.{app_id}.access_token

**说明**：

✅ Refresh Token所有应用共享

✅ 返回的Access Token有效期4小时

**5.3 本地文件结构**

**文件路径**:

  --------------------------------------------------------------
  Plain Text\
  C:\\ProgramData\\Passport\\session.dat

  --------------------------------------------------------------

**文件内容**（加密前的JSON结构）:

  -------------------------------------------------------------------
  JSON\
  {\
  \"guid\": \"20251114011234567890\",\
  \"phone\": \"13800138000\",\
  \"user_type\": \"user\",\
  \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\...\",\
  \"device_id\": \"00-16-EA-AE-3C-40\",\
  \"last_app\": \"jiuweihu\",//这个表示会话的app\
  \"created_at\": 1705298400,\
  \"updated_at\": 1705298400,\
  \"expires_at\": 1707890400\
  }

  -------------------------------------------------------------------

**安全措施**:

使用 Windows DPAPI 加密，只有当前 Windows 用户可解密

文件权限设置为当前用户独占

每次读取后验证完整性

**5.4 网吧下机清理**

**清理机制**:

  --------------------------------------------------------------
  Plain Text\
  用户在网吧下机（Windows 注销）\
  ↓\
  Windows 系统自动清理用户临时目录\
  ↓\
  C:\\ProgramData\\Passport\\session.dat 被删除\
  ↓\
  下一个用户上机时，无法读取到前一个用户的会话

  --------------------------------------------------------------

**额外保险措施**:

客户端启动时检查会话文件的创建时间

如果超过 2小时，强制删除（防止系统未正常清理）

**6、会话管理**

**6.1 架构说明**

两层架构（用户会话 → 应用Token）

![](md_output\passport统一认证中心 - 需求文档\media/media/image8.png){width="5.427083333333333in" height="4.84375in"}

**Token有效期设计**：

  --------------------------------------------------------------
  Plain Text\
  Access Token: 4小时（14400秒）\
  Refresh Token: 2天（172800秒）\
  刷新策略: 每3小时自动刷新\
  Redis TTL: 2天\
  延长机制: 不续期

  --------------------------------------------------------------

**说明**：

✅ Refresh Token所有应用共享

✅ Access Token按应用独立存储

**6.2 Redis 数据结构**

**Key**: session:{guid}

**Value** (**示例**):

  --------------------------------------------------------------
  JSON\
  {\
  \"guid\": \"20251114011234567890\",\
  \"user_type\": \"01\",\
  \"phone\": \"13800138000\",\
  \"created_at\": 1705298400,\
  \"last_active_at\": 1705299300,\
  \
  \"refresh_token\": \"eyJhbG\...RRR\",\
  \"refresh_token_expires_at\": 1705471200,\
  \
  \"apps\": {\
  \"jiuweihu\": {\
  \"access_token\": \"eyJhbG\...AAA\",\
  \"token_expires_at\": 1705312800,\
  \"last_login_at\": 1705298400,\
  \"last_active_at\": 1705299300\
  },\
  \"youlishe\": {\
  \"access_token\": \"eyJhbG\...BBB\",\
  \"token_expires_at\": 1705312900,\
  \"last_login_at\": 1705298500,\
  \"last_active_at\": 1705299400\
  }\
  }\
  }

  --------------------------------------------------------------

**TTL**: 2天（172800秒，与Refresh Token过期时间一致）

**字段说明**：

refresh_token: 所有应用共享的Refresh Token

refresh_token_expires_at: Refresh Token过期时间（2天，不续期）

apps.{app_id}.access_token: 各应用独立的Access Token

apps.{app_id}.token_expires_at: Access Token过期时间（4小时）

**6.3 会话创建流程**

![](md_output\passport统一认证中心 - 需求文档\media/media/image9.jpeg){width="5.75in" height="3.3229166666666665in"}

**6.4 会话续期机制**

**客户端刷新策略**

![](md_output\passport统一认证中心 - 需求文档\media/media/image10.png)

**点击图片可查看完整电子表格**

**刷新流程**：

  --------------------------------------------------------------
  Plain Text\
  T0: 登录\
  → Access Token: 4小时有效期\
  → Refresh Token: 2天有效期\
  \
  T3: 客户端自动刷新（每3小时）\
  → 生成新的Access Token: 4小时有效期\
  → Refresh Token不变（不续期）\
  \
  T6: 客户端自动刷新\
  → 生成新的Access Token: 4小时有效期\
  \
  T9: 客户端自动刷新\
  → 生成新的Access Token: 4小时有效期\
  \
  \...\
  \
  T48: Refresh Token过期（2天后）\
  → 需要重新登录

  --------------------------------------------------------------

**6.5、并发请求处理**

![](md_output\passport统一认证中心 - 需求文档\media/media/image11.jpeg){width="5.75in" height="4.291666666666667in"}

**6.6、会话销毁流程**

退出登录（全局退出）

**设计原则**：退出 = 全局退出，删除所有Token

**原因**：

用户体验合理：用户点击\"退出\"期望彻底退出，而不是\"退出了还能自动登录\"

吧场景安全：退出后不留任何登录凭证（Refresh Token）

**流程**：

  --------------------------------------------------------------
  Plain Text\
  用户在九尾狐点击\"退出登录\"\
  ↓\
  调用服务端API：DELETE session:{guid}\
  ↓\
  删除本地文件 session.dat（包括Refresh Token）\
  ↓\
  清空内存中的Token\
  ↓\
  显示登录页面\
  ↓\
  游利社下次调用API时收到401错误\
  ↓\
  游利社尝试刷新Token，发现本地文件不存在\
  ↓\
  游利社显示登录页面

  --------------------------------------------------------------

**关键点**：

✅ 删除 Redis 会话（所有应用的Access Token）

✅ 删除本地文件（Refresh Token）

✅ 所有应用都需要重新登录

✅ 网吧场景：不留任何痕迹

**时序图：**

![](md_output\passport统一认证中心 - 需求文档\media/media/image12.jpeg){width="5.75in" height="4.5in"}

**7、管理后台功能**

**7.1用户信息表**

![](md_output\passport统一认证中心 - 需求文档\media/media/image13.png){width="5.75in" height="1.6458333333333333in"}

内容说明：可以通过手机号模糊搜索用户、通过账户来源筛选列表内容。

字段说明如下：

+:-------------+:-------------------------------------------------------+
| 字段名称     | 说明                                                   |
+--------------+--------------------------------------------------------+
| 用户ID       | 用户ID                                                 |
+--------------+--------------------------------------------------------+
| 手机号       | 用户手机号                                             |
+--------------+--------------------------------------------------------+
| 用户类型     | 普通用户，后续添加                                     |
+--------------+--------------------------------------------------------+
| 账户来源     | 注册时的来源（游利社、九尾狐）                         |
+--------------+--------------------------------------------------------+
| 账户状态     | 正常、封禁                                             |
+--------------+--------------------------------------------------------+
| 注册时间     | 注册的时间                                             |
+--------------+--------------------------------------------------------+
| 最后登录时间 | 最近一次登录时间                                       |
+--------------+--------------------------------------------------------+
| 登录次数     | 累计登录次数，登录1次记1                               |
+--------------+--------------------------------------------------------+
| 登录天数     | 登录天数，1天记1次                                     |
+--------------+--------------------------------------------------------+
| 操作         | 封禁：状态正常时展示，点击二次确认后封禁用户，无法登录 |
|              |                                                        |
|              | 解封：状态封禁时展示，点击二次确认后解封用户，正常登录 |
+--------------+--------------------------------------------------------+

**7.2用户活跃表**

![](md_output\passport统一认证中心 - 需求文档\media/media/image14.png){width="5.75in" height="1.6041666666666667in"}

内容说明：可以通过手机号模糊搜索用户、登录时间、登录渠道筛选列表内容，可按筛选导出。

由于存在sso，多登录渠道分开统计。游利社、九尾狐各一条，通过access token 与appid区分

  ------------- -----------------------------------------------------------
  字段名称      说明

  用户ID        用户ID

  手机号        用户手机号

  用户类型      普通用户，后续添加

  登录渠道      本次登录的客户端平台，九尾狐或游利社，多个则分开统计

  登录时间      登录的时间

  退出时间      最后一次心跳时间 或 主动退出的时间 （**不做心跳先为空**）

  IP地址        用户的公网ip地址

  mac地址       使用的mac地址

  腾讯网关      腾讯的网关账号，游利社dll获取的

  网吧名称      网关账号对应的网吧名称
  ------------- -----------------------------------------------------------

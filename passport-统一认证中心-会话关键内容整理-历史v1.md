# Passport 统一认证中心 - 会话关键内容整理（v1.0 历史快照，仅 Q 决策）

> 【重要】本文件为**历史会话快照**，仅对应以下范围：  
> - PRD 版本：Passport 统一认证中心 - PRD（V1 已决策版，v1.0）  
> - 决策范围：产品层 Q-01 ～ Q-19（不包含 C-01 ～ C-07 多视图决策）  
> 当前开发阶段的入口导航请阅读：《passport-统一认证中心-会话关键内容整理-开发入口.md》（开发阶段入口版 v1.1）；
> 如需查看 PRD v1.1 多视图审查收敛后的详细整理，可参考：《passport-统一认证中心-会话关键内容整理.md》（多视图已决策版 v1.1，历史整理）。
>
> 目的：本文件面向后续接手的产品 / 研发 / 测试同学，快速说明当时会话中已经产出的**核心文档、关键决策与使用方式**，作为入口索引使用。

---

## 1. 文档清单与状态

| 序号 | 文件名 | 角色定位 | 当前状态 |
| ---- | ------ | -------- | -------- |
| 1 | `passport -PRD.md` | 原始零散需求文档（早期「passport统一认证中心 - 需求文档」导出） | 保留原始输入，供追溯使用 |
| 2 | `PRD-model.md` | 通用 PRD 模板 / 框架 | 仍可作为后续产品文档结构参考 |
| 3 | `passport-统一认证中心-PRD-草稿.md` | **主 PRD 文档**，本会话已升级为「Passport 统一认证中心 - PRD（V1 已决策）」 | **使用中（V1 已决策主 PRD）** |
| 4 | `passport-统一认证中心-PRD-审查待决策.md` | 早期审查阶段列出的 Q-01 ～ Q-19 问题清单与论证基础 | 已归档，仅保留历史审查过程 |
| 5 | `passport-统一认证中心-PRD-审查已决策.md` | 第一版“已决策”摘要，现在被综合版替代 | 已归档，仅保留历史记录 |
| 6 | `passport-统一认证中心-PRD-审查与决策汇总-已决策.md` | **综合版审查 + 决策文档**，统一记录 Q-01 ～ Q-19 的问题背景、可选方案与最终决策及落地位置 | **使用中（决策与 PRD 路由索引）** |

> 后续工作如涉及需求调整或新增问题，建议只维护：
> - 主 PRD：《passport-统一认证中心-PRD-草稿.md》（标题已标注 V1 已决策）
> - 审查与决策综合文档：《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》

---

## 2. 核心产品目标与范围（快速回顾）

> 详细内容以主 PRD 为准，这里只做高层速记。

- **整体定位**：
  - 为九尾狐、游利社等 Windows 客户端提供统一的 Passport 认证中心，实现 **统一身份（GUID）+ 手机号登录 + Token 管理 + 跨客户端 SSO + 网吧安全适配**。

- **关键目标（摘自 PRD 1.3）**：
  - G-01：为所有 C 端用户生成全局唯一 GUID，跨产品通用、手机号变更不变更 GUID。
  - G-02：同一台设备 / 同一 Windows 用户下，在 Refresh Token 2 天生命周期内，九尾狐与游利社之间支持免二次登录的跨客户端 SSO。
  - G-03：提供符合最小安全要求的 Token 能力（字段规范、HTTPS、过期时间、app_id 绑定与校验）。
  - G-04：针对网吧场景，结合系统清理临时目录 + 客户端基于 2 小时创建时间阈值强制删除 session.dat，实现下机后不串号。

- **当前版本范围**：
  - 本期只支持九尾狐、游利社两个 Windows 客户端接入 Passport；其他客户端仅做架构预留，不在 V1 范围内。

---

## 3. Q-01 ～ Q-19 决策使用指引（简版）

> 完整论证与详细决策请见：《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》。以下仅列出对研发 / 测试影响最大的决策点。

1. **SSO 有效期与客户端范围（Q-01，方案 A）**  
   - SSO 有效期 = Refresh Token 生命周期（2 天）；  
   - 同一 Windows 用户下，九尾狐 / 游利社可在 2 天内通过本地会话文件免二次登录。

2. **Token 安全约束（Q-02，方案 A）**  
   - Token 必须包含 `guid`、`user_type`、`account_source`、`app_id`；  
   - 所有 Token 接口必须走 HTTPS；  
   - Access Token 固定 4 小时，Refresh Token 固定 2 天且不续期；  
   - 验证 Token 时必须校验 `app_id` 与调用方一致。

3. **本地文件双重安全机制（Q-03、Q-05、Q-07、Q-08、Q-12）**  
   - Temp 下的 `tokens.dat` 等短期 Token 文件依赖 Windows 注销自动清理；  
   - `C:\ProgramData\Passport\session.dat`：
     - 由客户端负责维护和清理；
     - 每次读取时必须通过结构级完整性校验（必填字段 + 时间关系），否则删除并要求重登；
     - 客户端启动时，如发现 `created_at` 超过 2 小时，即强制删除，防异常残留；
     - `expires_at = created_at + 2 天`，与 Refresh Token 生命周期一致。

4. **Token 刷新与退出体验（Q-09、Q-10）**  
   - 刷新策略：从登录成功或上一次刷新成功时起，每 3 小时发起刷新请求，可加入 0～10 分钟随机抖动；失败时 5 分钟内最多重试 2 次。  
   - 退出入口：统一位置（如右上角头像菜单），在任何已登录页面用户需在不超过 2 次点击内即可退出。

5. **用户状态与封禁逻辑（Q-11、Q-19）**  
   - User.status 统一为 int：`1=正常，0=封禁，-1=注销/删除`；  
   - 封禁 = 立即全局失效：
     - 服务端立即删除 Redis 会话 `session:{guid}`；
     - 客户端在收到封禁错误码后，应删除本地 session.dat，清空内存 Token，并返回登录页；
     - 任何应用后续访问均需重新登录。

6. **监控与性能（Q-15、Q-17）**  
   - 为本地 SSO 登录设定 P95 耗时绝对阈值 T（在性能方案中确定）；  
   - 最小监控集包括：登录成功率、登录错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、Passport 接口整体错误率等。

7. **账号串用防护与验收（Q-18）**  
   - “账号串用”定义：在未经过当前用户手机号 + 验证码登录的前提下，客户端直接进入上一用户的账号会话（典型如网吧 A 用户下机后，B 用户一打开客户端就进 A 账号）。  
   - 验收：在 AC-02 中要求覆盖上述场景，确保在网吧 / 共享设备上不会发生串号。

8. **后台角色与操作边界（Q-16）**  
   - 建议预置 3 类后台角色：运营 / 客服 / 技术支持；
   - 仅运营可执行封禁 / 解封操作，客服与技术支持只能查看数据和日志，防止越权。

---

## 4. 后续维护建议

1. **修改需求或新增问题时**：
   - 在《passport-统一认证中心-PRD-草稿.md》（V1 已决策 PRD）中更新对应章节；
   - 在《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》中新增 Q-20、Q-21… 等问题条目及决策记录；
   - 本《会话关键内容整理》仅在核心目标 / 范围 / 使用方式发生明显调整时更新一次即可。

2. **对接新成员时**（例如新同事接手 Passport）：
   - 首先阅读本文件，了解整体目标与文档结构；
   - 然后进入主 PRD 具体章节（需求、流程、数据模型、API 等）；
   - 如对某个表述存在疑问，可在“审查与决策汇总”中按 Q-xx 查找当时的讨论与取舍理由。

# Passport 统一认证中心 - 测试用例（Dev Plan 对齐版 v1.1）

> 基线需求：`passport-统一认证中心-PRD-草稿.md`（V1 多视图对齐版，v1.1，SSoT）  
> 基线开发计划：`passport-统一认证中心-开发计划.md`（AUTH-01 / SSO-02 / SESS-03 / ADMIN-04 模块，Cycle1～Cycle29）

本文档按 **Epic → Story → FL → Cycle** 的层级输出测试用例，覆盖：

- US-01～US-05 全部用户故事；
- FL-01～FL-05 + 规划内 FL-06/FL-07 全部功能流程；
- BR-01～BR-09、ERR 13.1～13.3 的主要分支；
- 10、11、12 章中与 V1 实现强相关的 NFR / 权限 / 日志与监控约束。

每个用例给出：用例 ID、关联 Story/FL/Cycle、前置条件、步骤、预期结果。

---

## 1. 用例命名与结构约定

- 用例 ID 格式：`TC-<MOD>-<FL>-<序号>`，例如：`TC-AUTH-FL01-001`
  - MOD ∈ {AUTH, SSO, SESS, ADMIN}
  - FL 对应 PRD/Dev Plan 中的 FL-01～FL-07
- 每个用例至少包含：
  - 关联 Story / FL / Cycle（只列主要 Cycle，非穷举）；
  - 前置条件；
  - 测试步骤；
  - 预期结果（含关键断言）。

---

## 2. AUTH-01 身份认证与登录注册模块

### 2.1 FL-01 手机号登录/注册流程（Cycle1/2/3）

#### TC-AUTH-FL01-001 已有用户正常登录

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01 |
| 关联 Cycle | Cycle1（FE）、Cycle2（BE）、Cycle3（QA） |
| 前置条件 | 1）User 表中存在手机号 `P1`，`status=1`，已分配 GUID；2）验证码发送与缓存（API-01/BR-09）已正确配置，`P1` 可接收验证码；3）Redis/DB 正常。 |
| 测试步骤 | 1）在客户端输入手机号 `P1`；2）点击“获取验证码”，输入收到的 6 位验证码；3）勾选用户协议；4）点击“登录”；5）观察前端跳转与后端日志/DB。 |
| 预期结果 | 1）前端调用 API-02 返回 200，`data.guid` 等于 User 表中已有 GUID；2）不创建新的 User 记录；3）Redis 中创建 `session:{guid}`，包含 Refresh Token 和当前 app 的 Access Token；4）前端进入登录态，全局状态中包含 `guid`/`access_token`/`refresh_token`。 |

#### TC-AUTH-FL01-002 新用户注册 + 登录

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01 |
| 关联 Cycle | Cycle1、Cycle2、Cycle3 |
| 前置条件 | 1）User 表中不存在手机号 `P2`；2）`P2` 可接收验证码。 |
| 测试步骤 | 1）输入手机号 `P2`，获取验证码并输入；2）同意协议并登录；3）查询 User 表与 Redis。 |
| 预期结果 | 1）User 表新增一条记录，生成 20 位 GUID，格式符合 BR-01；2）API-02 返回 200，`data.guid` 为新 GUID；3）Redis 创建对应会话；4）前端自动进入登录态。 |

#### TC-AUTH-FL01-003 封禁用户尝试登录

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01；[ADMIN-04][US-05]，FL-06（封禁） |
| 关联 Cycle | Cycle2（BE 登录）、Cycle19（会话销毁）、Cycle25/26（封禁逻辑）、Cycle3（QA） |
| 前置条件 | 1）用户 `U3` 的手机号 `P3` 已存在，`status=0`（封禁）；2）Redis 中无 `session:{guid}` 会话。 |
| 测试步骤 | 1）使用手机号 `P3` 正常获取验证码并输入；2）点击登录。 |
| 预期结果 | 1）API-02 返回 HTTP 403，错误码 `ERR_USER_BANNED`；2）不签发任何 Token，不创建/更新 Redis 会话；3）前端展示封禁提示，保持未登录状态；4）后台用户信息表中仍为封禁状态。 |

#### TC-AUTH-FL01-004 注销用户重新登录生成新 GUID

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01；C-01 决策 |
| 关联 Cycle | Cycle2、Cycle3 |
| 前置条件 | 1）历史用户 `U4` 手机号 `P4` 存在，`status=-1`（注销/删除），有旧 GUID `G_old`；2）Redis 中无旧会话。 |
| 测试步骤 | 1）使用 `P4` 正常获取验证码并输入；2）点击登录；3）检查 User 表、Redis 与返回数据。 |
| 预期结果 | 1）系统按照“新用户”逻辑创建新的 User 记录，生成新 GUID `G_new`；2）`G_new != G_old`，旧记录保留但不再参与登录；3）Redis 中仅存在 `G_new` 会话；4）前端使用新 GUID 进入登录态。 |

#### TC-AUTH-FL01-005 验证码错误/过期/频率限制

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01/FL-06；BR-09、ERR 13.1 |
| 关联 Cycle | Cycle1、Cycle2、Cycle21～23 |
| 前置条件 | 1）短信发送流程可控（可生成特定验证码与过期时间）；2）可调整频率限制配置。 |
| 测试步骤 | 1）对同一手机号 `P5`：<br>  a）发送验证码后输入错误验证码；<br>  b）等待验证码超过 5 分钟后再使用原验证码；<br>  c）在短时间内多次点击“获取验证码”，触发频率限制。 |
| 预期结果 | 1）错误验证码登录：API-02 返回 `ERR_CODE_INVALID`，不创建会话；2）过期验证码登录：返回 `ERR_CODE_EXPIRED`；3）频率限制：API-01 返回 `ERR_CODE_TOO_FREQUENT`，前端禁用按钮并提示冷却时间；4）任何错误场景前端保持未登录状态。 |

#### TC-AUTH-FL01-006 登录行为写入 LoginLog（DM-04）

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-01；[ADMIN-04][US-05]，FL-07；DM-04 |
| 关联 Cycle | Cycle3（登录 E2E QA）、Cycle28/29（活跃记录与监控） |
| 前置条件 | 1）LoginLog 表已按照 DM-04 建表；2）清空或记录当前 LoginLog 条数基线；3）保证本次测试环境中仅执行本用例触发的登录。 |
| 测试步骤 | 1）执行一次“已有用户正常登录”（参考 TC-AUTH-FL01-001）；2）登录完成后查询 LoginLog 表，按手机号/时间区间过滤；3）在后台活跃表页面查看对应记录。 |
| 预期结果 | 1）LoginLog 新增一条记录，字段包括 GUID、手机号、用户类型、登录渠道、登录时间等，符合 DM-04；2）退出时间在未退出前为 NULL，前端展示为“暂无数据”；3）后台活跃表中可通过相同过滤条件查询到这条记录。 |

---

### 2.2 FL-02 Token 刷新流程（Cycle4/5/6/7）

#### TC-AUTH-FL02-001 正常定时刷新 Access Token

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-02；C-03（2 天 + 2 小时组合） |
| 关联 Cycle | Cycle4（FE）、Cycle5（SH）、Cycle6（BE）、Cycle7（QA） |
| 前置条件 | 1）用户已登录，持有有效 Refresh Token，Redis 中存在 `session:{guid}`；2）壳层刷新调度已开启。 |
| 测试步骤 | 1）记录当前 Access Token `AT1` 的过期时间；2）模拟时间推移至 3 小时 + 随机抖动后；3）观察壳层是否调用 API-03；4）确认前端在不刷新页面的情况下仍保持登录态。 |
| 预期结果 | 1）壳层按约定周期调用 API-03，服务端返回新的 Access Token `AT2`；2）Redis 中该 app 的 `access_token` 更新为 `AT2`，过期时间延后 4 小时；3）前端使用 `AT2` 调用接口成功；4）客户端不会频繁刷新（周期与抖动符合设计）。 |

#### TC-AUTH-FL02-002 Refresh Token 过期

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-02 |
| 关联 Cycle | Cycle4、Cycle5、Cycle6、Cycle7 |
| 前置条件 | 1）构造一个 Refresh Token，其签发时间已超过 2 天；2）Redis 中 session 仍存在，但 `refresh_token_expires_at` 已过期。 |
| 测试步骤 | 1）触发壳层自动刷新或手动调用 API-03；2）观察 API 返回。 |
| 预期结果 | 1）API-03 返回 HTTP 401，错误码 `ERR_REFRESH_EXPIRED`；2）壳层向前端发送“会话过期”事件；3）前端清理登录态并跳转登录页；4）登录成功率监控不将此视为系统错误，而是正常过期。 |

#### TC-AUTH-FL02-003 Refresh Token 不匹配/伪造

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-02，BR-04 |
| 关联 Cycle | Cycle4、Cycle5、Cycle6、Cycle7 |
| 前置条件 | 1）准备一个与 Redis 中记录不一致的 Refresh Token（伪造或旧 Token）；2）GUID 与 app_id 有效。 |
| 测试步骤 | 1）使用伪造/旧 Refresh Token 调用 API-03；2）观察 API 响应与日志。 |
| 预期结果 | 1）API-03 返回 HTTP 401，`ERR_REFRESH_MISMATCH`；2）后端日志记录详细信息（不含敏感 Token 内容）；3）壳层/前端按“会话失效”处理，提示重新登录。 |

#### TC-AUTH-FL02-004 Redis 故障时刷新行为（C-02）

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-02；NFR 10.2；C-02 决策 |
| 关联 Cycle | Cycle5、Cycle6、Cycle7、Cycle28/29（监控） |
| 前置条件 | 1）模拟 Redis 不可用（网络断开/服务停止）；2）用户本地仍持有 Refresh Token。 |
| 测试步骤 | 1）等待壳层触发自动刷新；2）观察 API-03 调用结果与前端行为；3）检查监控与日志。 |
| 预期结果 | 1）API-03 返回统一错误（例如 503 或 500，对应内部错误码），不放行任何刷新；2）壳层/前端向用户展示“稍后重试”类提示，并清晰区分与正常过期的场景；3）监控中 Redis 会话错误率明显上升并触发告警。 |

---

### 2.3 FL-03 Token 验证流程（Cycle8/9/10）

#### TC-AUTH-FL03-001 有效 Access Token 验证通过

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-03 |
| 关联 Cycle | Cycle8、Cycle9、Cycle10 |
| 前置条件 | 1）用户已登录，持有未过期的 Access Token；2）Redis 中 session 一致。 |
| 测试步骤 | 1）调用 API-04 `/verify-token`；2）使用同一 Token 调用一个示例业务接口。 |
| 预期结果 | 1）API-04 返回 `valid=true`，带 GUID 与过期时间；2）业务接口成功返回，未触发 401/403。 |

#### TC-AUTH-FL03-002 Access Token 过期

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-03 |
| 关联 Cycle | Cycle8、Cycle9、Cycle10 |
| 前置条件 | 1）构造一个 Access Token，其签发时间已超过 4 小时；2）Refresh Token 仍有效。 |
| 测试步骤 | 1）调用 API-04 ；2）调用业务接口。 |
| 预期结果 | 1）API-04 返回 401，错误码 `ERR_ACCESS_EXPIRED`；2）业务接口返回同样错误；3）前端拦截后自动触发刷新的流程（联动 FL-02）；4）监控中“登录错误率/Token 刷新失败率”反映此情况。 |

#### TC-AUTH-FL03-003 Token 签名错误 / 伪造

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-03 |
| 关联 Cycle | Cycle8、Cycle9、Cycle10 |
| 前置条件 | 1）手工构造一个被篡改的 Access Token（JWT payload 或 signature 被改）；2）Redis 中无该 Token 记录。 |
| 测试步骤 | 1）调用 API-04 ；2）调用业务接口。 |
| 预期结果 | 1）API-04 返回 401，错误码 `ERR_ACCESS_INVALID`；2）后端日志记录签名校验失败；3）前端提示“登录状态已失效，请重新登录”。 |

#### TC-AUTH-FL03-004 app_id 不匹配

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [AUTH-01][US-01]，FL-03；BR-05 |
| 关联 Cycle | Cycle8、Cycle9、Cycle10 |
| 前置条件 | 1）使用为 app_id="jiuweihu" 签发的 Token，从 "youlishe" 客户端发起请求；2）服务端正确识别调用方 app_id。 |
| 测试步骤 | 1）调用 API-04 / 业务接口时，传入 Token 与不匹配的 app_id。 |
| 预期结果 | 1）API-04/业务接口返回 403，错误码 `ERR_APP_ID_MISMATCH`；2）前端展示“无权限访问”或类似信息，而非“未登录”。 |

---

## 3. SSO-02 跨客户端 SSO 与本地会话模块

### 3.1 FL-04 跨客户端 SSO 流程（Cycle11～15）

#### TC-SSO-FL04-001 正常跨客户端自动登录

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04 |
| 关联 Cycle | Cycle11（FE）、Cycle12（SH）、Cycle13（NM）、Cycle14（BE）、Cycle15（QA） |
| 前置条件 | 1）用户在九尾狐客户端成功登录，已写入合法 `session.dat`；2）在同一 Windows 用户环境下安装游利社客户端；3）Refresh Token 未过期，`created_at` 未超过 2 小时。 |
| 测试步骤 | 1）关闭九尾狐客户端（不退出登录）；2）启动游利社客户端；3）观察游利社启动时 SSO 行为。 |
| 预期结果 | 1）壳层在启动时调用原生模块读取 `session.dat`，通过完整性与 2 小时阈值校验；2）壳层向前端发送 `session.status="sso_available"`；3）前端自动调用刷新接口获取自身 Access Token 并进入登录态；4）整个过程用户无需输入验证码。 |

#### TC-SSO-FL04-002 LocalSession 缺失

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04 |
| 关联 Cycle | Cycle11～Cycle15 |
| 前置条件 | 1）删除 `C:\ProgramData\Passport\session.dat` 文件或确保从未写入；2）用户上次登录仅留下 Redis 会话但无本地文件。 |
| 测试步骤 | 1）启动任一 Passport 集成客户端；2）观察启动行为。 |
| 预期结果 | 1）原生模块返回 `ERR_SESSION_NOT_FOUND`；2）壳层将其视为“无本地会话”，发送 `session.status="none"`；3）前端直接展示登录页，不触发自动登录。 |

#### TC-SSO-FL04-003 LocalSession 损坏/字段不完整

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04；BR-06；ERR 13.3 |
| 关联 Cycle | Cycle12、Cycle13、Cycle15 |
| 前置条件 | 1）手工修改 `session.dat` 使其 JSON 非法或缺少必填字段（如缺失 `guid`/`created_at` 等）；2）保持文件可读。 |
| 测试步骤 | 1）启动客户端；2）观察原生模块与壳层、前端行为。 |
| 预期结果 | 1）原生模块在 `read_session_file()` 中返回 `ERR_SESSION_CORRUPTED`；2）壳层删除 `session.dat` 并发送 `session.status="none"`；3）前端展示登录页，不尝试自动登录；4）日志中记录有“会话文件损坏”信息。 |

#### TC-SSO-FL04-004 LocalSession 超过 2 小时阈值但 Token 仍在有效期内

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04；C-03 决策 |
| 关联 Cycle | Cycle12、Cycle13、Cycle15 |
| 前置条件 | 1）构造 `session.dat`，`created_at` 距当前时间 > 2 小时但 < 2 天；2）Refresh Token 仍有效；3）文件结构完整。 |
| 测试步骤 | 1）启动客户端；2）观察是否进行 SSO。 |
| 预期结果 | 1）壳层在启动时根据 `created_at` 判断超过 2 小时阈值，删除 `session.dat`；2）前端展示登录页；3）Redis 会话不被删除，仅本地文件清除；4）避免网吧场景中“长时间残留”的自动登录。 |

#### TC-SSO-FL04-005 多应用 SSO 与 Token 隔离

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04；DM-02 apps 子结构 |
| 关联 Cycle | Cycle11～Cycle14 |
| 前置条件 | 1）用户在九尾狐先登录，再在游利社通过 SSO 登录；2）Redis 的 `apps` 结构中存在两个 app_id 的子节点。 |
| 测试步骤 | 1）在九尾狐中调用某业务接口，确认成功；2）在游利社中调用对应业务接口，确认成功；3）从其中一个客户端退出登录；4）再次调用两个客户端业务接口。 |
| 预期结果 | 1）两个 app 在 Redis 中分别维护自己的 Access Token 与 last_active_at；2）退出某一客户端（如游利社）时，根据 PRD 设计要么全局退出（若实现为全局退出），要么仅影响自身会话（如后续版本限定）；3）在当前 V1 设计下，“退出 = 全局退出”，两端都应被登出。 |

#### TC-SSO-FL04-006 SSO 启动性能 P95 验证

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04；NFR 10.1（本地 SSO 性能） |
| 关联 Cycle | Cycle11～Cycle15（尤其 Cycle15 QA） |
| 前置条件 | 1）在性能测试环境中部署九尾狐/游利社客户端，关闭调试日志与非必要监控；2）实现客户端埋点，记录“启动客户端到自动完成登录”耗时；3）准备足量代表性机器样本。 |
| 测试步骤 | 1）在每台测试机上多次执行 SSO 启动场景（参考 TC-SSO-FL04-001），每次记录“启动→进入登录态”的耗时；2）收集所有样本耗时数据，计算 P50/P90/P95；3）与性能目标 T 进行对比。 |
| 预期结果 | 1）在标准测试环境下，本地 SSO 启动到自动登录的 P95 耗时小于性能方案中设定的目标值 T ms；2）与“纯远程校验方案”的耗时对比中，本地 SSO 方案显著优于后者；3）如 P95 超出 T，记录问题并反馈到性能优化任务中。 |

#### TC-SSO-FL04-007 DPAPI/ACL 异常降级行为验证

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SSO-02][US-02]，FL-04；BR-06；RISK-03（本地文件/DPAPI 失败） |
| 关联 Cycle | Cycle12、Cycle13、Cycle15、Cycle17、Cycle18 |
| 前置条件 | 1）在测试环境中人为制造 DPAPI 调用失败（如使用无效密钥容器）或修改 `C:\ProgramData\Passport` 目录权限使当前用户无写权限；2）确保网络与后端服务正常。 |
| 测试步骤 | 1）尝试在异常环境下完成一次正常登录；2）观察登录是否仍然成功以及本地是否写入 `session.dat`；3）重启客户端，观察是否仍然尝试 SSO；4）检查日志中对 DPAPI/ACL 异常的记录。 |
| 预期结果 | 1）在 DPAPI/文件权限异常情况下，用户仍可完成在线登录（不依赖本地 SSO 文件）；2）`session.dat` 写入失败时系统不会反复重试导致崩溃，而是记录错误并禁用本地 SSO，后续启动不再尝试读取损坏环境下的 LocalSession；3）日志中有清晰的错误记录，便于排查问题。 |

---

## 4. SESS-03 会话管理与退出/封禁联动模块（FL-05）

#### TC-SESS-FL05-001 单客户端退出登录全局生效

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SESS-03][US-04]，FL-05；BR-07 |
| 关联 Cycle | Cycle16～Cycle20 |
| 前置条件 | 1）用户在九尾狐和游利社都处于登录态（共用同一 GUID）；2）Redis 中存在对应会话。 |
| 测试步骤 | 1）在九尾狐客户端点击“退出登录”；2）在游利社客户端尝试调用业务接口；3）刷新两个客户端界面。 |
| 预期结果 | 1）退出操作调用 API-05 成功、返回 200；2）Redis 中不再存在 `session:{guid}`；3）游利社调用业务接口返回 401/ERR_ACCESS_EXPIRED 或类似未登录错误；4）两个客户端 UI 都回到登录页面。 |

#### TC-SESS-FL05-002 双重退出（幂等性）

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SESS-03][US-04]，FL-05 |
| 关联 Cycle | Cycle16、Cycle17、Cycle19、Cycle20 |
| 前置条件 | 1）用户登录成功后立即进行多次退出操作（例如同一客户端重复点击退出按钮或多客户端同时触发）。 |
| 测试步骤 | 1）短时间内多次触发退出请求；2）观察后端响应与 Redis 状态。 |
| 预期结果 | 1）多次调用退出接口均返回 200 或幂等成功标记；2）Redis 中 session 最终处于“不存在”状态，无报错堆栈；3）客户端不会因多次退出而进入错误状态。 |

#### TC-SESS-FL05-003 封禁与退出并发

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SESS-03][US-04]，FL-05；BR-08；C-01/C-05 |
| 关联 Cycle | Cycle16～Cycle20、Cycle25/26 |
| 前置条件 | 1）用户在客户端登录；2）后台运营可操作封禁；3）测试环境允许并发操作。 |
| 测试步骤 | 1）在客户端点击退出的同时，后台对该用户执行封禁操作（可以通过脚本/工具尽量同时发起）；2）观察 Redis 中 session、User.status 与前端行为。 |
| 预期结果 | 1）最终 Redis 中不存在该 GUID 的 session，User.status=0；2）客户端处于未登录状态，再次尝试登录返回 `ERR_USER_BANNED`；3）日志中无数据不一致或异常堆栈。 |

#### TC-SESS-FL05-004 退出/封禁行为写入 LoginLog

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [SESS-03][US-04]，FL-05；[ADMIN-04][US-05]，FL-07；DM-04 |
| 关联 Cycle | Cycle20（退出/封禁 QA）、Cycle28/29（活跃记录与监控） |
| 前置条件 | 1）LoginLog 中已有用户某次登录记录，`logout_time` 为 NULL；2）运营账号可在后台封禁/解封；3）已配置好活跃表查询与导出功能。 |
| 测试步骤 | 1）对已登录用户执行“退出登录”（或后台封禁）；2）查询 LoginLog 表中对应登录记录；3）在后台活跃表中按手机号/时间过滤查看记录；4）如有导出功能，导出当前筛选结果。 |
| 预期结果 | 1）退出/封禁后，对应 LoginLog 记录的 `logout_time` 更新为合理值（退出时间或最后心跳时间）；2）后台活跃表中展示的退出时间与 LoginLog 一致；3）导出的 CSV 中字段与数据库记录完全匹配；4）不会出现“用户前台已退出，但后台一直显示未退出”的情况。 |

---

## 5. ADMIN-04 后台管理与用户活跃分析模块（FL-06/FL-07）

### 5.1 FL-06 后台用户信息查询与封禁流程（Cycle24～26）

#### TC-ADMIN-FL06-001 后台按手机号与来源查询用户信息

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [ADMIN-04][US-05]，FL-06 |
| 关联 Cycle | Cycle24、Cycle25、Cycle26 |
| 前置条件 | 1）准备多条用户数据，手机号/来源不同；2）运营/客服账号已开通后台访问权限。 |
| 测试步骤 | 1）使用运营账号登录后台；2）在用户信息表输入手机号关键字进行模糊搜索；3）切换账户来源筛选；4）对比返回结果。 |
| 预期结果 | 1）返回结果仅包含匹配手机号关键字的用户；2）按不同来源筛选时，列表内容正确过滤；3）分页与总数显示正确。 |

#### TC-ADMIN-FL06-002 运营封禁/解封用户并验证前台行为

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [ADMIN-04][US-05]，FL-06；BR-08；[SESS-03][US-04] |
| 关联 Cycle | Cycle24～Cycle26、Cycle19、Cycle20 |
| 前置条件 | 1）存在状态为“正常”的用户 U1，并已在客户端登录；2）运营账号已登录后台。 |
| 测试步骤 | 1）在后台用户信息表中对 U1 执行“封禁”；2）观察 Redis 会话与客户端行为；3）在后台对 U1 执行“解封”，再次尝试登录。 |
| 预期结果 | 1）封禁后 User.status=0，Redis 中 session 被删除；2）客户端后续请求返回 `ERR_USER_BANNED` 并退回登录页；3）解封后用户可重新登录，User.status=1。 |

#### TC-ADMIN-FL06-003 权限越权校验（客服/技术支持）

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [ADMIN-04][US-05]，FL-06；PRD 11 章权限矩阵 |
| 关联 Cycle | Cycle25、Cycle26 |
| 前置条件 | 1）创建客服账号与技术支持账号；2）授予只读权限。 |
| 测试步骤 | 1）使用客服/技术支持账号登录后台；2）尝试访问用户信息表并执行封禁/解封操作。 |
| 预期结果 | 1）客服/技术支持账号可以查看用户详情和活跃记录；2）封禁/解封按钮在 UI 上不可见或操作后返回 403/ERR_FORBIDDEN；3）审计日志中记录越权尝试（如有）。 |

### 5.2 FL-07 后台活跃记录查询与导出流程（Cycle27～29）

#### TC-ADMIN-FL07-001 活跃记录查询与分页

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [ADMIN-04][US-05]，FL-07；DM-04 |
| 关联 Cycle | Cycle27、Cycle28、Cycle29 |
| 前置条件 | 1）LoginLog 中存在足够多记录，包含不同手机号、时间段与渠道；2）运营账号已登录后台。 |
| 测试步骤 | 1）在后台活跃表页面按手机号、时间区间、登录渠道进行多次组合查询；2）检查结果列表与分页。 |
| 预期结果 | 1）查询结果匹配筛选条件（字段值与 DM-04 一致）；2）分页信息（总数、当前页、页大小）正确；3）退出时间为 NULL 时，前端展示为“暂无数据”。 |

#### TC-ADMIN-FL07-002 活跃记录导出与行数限制

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | [ADMIN-04][US-05]，FL-07 |
| 关联 Cycle | Cycle27、Cycle28、Cycle29 |
| 前置条件 | 1）LoginLog 中构造满足导出条件的数据集，包含少量与超量两种情况；2）浏览器/客户端支持文件下载。 |
| 测试步骤 | 1）在筛选条件较小（结果行数 < 1 万）的情况下执行导出；2）在筛选条件较大（预期 > 10 万）的情况下执行导出。 |
| 预期结果 | 1）小结果集导出成功，文件格式与字段顺序正确；2）超大结果集导出被拒绝或提示用户缩小筛选范围，不会导致接口超时；3）日志中记录导出操作与是否超限。 |

#### TC-ADMIN-FL07-003 监控指标上报验证

| 字段 | 内容 |
|------|------|
| 关联 Story/FL | NFR 10.2、12.2；[AUTH-01]/[SSO-02]/[SESS-03] 相关 FL；ADMIN-04 FL-07 |
| 关联 Cycle | Cycle3、Cycle7、Cycle10、Cycle15、Cycle20、Cycle28、Cycle29 |
| 前置条件 | 1）监控平台已配置 Passport 的关键指标；2）具有查看监控的权限。 |
| 测试步骤 | 1）在测试环境中执行一系列登录成功/失败、验证码发送失败、Token 刷新失败、Redis 故障等场景；2）等待指标上报周期完成；3）在监控平台查看对应指标。 |
| 预期结果 | 1）登录成功率、登录错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口整体错误率等指标可查询；2）各指标的计数/比例与实际模拟场景数据相符；3）配置的告警规则在阈值被触发时如期告警（如有配置）。 |

---

## 6. 迁移与架构风险说明（非本次实现范围）

- PRD 第 14 章《兼容性 & 迁移》与 C-06 明确：迁移策略（老用户 GUID 生成/映射、历史数据迁移）由独立迁移方案文档负责，本开发计划与测试用例**不覆盖迁移落地**；若后续迁移需求落地，需要单独补充迁移测试计划。  
- PRD 中关于 Redis 高可用与多机部署一致性（C-07）归属于架构/运维设计文档，当前用例只验证业务语义（退出=全局退出、封禁后不得再登录）在单 Redis 实例上的行为；如架构方案落地后需增加 HA 场景测试用例。  

---

## 7. 覆盖性总结

- **US 覆盖**：US-01～US-05 均有对应 Story 和用例；US-03/US-05 通过组合 FL（SSO + 会话、后台查询/导出）覆盖；  
- **FL 覆盖**：
  - PRD 已定义 FL-01～FL-05 全部有对应功能与测试用例；
  - 规划内后台/验证码流程 FL-06/FL-07 在本测试文档中已有用例集；
- **BR/ERR 覆盖**：
  - BR-01～BR-09 的正/反向路径均至少有一条测试用例（其中 BR-09 对应 TC-AUTH-FL01-005/TC-AUTH-FL06 系列）；
  - ERR 13.1～13.3 的主要错误码在登录/刷新/验证/本地会话中均有覆盖；
- **NFR & 监控**：
  - 性能：通过 SSO 场景的耗时测试（可在 TC-SSO-FL04 组中扩展）验证 P95 目标；
  - 监控与日志：TC-ADMIN-FL07-003 对关键指标上报进行验证。  

整体上，本测试用例文档与开发计划、PRD 一致，可作为 V1 开发完成后的系统测试与回归基线。 

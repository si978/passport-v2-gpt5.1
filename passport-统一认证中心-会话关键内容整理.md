# Passport 统一认证中心 - 会话关键内容整理（多视图已决策版 v1.1，历史整理）

> 目的：本文件面向后续接手的产品 / 研发 / 测试 / 架构同学，梳理多视图审查阶段已经产出的**核心文档、关键决策与使用方式**，作为深入理解 Q-xx / C-xx 与各工程视图关系的详尽索引。已覆盖：
> - PRD 从 v0.1 初稿 → v1.0（Q-01～Q-19 已决策版）→ v1.1（V1 多视图对齐 & C-01～C-07 已决策）；
> - 六个工程视图文档；
> - 产品层 Q-xx 与工程层 C-xx 的决策归档关系。

> 说明：进入开发阶段时，**推荐优先阅读《passport-统一认证中心-会话关键内容整理-开发入口.md》** 作为工作入口；本文件保留为 v1.1 多视图审查收敛后的详细历史整理，用于追溯背景与过程。

---

## 0. 适用范围

- **适用 PRD 版本**：`Passport 统一认证中心 - PRD（V1 多视图对齐版）`（v1.1，文件：`passport-统一认证中心-PRD-草稿.md`）
- **已合入的决策范围**：
  - 产品 / 业务层：Q-01 ～ Q-19（见《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》）；
  - 工程 / 架构层：C-01 ～ C-07（见《passport-统一认证中心-多视图冲突与决策清单-已决策.md》）。
- **历史快照**：如需查看仅对应 PRD v1.0（仅含 Q-xx、未合入 C-xx）的旧版整理，请参考第 6 章《历史快照索引》。

---

## 1. 文档总览与角色分工

> 日常只需要牢牢记住 3 个“入口文档” + 2 个“决策文档”，其余都视为支撑材料或历史记录。

### 1.1 主入口文档（强烈建议收藏）

| 序号 | 文件名 | 角色定位 | 当前状态 |
| ---- | ------ | -------- | -------- |
| 1 | `passport-统一认证中心-PRD-草稿.md` | **主 PRD 文档**。标题为「Passport 统一认证中心 - PRD（V1 多视图对齐版）」；版本号 v1.1，已合并产品审查 + 六个工程视图 + C-01～C-07 决策结果，是当前唯一规格 SSoT | **使用中：一切以此为准** |
| 2 | `passport-统一认证中心-PRD-审查与决策汇总-已决策.md` | 产品视角审查与决策文档：记录 Q-01 ～ Q-19 的问题背景、可选方案、最终决策以及在主 PRD 中的落点 | **使用中：业务 / 产品层决策索引（Q-xx）** |
| 3 | `passport-统一认证中心-多视图冲突与决策清单-已决策.md` | 多工程角色视角下的实现 / 架构冲突与决策清单，记录 C-01 ～ C-07 的最终决策及与 PRD 章节的映射 | **使用中：工程 / 架构层决策索引（C-xx）** |

### 1.2 支撑文档（按需查阅）

| 序号 | 文件名 | 说明 |
| ---- | ------ | ---- |
| 4 | `passport -PRD.md` | 原始零散需求文档（早期「passport统一认证中心 - 需求文档」导出），仅作追溯使用 |
| 5 | `PRD-model.md` | 通用 PRD 模板 / 框架，后续如需扩展模块可继续沿用该结构 |
| 6 | `passport-统一认证中心-PRD-审查待决策.md` | Q-01 ～ Q-19 最初的待决策清单与论证素材 | 历史归档 |
| 7 | `passport-统一认证中心-PRD-审查已决策.md` | 早期“已决策”摘要版，已被综合版替代 | 历史归档 |
| 8 | `passport-统一认证中心-PRD-修订片段草稿.md` | 选取 FL-04 / API-02 等片段的“改写前后对比”示例，便于理解多视图合并方式 | 按需参考 |
| 9 | `passport-统一认证中心-会话关键内容整理-历史v1.md` | 会话关键内容整理的 v1.0 历史快照，仅对应 PRD v1.0（V1 已决策版），不包含 C-01～C-07 多视图决策 | 历史归档 |

### 1.3 六个工程视图文档

> 这 6 份文档是从不同工程角色看同一 PRD 的补充说明，已被 v1.1 主 PRD 吸收了关键结论，但它们仍是技术 / 测试设计的重要参考。

| 视图 ID | 文件名 | 说明 |
| ------- | ------ | ---- |
| V-01 | `passport-统一认证中心-视图1-Web前端工程视图.md` | 前端关注的字段 / 接口契约 / 错误处理与交互约束 |
| V-02 | `passport-统一认证中心-视图2-客户端壳层工程视图.md` | 壳层关注的 IPC 协议、本地会话读写、刷新调度、退出广播等 |
| V-03 | `passport-统一认证中心-视图3-原生模块工程视图.md` | 原生模块接口设计（read/write/delete_session_file）、DPAPI 与错误码约定 |
| V-04 | `passport-统一认证中心-视图4-后端服务工程视图.md` | 接口边界、Redis 结构、会话状态机以及与管理后台的关系 |
| V-05 | `passport-统一认证中心-视图5-测试工程视图-QA.md` | 覆盖正常/异常/边界场景的测试用例框架（含网吧/串号等关键场景） |
| V-06 | `passport-统一认证中心-视图6-架构与产品合理性视图.md` | 性能、安全、部署、迁移等跨职能关注点与冲突收敛过程 |

---

## 2. PRD 版本演进（v0.1 → v1.0 → v1.1）

> 详细变更记录请见《passport-统一认证中心-PRD-草稿.md》“变更记录”表，这里做高层时间线速记。

- **v0.1 初稿**  
  - 从 `passport -PRD.md` 零散需求整理而来，结构对齐 `PRD-model.md` 模板（0～18 章），但存在大量“当前信息不足，需补充”。

- **v1.0 V1 已决策版（Q-01～Q-19）**  
  - 通过《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》中的 Q-01～Q-19，将模糊点一轮清理：
    - 明确 Token 字段、安全约束、SSO 有效期；
    - 固化本地文件 2 小时阈值、网吧下机行为定义；
    - 明确 User.status 枚举含义、封禁/解封规则等；
  - 当时主 PRD 标题为「V1 已决策」，侧重产品 / 后端视角。

- **v1.1 V1 多视图对齐版（含 C-01～C-07 决策）**  
  - 在 v1.0 基础上，合入 6 个工程视图的关键意见：
    - 新增 2.4「客户端分层说明」，明确 Web 前端 / 壳层 / 原生模块职责边界；
    - 丰富 BR-02/04/05/06/07/09 等业务规则，补全错误码、本地会话文件行为与退出幂等性；
    - 扩展 13 章错误码与 16 章风险，加入多视图共识；
  - 通过 C-01～C-07 收敛不同工程视角冲突，最终在 19 章「冲突与决策结果」中固化为决策摘要，并由：
    - 《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》（Q-xx），
    - 《passport-统一认证中心-多视图冲突与决策清单-已决策.md》（C-xx），
    提供完整追溯链路。

---

## 3. 决策总览：Q-01～Q-19（产品层）

> 详细问题背景 / 方案论证 / 在 PRD 中的落点：请以《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》为准。  
> 这里只列出工作中最常用的 8 类结论速查。

1. **SSO 有效期与范围（Q-01：方案 A）**  
   - SSO 有效期 = Refresh Token 生命周期 2 天；
   - 同一台机器、同一 Windows 用户下，九尾狐 / 游利社在 2 天内可通过本地会话文件互相自动登录。

2. **Token 安全约束（Q-02：方案 A）**  
   - Token 必须包含 `guid`、`user_type`、`account_source`、`app_id`；
   - 所有 Token 相关接口必须走 HTTPS；
   - Access Token 固定 4 小时，Refresh Token 固定 2 天且不续期；
   - 验证 Token 时必须校验 `app_id` 与调用方一致。

3. **本地会话文件策略（Q-03 / Q-05 / Q-07 / Q-08 / Q-12 等）**  
   - Temp 下短生命周期 Token 文件依赖 Windows 注销清理；
   - `C:\\ProgramData\\Passport\\session.dat`：
     - 使用 DPAPI 加密，仅当前 Windows 用户可解密；
     - 每次读取需做结构完整性与时间合法性校验，不合法视为损坏并删除；
     - 客户端启动时如 `created_at` 超过 2 小时，强制删除，防止网吧异常残留；
     - `expires_at = created_at + 2 天`，与 Refresh Token 生命周期对齐。

4. **Token 刷新与退出交互（Q-09 / Q-10）**  
   - 刷新：以登录成功或最近一次刷新成功时间为起点，每 ~3 小时（可加随机抖动）发起刷新，失败 5 分钟内最多重试 2 次；
   - 退出：所有已登录页面需在不超过 2 次点击内可触达“退出登录”，退出后全局会话失效。

5. **用户状态与封禁（Q-11 / Q-19）**  
   - User.status：`1=正常，0=封禁，-1=注销/删除`；
   - 封禁行为：立即删除 Redis 会话 `session:{guid}`，后续登录返回 `ERR_USER_BANNED`，客户端清理本地 session.dat 并退回登录页。

6. **监控与性能（Q-15 / Q-17）**  
   - 本地 SSO 登录需在性能方案中设定 P95 耗时阈值 T；
   - 监控至少覆盖：登录成功率、登录错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、Passport 接口整体错误率。

7. **账号串用防护（Q-18）**  
   - 串用定义：未经过当前用户手机号 + 验证码登录，客户端直接进入上一个用户的账号会话；
   - 验收：AC-02 中明确要求覆盖网吧 / 共享设备场景，验证不会发生串号。

8. **后台角色边界（Q-16）**  
   - 预置角色：运营 / 客服 / 技术支持；
   - 只有运营可执行封禁 / 解封，其余角色仅能查看数据和日志。

---

## 4. 决策总览：C-01～C-07（工程 & 架构层）

> 详细背景 / 替代方案 / 观点冲突：请见《passport-统一认证中心-多视图冲突与决策清单-已决策.md》。  
> 这里是每个 C-xx 最终结论的“工程语言版速记”。

1. **C-01：User.status = -1（注销/删除）登录行为 → 采纳方案 A**  
   - `status = -1` 的历史账号不会被重新激活；
   - 同手机号再次登录视为“新注册”，按手机号不存在流程新建 User + 新 GUID；
   - 旧记录保留用于审计与统计。  
   → 已落地到主 PRD BR-02。

2. **C-02：Redis 故障降级策略 → 采纳保守策略**  
   - Redis 不可用或严重异常时：登录 / 刷新 / 验证统一失败并提示“稍后重试”；
   - 禁止依赖本地 Token 直接放行；
   - 具体重试与告警细节由技术设计与运维方案补充。  
   → 已落地到主 PRD 10.2 / 16.2。

3. **C-03：SSO 有效期 2 天 vs 网吧安全 → V1 保持现状**  
   - V1：继续使用 Refresh Token 2 天 + LocalSession 2 小时阈值 + Temp 清理的组合；
   - “网吧模式 / 公共设备模式”等更进阶策略放入后续版本评估，不在 V1 落地。  
   → 已在主 PRD 1.3、BR-03、16 章中体现。

4. **C-04：多 Windows 用户切换下 LocalSession → 保持现状（实现侧解决）**  
   - PRD 不再追加条款，问题归类为“实现 & 安全评审”范围；
   - 要求在技术方案 / 测试计划中显式覆盖“多用户切换 / 远程桌面”等场景，对 DPAPI 与 ACL 配置做验证。  
   → 相关说明见 BR-06、FL-04、风险章节。

5. **C-05：`ERR_SESSION_NOT_FOUND` 双重语义 → 采纳方案 A（复用单一 code）**  
   - 继续使用同一错误码 `ERR_SESSION_NOT_FOUND` 覆盖：
     - 远端：Redis 无 `session:{guid}`；
     - 本地：`read_session_file()` 无 `session.dat`；
   - 要求在日志 & 监控侧至少按“接口名 / 子系统 / 调用方”等维度区分来源。  
   → 已落地到主 PRD 13.2 / 13.3 与 19 章。

6. **C-06：兼容性与迁移策略 → 保持现状（单独迁移文档负责）**  
   - PRD 14 章继续作为“迁移占位”，不直接写死迁移方案；
   - 迁移细节（老用户 GUID 生成 / 映射、历史数据迁移范围等）交由独立《Passport 统一认证中心 - 迁移方案》文档制定，成熟后再回填到 PRD 与本清单。

7. **C-07：Redis 高可用与多机一致性 → 保持现状（架构文档负责）**  
   - PRD 只约束业务语义：退出 = 全局退出、封禁后不得再登录、Token 刷新/验证/退出幂等等；
   - 具体 Redis HA 架构（单机 + 备份 / 哨兵 / Cluster）、主从切换策略与一致性保障机制归属架构 / 运维设计文档；
   - 如实施过程中发现需要产品级硬约束，再通过 PRD 版本升级补充。

---

## 5. 日常使用路径与变更建议

### 5.1 日常阅读顺序（给新接手同学）

1. 先读本文件，建立“有哪些文档 / 哪些决策 / 哪些视图”的全局认知；
2. 按需：
   - 做需求 / 评审：重点看《passport-统一认证中心-PRD-草稿.md》（v1.1）+ Q-xx 决策文档；
   - 做实现 / 设计：在看 PRD 的同时，结合相应的工程视图（V-01～V-06）和 C-xx 决策文档；
   - 做测试：以 QA 视图为起点，回溯 PRD / Q-xx / C-xx，补全用例。

### 5.2 变更流程建议

- **新增 / 修改需求**  
  - 在主 PRD 中更新对应章节，并在“变更记录”写明版本号与变更摘要；
  - 如有新的模糊点，先在《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》中追加 Q-20、Q-21… 的审查条目，再回填 PRD。

- **新增工程冲突 / 设计取舍**  
  - 继续沿用 C-xx 体系：在《passport-统一认证中心-多视图冲突与决策清单-已决策.md》中新增 C-08、C-09… 并说明各视角观点；
  - 待决策落地后，在主 PRD 中补充到对应 BR / NFR / 流程 / 数据模型章节，并在 19 章更新“冲突与决策结果”摘要。

- **会话关键内容整理的更新节奏**  
  - 本文件更多是“导航 / 路由器”，不需要每次小改动都更新；
  - 建议在以下节点更新：
    - PRD 升级大版本（如 v1.x → v2.0）；
    - 新增一批 Q-xx / C-xx 且影响理解路径时；
    - 新增关键工程视图或迁移 / 架构类核心文档时。

---

## 6. 历史快照索引

| 快照文档 | 对应 PRD 版本 | 覆盖决策范围 | 说明 |
| -------- | ------------- | ------------ | ---- |
| `passport-统一认证中心-会话关键内容整理-历史v1.md` | PRD v1.0（V1 已决策版） | Q-01 ～ Q-19 | 仅产品层决策；不含 C-01～C-07，多视图对齐前的会话整理快照 |


# Passport 统一认证中心 - 视图 2：客户端壳层工程视图（Electron/WebView2/CEF）

> 说明：本视图从客户端壳层（Electron 主进程 / WebView2 Host / CEF Browser 进程）角度审查《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版），对壳层实现中可能出现的歧义点进行标注。重点关注应用生命周期、窗口管理、IPC、与原生模块及后端的调用链。所有引用的 US/BR/FL 编号与主 PRD 保持一致。本视图仅作为工程实现视角的补充说明，如与主 PRD 存在任何不一致，应一律以主 PRD 为准。

---

## 1. 与壳层相关的 US / BR / FL 覆盖总览

| 类型 | ID   | 在主 PRD 中的位置              | 对壳层的相关性 | 视图结论 |
|------|------|--------------------------------|----------------|----------|
| US   | US-01 | 手机号登录/注册               | 中             | 壳层主要转发 HTTP/IPC，无重大歧义 |
| US   | US-02 | 跨客户端自动登录（SSO）       | 高             | SSO 检查时机与职责边界需细化 |
| US   | US-03 | 网吧下机后自动登出            | 高             | 下机后行为与启动清理策略需在壳层层面明确 |
| US   | US-04 | 用户主动退出登录               | 高             | 退出触发的本地清理由壳层负责，需要清晰接口 |
| US   | US-05 | 后台功能                       | 低             | 主要为 Web 管理端，与壳层弱关联 |
| BR   | BR-01~BR-03 | GUID/Token 基础规则     | 中             | 影响壳层是否缓存 Token/用户信息 |
| BR   | BR-04 | Token 刷新规则                 | 高             | 刷新调度是否由壳层统一掌握存在歧义 |
| BR   | BR-05 | Token 验证规则                 | 中             | 壳层大多透传到后端处理 |
| BR   | BR-06 | 本地会话文件读写与过期规则     | 高             | 壳层与原生模块接口需在文档层说明 |
| BR   | BR-07 | 会话 TTL 与全局退出规则        | 高             | 壳层应实现“退出 = 全局退出”的本地部分 |
| BR   | BR-08 | 管理后台封禁/解封规则          | 中             | 封禁时壳层如何接收/处理封禁信号尚未定义 |
| FL   | FL-01 | 手机号登录/注册流程            | 中             | 登录结果传递给前端即可 |
| FL   | FL-02 | Token 刷新流程                 | 高             | 定时刷新逻辑建议放在壳层还是前端未指定 |
| FL   | FL-03 | Token 验证流程                 | 中             | 多数情况由后端处理，壳层可选实现前置校验 |
| FL   | FL-04 | 跨客户端 SSO 流程              | 高             | 主进程/Host 负责 session.dat 检查与 IPC 通知 |
| FL   | FL-05 | 会话销毁（退出登录）           | 高             | 壳层负责删除本地会话文件和 Token 缓存 |

---

## 2. 关键歧义点与建议

### 2.1 session.dat 的读写职责（US-02, US-03, FL-04, BR-06）

**问题描述**

- BR-06/FL-04 中使用“客户端”这一泛称描述对 `C:\\ProgramData\\Passport\\session.dat` 的读写与加解密：
  - 未明确这是壳层主进程/Host 的职责，还是前端渲染进程也可以直接读写文件系统；
  - 在 Electron/WebView2/CEF 这类混合架构中，推荐文件 IO 与 DPAPI 绑定由主进程或原生模块完成，渲染进程通过 IPC 调用。
- AI 若按照“客户端 = 前端”来理解，会在前端代码中直接写 `fs.readFile('C:\\ProgramData...')` 或 P/Invoke DPAPI，这是不符合安全与分层原则的。

**建议改写/补充（示意）**

在 BR-06 后追加壳层职责说明，例如：

```md
【壳层职责补充说明】

- `session.dat` 的读写、加解密和完整性校验逻辑由 **客户端壳层或其加载的原生模块** 实现；
- Web 前端（渲染进程）不得直接访问文件系统路径，仅能通过 IPC 调用壳层暴露的接口：
  - `readSession(): Promise<LocalSession | null>`
  - `writeSession(session: LocalSession): Promise<void>`
  - `clearSession(): Promise<void>`
- 壳层在应用启动和退出登录时调用这些接口，并向前端发送统一的会话状态事件（例如 `session.status`）。
```

---

### 2.2 应用生命周期与 SSO 启动时机（US-02, FL-04）

**问题描述**

- FL-04 仅以“用户打开游利社客户端”笼统表达，没有明确：
  - 对于 Electron/CEF，这一动作具体对应哪一生命周期（进程启动？首个窗口创建？窗口聚焦？）；
  - 是否需要在多窗口、多实例场景下控制只在“第一次启动”进行 SSO 检查；
  - 若进程在后台保活，第二次显示主窗口时是否需要再次检测 session.dat。
- AI 根据不同理解，会选择不同的 Hook 点：`app.on('ready')`、`window.on('focus')` 等，行为差异较大。

**建议改写/补充（示意）**

在 FL-04 中加入“壳层启动策略”小节（与上一轮示例一致），例如：

```md
壳层 SSO 启动策略：

- 当 Passport 集成客户端的 **进程启动且首次创建主窗口** 时，壳层执行一次 SSO 检查：
  1. 调用原生模块读取并解密 `session.dat`；
  2. 根据 BR-06 的完整性与 2 小时规则决定是否视为有效会话；
  3. 通过 IPC 将会话状态推送给前端（例如 `session.status = "sso_available" | "none"`）。
- 之后的窗口激活或最小化/还原，不再重复文件检查，除非用户显式退出登录或收到封禁通知。
- Windows 单实例策略建议开启：若已有实例运行，新启动请求应将焦点切换至已有窗口，而不是创建新进程。
```

---

### 2.3 Token 刷新调度位置（FL-02, BR-04）

**问题描述**

- FL-02 描述“客户端每 3 小时发起一次刷新请求”，但未说明是壳层还是前端负责刷新的定时调度：
  - 若放在前端渲染进程，页面刷新/关闭会导致定时器丢失；
  - 若放在壳层，则需要定义壳层对前端的 Token 注入与更新机制。

**建议改写/补充（示意）**

在 FL-02 末尾增加：

```md
Token 刷新执行位置建议：

- 刷新调度由 **客户端壳层** 统一管理：
  - 壳层维护当前会话的刷新计划（3 小时 + 抖动），按计划主动调用 API-03；
  - 刷新成功后，通过 IPC 将新的 Access Token 下发给前端；
  - 若刷新失败超过重试限制，则向前端发送 `session.status = "expired"`，前端需跳转到登录页；
- Web 前端不再自行维护刷新定时器，以避免与壳层策略冲突。
```

---

### 2.4 退出登录与封禁的本地行为（US-04, FL-05, BR-07, BR-08）

**问题描述**

- BR-07/BR-08 只从服务端角度描述“删除 Redis 会话”、“返回封禁错误码”，未说明壳层在以下情况的处理：
  - 用户在当前客户端点击退出登录；
  - 后端封禁用户，接口返回封禁错误码；
  - 壳层是否需要统一清除本地 session.dat、内存 Token、通知前端退回登录界面。

**建议改写/补充（示意）**

在 FL-05 和 BR-08 中各加一句壳层职责说明：

```md
壳层在收到前端发起的退出登录请求或从 HTTP 响应中检测到封禁错误码时，应统一执行：
- 删除本地 `session.dat` 文件；
- 清空壳层中缓存的 Access/Refresh Token；
- 通过 IPC 通知所有前端窗口：`session.status = "logged_out" | "banned"`，前端应跳转到登录页并清空 UI 中的用户信息。
```

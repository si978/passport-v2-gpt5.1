# Passport 统一认证中心 - 开发前问题清单与解决方案（v1.1）

> 目的：在进入实际开发（编码实现）前，将当前文档体系中仍存在的**开放问题 / 不确定点**系统性梳理，并给出明确的解决方案与落地点（更新到现有文档或新增设计文档），避免“边开发边决策”的高风险模式。

基线文档：

- 需求与决策：PRD v1.1（SSoT）、Q-01～Q-19、C-01～C-07、6 个工程视图；
- 工程与测试：开发计划（Cycle1～29）、测试用例-DevPlan 对齐版、TDD 适配分析、单元测试设计-TDD 版、会话整理（开发入口 / 开发与测试TDD 版等）。

---

## 1. 问题一：SSO 启动性能目标 T 未定量化

### 1.1 问题描述

- PRD 10.1 节对“本地 SSO 性能”给出：
  - “从用户启动客户端到自动完成登录的 **P95 耗时应小于目标值 T ms**（T 由性能评估阶段确定，当前信息不足，需在《性能测试方案》文档中补充）”；
- 当前状态：T 未有具体数值，性能方案文档尚未创建，可能导致：
  - 开发阶段无法判断实现是否满足性能需求；
  - 测试阶段难以制定 KPI 与压测目标。

### 1.2 解决方案 / 决策

1. **引入暂定的性能目标 T，并允许通过正式决策流程调整**：
   - 在 V1 阶段，针对“标准测试环境”（公司内部推荐配置的 Windows 客户端 + 正常网络）设定：
     - **本地 SSO 启动 P95 目标值 T = 1500ms**；
   - 说明：
     - 1500ms 在典型桌面环境下兼顾“相对流畅体验”和“对网络 / 设备波动有一定容差”；
     - 未来如有更严格要求，可通过新增 Q/C 决策与 PRD 版本升级调整。
2. **创建专门的性能与监控设计文档**：
   - 新增：《passport-统一认证中心-性能与监控设计方案.md》，对：
     - SSO 启动、登录接口、刷新接口等性能目标（P50/P90/P95）进行定义；
     - 性能测试方法、环境与基准数据进行约定；
     - 关联到监控指标与告警阈值。

### 1.3 落地与文档更新

- 在新文档中给出完整性能目标与测试方案；
- 在主 PRD 10.1 节中，将“目标值 T 由性能评估阶段确定”更新为：
  - T = 1500ms，具体说明与后续调整机制见《性能与监控设计方案》文档；
- 在测试用例文档中，TC-SSO-FL04-006 已引用 T，视为本性能目标的测试落地。

---

## 2. 问题二：监控与日志方案缺少工程级细节

### 2.1 问题描述

- PRD 12 章仅列出需要接入的关键监控指标（登录成功率 / 错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口错误率等）；
- LoginLog（DM-04）定义了字段，但：
  - 没有约定标准化日志格式（文本 / 结构化）与采集方式；
  - 监控指标的 metric 命名、标签（label）与聚合维度未明确；
  - 告警规则仅在“需接入统一监控系统”层面笼统描述。

### 2.2 解决方案 / 决策

1. **在《性能与监控设计方案》中对指标进行工程级定义**：
   - 为每个指标定义：
     - metric 名称（例如 `passport_login_success_total`、`passport_login_error_total` 等）；
     - 标签（`app_id`、`error_code`、`channel` 等）；
     - 指标类型（counter / gauge / histogram）；
     - 采集点（在哪些服务 / 代码路径记录）。
2. **为 LoginLog 与关键行为日志定义结构化格式**：
   - 在新文档《passport-统一认证中心-日志与审计设计.md》中：
     - 明确 LoginLog 表字段含义与必填性；
     - 定义后端服务的结构化日志字段（如 trace_id / guid / app_id / error_code 等）；
     - 说明日志与监控如何关联（例如通过 error_code / guid 对齐）。

### 2.3 落地与文档更新

- 新增：
  - 《passport-统一认证中心-性能与监控设计方案.md》；
  - 《passport-统一认证中心-日志与审计设计.md》；
- 在测试用例文档中，TC-ADMIN-FL07-003 已覆盖指标上报验证；
- 在 Dev Plan 中，相关 Task（Cycle28/29）已约定“监控接入”，细节通过新设计文档补全，不再是开放问题。

---

## 3. 问题三：数据模型（DM-01～DM-04）的数据库 Schema 与迁移脚本未显式定义

### 3.1 问题描述

- PRD 8 章给出抽象数据模型（User / Session / LocalSession / LoginLog），但：
  - 没有明确表结构（字段类型、索引、主键、唯一键等）；
  - 没有给出数据库迁移策略（初始建表 / 增量变更方式）；
  - Dev Plan 中的 Task 默认“表已存在”，可能在落地时引发理解偏差。

### 3.2 解决方案 / 决策

1. **创建专门的数据库设计文档**：
   - 新增：《passport-统一认证中心-数据模型与数据库设计.md》，针对 DM-01～DM-04：
     - 给出建议的表 DDL（以通用 SQL 语法为准，可映射到 MySQL 等 RDBMS）；
     - 定义主键 / 唯一键 / 外键约束与索引；
     - 对高频查询字段（如 phone / guid / login_time）给出索引建议。
2. **在 Dev Plan 中现有 Task 的 DoD 中引用该文档**：
   - AUTH-01 / ADMIN-04 相关的 BE Task（如用户 / 会话 / LoginLog 读写）在实现时应以该数据库设计文档为依据。

### 3.3 落地与文档更新

- 新增：《passport-统一认证中心-数据模型与数据库设计.md》并按 DM-01～DM-04 定义表结构；
- 如有需要，可在 Dev Plan 中为“数据库建模与迁移脚本”新增一个 Task（例如 `[AUTH-01][DM][DB]`），但不作为需求侧开放问题。

---

## 4. 问题四：技术栈 / 项目结构未在需求外单独固化

### 4.1 问题描述

- 当前文档体系有清晰的分层架构（前端 / 壳层 / 原生 / 后端），但：
  - 没有一份独立的技术方案文档总结后端技术选型（语言 / Web 框架 / 测试框架等）、项目结构与模块划分；
  - 客户端侧（尤其壳层 / 原生）的实现方式与 IPC 机制也未在统一文档中归纳；
  - 这会导致不同团队在实现时各自假设，增加集成与维护成本。

### 4.2 解决方案 / 决策

1. **创建统一技术方案与架构设计文档**：
   - 新增：《passport-统一认证中心-技术方案与架构设计.md》，内容包括：
     - 后端服务技术栈（示例：语言 X + 框架 Y + ORM Z + 单测 / 集成测框架）；
     - 模块划分（认证服务 / 后台管理 / 日志与监控适配层等）；
     - 客户端架构（Web 前端技术栈、壳层语言 / 宿主框架、原生模块实现方式与 IPC 协议）；
     - 部署拓扑（单服务 or 多服务、与其他系统的集成点）。
2. **避免在 PRD 中硬编码技术选型**：
   - 技术方案文档与 PRD 解耦，PRD 继续只描述业务语义，技术选型变更时仅需更新技术方案文档。

### 4.3 落地与文档更新

- 新增：《passport-统一认证中心-技术方案与架构设计.md》，在其中给出推荐技术栈与项目结构；
- 会话整理（开发与测试TDD版）中可以将该文档列为开发阶段“技术视角入口”。

---

## 5. 问题五：外部依赖（短信网关 / 监控平台 / Redis 与 DB 部署）的不确定性

### 5.1 问题描述

- PRD 与 Dev Plan 已识别若干外部依赖：
  - 短信网关：用于验证码发送（API-01 / BR-09）；
  - 监控与告警平台：用于指标上报与告警（12 章）；
  - Redis 与数据库部署方式 / HA：与 C-07 相关；
- 但尚未确定：
  - 具体短信服务提供方与接入协议；
  - 指标上报到何种监控系统（Prometheus / 公司内部平台等）；
  - Redis / DB 的实际部署拓扑（单节点 / 主从 / 集群）。

### 5.2 解决方案 / 决策

1. **通过抽象接口解耦实现与需求**：
   - 在技术方案文档中定义：
     - `SmsGatewayClient` 抽象接口（sendCode，带超时与重试策略），具体实现可基于公司统一短信平台或第三方服务；
     - `MetricsClient` 抽象接口，屏蔽 Prometheus / 其他监控后端差异；
     - Redis / DB 访问层通过配置驱动连接信息，不在业务代码中绑定部署形态。
2. **在运维 / 架构文档中定义推荐最小部署方案**：
   - 对 V1，给出“单 Region、最小 HA”建议：
     - Redis：主从或哨兵方案，满足会话数据的高可用；
     - DB：主从或集群，但对登录流量已通过 Token + Redis 进行削峰；
     - 短信：使用公司统一短信平台，或指定一个首选供应商。

### 5.3 落地与文档更新

- 在《技术方案与架构设计.md》中引入上述抽象接口；
- 在公司更上层的运维 / 架构文档中（如已有统一运维规范）结合本项目给出示例部署拓扑；
- 对于本仓库而言，外部依赖的不确定性不再体现在需求与 Dev Plan 上，而是通过抽象接口与配置解决。

---

## 6. 问题六：迁移（14 章）与 HA（C-07）策略仅在“占位”层面定义

### 6.1 问题描述

- PRD 第 14 章《兼容性 & 迁移》和 C-06 明确“迁移方案由独立文档负责”；
- C-07 将 Redis 高可用与多机一致性归属架构 / 运维文档；
- 当前状态：
  - 未有《迁移方案》与《HA 设计》文档草稿，可能导致后续演进时缺少统一约束。

### 6.2 解决方案 / 决策

1. **在当前 V1 开发中，迁移与 HA 视为“未来演进”而非阻塞项**：
   - 对 V1 新系统，可以按“全新部署，无历史数据迁移”假设实施；
   - 迁移与 HA 文档可在 V1 开发中 / 后逐步补齐，不阻碍功能开发上线。
2. **仅创建占位性设计文档，记录约束与 TODO**：
   - 新增：《passport-统一认证中心-迁移与高可用方案-草案.md》，内容包括：
     - 明确当前 V1 假设（无历史迁移 / 单 Region HA）；
     - 列出未来需要考虑的场景（老用户 GUID 迁移、多 Region 部署、灾备等）；
     - 给出初版的原则性约束（例如 GUID 不可变、退出 = 全局退出在多 Region 下如何实现等）。

### 6.3 落地与文档更新

- 新增：《passport-统一认证中心-迁移与高可用方案-草案.md》；
- 保持 PRD 14 章与 C-06/C-07 的“职责边界”描述不变，将本草案视为架构 / 运维后续工作的起点，而非当前开发阻塞项。

---

## 7. 综合结论

通过以上问题梳理与解决方案设计：

- 需求侧未定项（如性能目标 T）已通过设定初始目标 + 引入专门设计文档的方式补齐；
- 工程侧缺失的设计层内容（性能与监控、日志与审计、数据库设计、技术方案、迁移与 HA）均有了明确的承载文档与行动方向；
- 对外部依赖的不确定性通过抽象接口与部署建议进行了解耦，避免阻塞 V1 功能开发。

在上述前提下，可以认为：**从文档与决策角度看，当前已不存在必须在编码前先解决的“硬阻塞问题”，可以进入实际开发阶段；新文档将作为后续技术方案的依据与演进基础。**

# Passport 统一认证中心 - 技术方案与架构设计（v1.0 草案）

> 目的：在 PRD v1.1 与多视图决策已明确业务与分层职责的前提下，从工程实现角度给出统一的技术方案与架构设计，减少各团队各自假设带来的集成风险。

> 说明：本草案不在 PRD 中硬编码具体技术选型，如后续实际选型有变化，可通过更新本文件保持与 PRD 语义的一致性。

---

## 1. 总体架构概览

- 客户端：
  - Web 前端：实现 UI 与交互、Token 管理与错误处理；
  - 客户端壳层：应用生命周期管理、IPC、刷新调度、本地会话文件读写与清理；
  - 原生模块：封装 DPAPI、文件 IO 与设备标识获取，向壳层暴露简洁接口。
- 服务端：
  - Passport 认证服务：提供 API-01～API-05 接口，负责 GUID 与会话管理；
  - 管理后台：提供用户查询、封禁/解封、活跃数据查询与导出接口；
  - 日志与监控适配层：负责上报监控指标与写入 LoginLog / 业务日志。

---

## 2. 抽象客户端架构（与实现语言无关）

### 2.1 Web 前端

- 职责：
  - 登录/注册 UI 与交互；
  - 调用 API-01/02/03/04/05；
  - 根据错误码展示用户友好提示；
  - 调用壳层提供的 SSO 状态接口（例如通过 IPC 收到 `session.status` 事件）。

### 2.2 客户端壳层

- 职责：
  - 定时调用 API-03 刷新 Token（按 BR-04 / FL-02）；
  - 在启动时从原生模块读取 LocalSession 并判断是否可用（BR-06 / C-03）；
  - 在退出登录 / 封禁时清理本地 Token 与会话文件（FL-05 / BR-07 / BR-08）。

### 2.3 原生模块

- 提供接口（示例）：
  - `read_session_file() -> (payload | ERR_SESSION_NOT_FOUND | ERR_SESSION_CORRUPTED)`；
  - `write_session_file(payload) -> (ok | error)`；
  - `delete_session_file() -> (ok | error)`；
- 使用 Windows DPAPI 对本地文件加密，控制 ACL 确保仅当前用户可读写。

---

## 3. 服务端分层

### 3.1 典型分层

- API 层：HTTP 接口定义与请求校验；
- 应用层（Service）：封装业务流程（登录/刷新/验证/退出/封禁/查询活跃等）；
- 领域层（Domain）：BR-01～BR-09 规则实现（如 GUID 规则、Token 生命周期、本地会话规则等）；
- 基础设施层（Infra）：访问数据库 / Redis / 短信网关 / 监控系统等。

### 3.2 抽象接口

- `SmsGatewayClient`：
  - `sendCode(phone, templateId, params) -> Result`；
  - 内部封装第三方或公司统一短信平台；
- `MetricsClient`：
  - `incCounter(name, labels)`；
  - `observeHistogram(name, value, labels)`；
- Redis / DB 客户端：
  - 通过配置驱动连接信息与池化参数，不在业务代码中硬编码。

---

## 4. 部署与集成（V1 最小可行方案）

- 部署拓扑（建议）：
  - 单 Region，1～N 台 Passport 服务实例（无状态），前置统一网关或负载均衡；
  - Redis：主从或哨兵部署，作为会话存储；
  - DB：主从或单主多从，存储用户与登录日志等持久化数据；
  - 监控与日志：接入公司统一监控与日志平台（本文件中不限定具体产品）。

- 对 PRD C-07 的响应：
  - 本方案仅满足 V1 单 Region 高可用需求，多 Region / 更复杂一致性方案在《迁移与高可用方案-草案》中讨论。

---

## 5. 与 Dev Plan / Test / UT 的关系

- Dev Plan 中的 BE Task 需要基于本技术方案选择的框架与分层模式进行实现；
- 测试用例与 UT 设计不依赖具体技术栈，但假定存在清晰的服务接口与抽象层次；
- 如技术栈选型与本草案不同，应确保：
  - 不改变 PRD 中定义的业务语义与约束；
  - 更新本设计文档以反映实际实现方式。

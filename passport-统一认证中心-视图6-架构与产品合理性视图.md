# Passport 统一认证中心 - 视图 6：架构 / 产品合理性视图

> 说明：本视图从架构与产品层面，基于《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版）对约束、模糊点、隐含需求与风险进行归纳，重点关注那些会使多端实现（Web/壳层/原生/后端）在设计上分歧较大的地方，并沉淀为 C-01 ～ C-07 等多视图冲突项。本视图用于支撑架构设计与后续版本规划，如与主 PRD 存在任何不一致，应以主 PRD 为准；C-xx 最终采纳方案以《passport-统一认证中心-多视图冲突与决策清单-已决策.md》及主 PRD 第 19 章为依据。

---

## 1. 主要需求与约束回顾（按 US/BR/FL）

| 类型 | ID   | 简要内容                               |
|------|------|----------------------------------------|
| US   | US-01 | 手机号 + 验证码登录/注册               |
| US   | US-02 | 基于本地会话文件的跨客户端 SSO          |
| US   | US-03 | 网吧下机后，依赖系统和客户端自动清理会话 |
| US   | US-04 | 用户主动退出登录，等价于全局退出         |
| US   | US-05 | 管理后台查询与封禁/解封                 |
| BR   | BR-01 | GUID 生成与唯一性                      |
| BR   | BR-02 | 登录/注册判定规则                      |
| BR   | BR-03 | Token 类型与有效期                     |
| BR   | BR-04 | Token 刷新策略                         |
| BR   | BR-05 | Token 验证流程                         |
| BR   | BR-06 | 本地会话文件读写与过期规则             |
| BR   | BR-07 | 会话 TTL 与全局退出                    |
| BR   | BR-08 | 封禁/解封规则                          |
| FL   | FL-01 | 登录/注册流程                          |
| FL   | FL-02 | Token 刷新流程                         |
| FL   | FL-03 | Token 验证流程                         |
| FL   | FL-04 | 跨客户端 SSO 流程                      |
| FL   | FL-05 | 会话销毁流程                           |

---

## 2. 发现的主要模糊点与潜在不合理约束

### 2.1 SSO 有效期（2 天）与网吧安全预期

**现状**

- G-02/G-03 + BR-03 定义：
  - Refresh Token 有效期为 2 天；
  - 跨客户端 SSO 有效期与 Refresh Token 一致；
  - 辅以 BR-06 中“创建时间 > 2 小时强制删除 session.dat”与 Windows 注销清理 Temp 目录作为安全兜底。

**潜在问题**

- 2 天的 SSO 有效期对于个人设备友好，但对网吧这种高频换人场景相对保守：
  - 如果机器长时间不重启且用户未正常下机（异常断电、网吧软件异常），可能存在异常残留风险；
  - 目前通过 “2 小时 + DPAPI + 文件权限” 组合控制，是否足以满足公司安全基线需要进一步论证。

**建议**

- 在未来版本评审中，考虑引入“网吧模式”配置：
  - 网吧模式下可将 SSO 有效期缩短（如 12 小时或单日），或增加更多本地行为约束（如定期强制回到登录页）；
  - 或区分“公共设备”与“个人设备”，在前端/壳层安装时设置设备类型，进而使用不同的策略。

---

### 2.2 单机 Redis 依赖与高可用策略

**现状**

- PRD 中假设 Redis 单机用作会话存储（6.2、16.1、16.2）。

**潜在问题**

- Redis 单点故障会导致：
  - 所有登录/验证接口不可用或登录状态错乱；
  - 当前 PRD 没有给出“Redis 不可用时的降级行为”（例如是否允许本地 Token 短期继续使用）。

**建议**

- 在 NFR 或架构文档中增加：
  - 最低高可用要求（主从/集群、持久化策略、RPO/RTO 目标）；
  - Redis 级别的监控指标（错误率、延迟、内存占用）和告警阈值；
  - Redis 故障时的业务降级策略（可以简单定义为“所有登录行为失败，提示稍后重试”，不允许自动放宽验证规则）。

---

### 2.3 错误码体系与多端统一

**现状**

- 13 章目前仍较为概括，仅“需补充”；
- 各关键场景（验证码错误/过期/频率限制、Token 错误、封禁等）已有散落描述，但未沉淀成统一 ERR 表。

**潜在问题**

- 不同端（客户端、管理后台、监控）在展示错误与统计错误时可能使用不同标识，影响观测与报表对齐。

**建议**

- 在 13 章补齐统一错误码表，并做到：
  - 每类错误绑定一个稳定的 code（如 `ERR_CODE_INVALID`、`ERR_REFRESH_EXPIRED`、`ERR_USER_BANNED` 等）；
  - 定义对应的 HTTP 状态码和简要英文描述；
  - 在 7.1、9.1.1、12.2 等章节引用，确保前后端与监控平台对齐。

---

### 2.4 前端 / 壳层 / 原生边界不够“显式”

**现状**

- PRD 在 BR-06、FL-04 中用“客户端”泛称所有终端逻辑；
- 通过 Q-01～Q-19 决策后，虽在审查文档中已澄清，但主 PRD 正文中仍未系统梳理三层边界。

**潜在问题**

- 不同团队阅读 PRD 时易产生分歧：
  - 前端可能认为自己需要处理文件系统与 DPAPI；
  - 原生模块开发者可能不清楚自己需要暴露的接口给壳层/前端。

**建议**

- 在第 2 章或新增“客户端分层说明”小节（1 页以内）：
  - 明确 Web 前端、壳层、原生模块三层职责；
  - 不写具体实现，仅作为架构约定，便于各工程视图和 AI codegen 对齐。

---

### 2.5 兼容性与迁移策略缺失（14 章）

**现状**

- 14 章尚为空，未说明现有九尾狐/游利社账号向 Passport GUID 的迁移策略。

**潜在问题**

- 不清楚：
  - 老用户第一次使用 Passport 时 GUID 如何生成，是基于历史数据还是全新生成；
  - 是否存在“老系统 ID ↔ GUID”的映射表，如何维护；
  - 历史登录日志是否需要迁移或按新规则重写。

**建议**

- 在 14 章至少给出最小可行迁移方案轮廓：
  - 对已有用户：按既定规则离线批量生成 GUID，并维护映射表；
  - 对历史登录数据：是否需要继续展示在新管理后台，如是，则约定关联字段（使用 GUID 还是老 ID）。

---

## 3. 隐含需求与风险清单

### 3.1 隐含需求

1. **登录态与 Token 刷新的前端/壳层统一中间件**：
   - 目前从 BR/FL 可以推断需要统一 Token 管理中间件（拦截 401 刷新 Token 等），但未在 PRD 明说；
   - 对 AI 生成跨端代码而言，最好在 PRD 或架构文档中显式提出这一“中间件层”。

2. **封禁后的通知机制**：
   - PRD 假设“客户端在收到封禁错误码时清理本地会话”，隐含着 API 调用者要能识别此错误并统一处理；
   - 若将来引入服务端推送（如 WebSocket）或统一通知中心，封禁还可通过主动推送下发。

### 3.2 风险清单（补充）

- **RISK-03：本地文件/DPAPI 调用失败**（见视图 3 建议）；
- **RISK-04：错误码/监控指标不统一导致运维困难**；
- **RISK-05：多客户端/多实例并发刷新 Token 或退出/封禁时的一致性问题**（需要在 BR-04、BR-07、BR-08 中加入“幂等与并发场景”描述）。

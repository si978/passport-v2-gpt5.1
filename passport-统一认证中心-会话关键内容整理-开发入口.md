# Passport 统一认证中心 - 会话关键内容整理（开发阶段入口版 v1.1）

> 目的：本文件作为**进入开发阶段的入口导航文档**，帮助产品 / 研发 / 测试 / 架构同学在开工前快速对齐：
> - 本期唯一权威需求文档（PRD v1.1 SSoT）的位置与作用；
> - 与开发直接相关的关键决策（Q-xx / C-xx）与接口 / 分层要点；
> - 现有会话整理文档在版本上的分工与历史快照。

---

## 0. 适用范围与版本关系

- **适用 PRD 版本**：`Passport 统一认证中心 - PRD（V1 多视图对齐版）`（v1.1，文件：`passport-统一认证中心-PRD-草稿.md`）。
- **已合入的决策范围**：
  - 产品 / 业务层：Q-01 ～ Q-19（文件：`passport-统一认证中心-PRD-审查与决策汇总-已决策.md`）。
  - 工程 / 架构层：C-01 ～ C-07（文件：`passport-统一认证中心-多视图冲突与决策清单-已决策.md`）。
- **文档地位**：
  - PRD v1.1 是**唯一权威需求文档 / 单一事实源（SSoT）**；
  - 本文件只做“开发阶段导航与重点提炼”，不新增或修改任何需求，以 PRD 文本为准。

### 0.1 当前会话整理文档的版本分工

| 文件名 | 对应 PRD 版本 / 阶段 | 角色定位 | 备注 |
| ------ | --------------------- | -------- | ---- |
| `passport-统一认证中心-会话关键内容整理-开发入口.md` | PRD v1.1（进入开发阶段） | **当前使用的开发入口版**：告诉你现在应该看哪些文档、抓哪些关键点 | 本文件 |
| `passport-统一认证中心-会话关键内容整理.md` | PRD v1.1（多视图审查收敛完成后） | 多视图已决策版的详细会话整理，完整梳理 Q-xx / C-xx 与各工程视图的关系 | 作为深入理解的补充资料 |
| `passport-统一认证中心-会话关键内容整理-历史v1.md` | PRD v1.0（仅 Q-xx 已决策） | 仅包含 Q-01～Q-19 审查结果的历史快照，不含 C-xx | 仅供历史追溯 |

---

## 1. 开发阶段应该先看的三份文档

> 若你刚加入项目准备开始开发，实现 / 联调 / 写用例时，请**优先确保读完这三份**：

1. **主 PRD：`passport-统一认证中心-PRD-草稿.md`**  
   - 标题：Passport 统一认证中心 - PRD（V1 多视图对齐版），版本 v1.1；
   - 文档地位：项目开发 / 测试 / 运维的唯一权威需求文档（SSoT）；
   - 关键关注章节（建议优先阅读顺序）：
     - 1 章 背景 & 目标（Why）
     - 2 章 范围 & 约束（Scope）
     - 4 章 用户故事（US）
     - 5 章 业务规则（BR-01～BR-09）
     - 6 章 流程（FL-01～FL-05）
     - 8 章 数据模型（DM-01～DM-04）
     - 9 章 接口概览（API-01～API-05）
     - 10 / 12 / 13 / 16 / 17 章：NFR、监控、错误码、风险、验收标准。

2. **产品层决策索引：`passport-统一认证中心-PRD-审查与决策汇总-已决策.md`**  
   - 内容：Q-01 ～ Q-19 的问题背景、方案对比与最终决策；
   - 用途：当你对某条业务规则或流程（BR / FL）“为什么这么写”有疑问时，按 Q-xx 追溯决策；
   - 开发期常用：Q-01（SSO 有效期）、Q-02（Token 安全）、Q-03/05/07/08/12（本地会话文件）、Q-11/19（User.status & 封禁）、Q-18（串号定义）。

3. **工程&架构层决策索引：`passport-统一认证中心-多视图冲突与决策清单-已决策.md`**  
   - 内容：C-01 ～ C-07 的多视图冲突与最终决策；
   - 用途：当多端（前端 / 壳层 / 原生 / 后端 / QA / 架构）对实现细节观点不一致时，按 C-xx 看最后拍板结果；
   - 开发期常用：C-01（注销用户重新注册生成新 GUID）、C-02（Redis 故障统一失败）、C-03（SSO 有效期“2 天 + 2 小时阈值”组合）、C-05（ERR_SESSION_NOT_FOUND 复用策略）。

---

## 2. 从开发视角看系统分层与职责

### 2.1 客户端三层分工（PRD 2.4 / AC-17 / BR-06 / FL-04）

- **Web 前端（视图 1）**：
  - 职责：页面 / 交互 / 校验 / 状态管理；
  - 不做的事：不直接访问文件系统，不调用 DPAPI，不持久化 Refresh Token 到磁盘；
  - 重点对齐：
    - BR-09：手机号 & 验证码规则；
    - BR-03 / BR-04 / BR-05：Token 生命周期与错误码处理；
    - 7.1 / AC-02 / AC-04：登录、退出入口与网吧串号场景。

- **客户端壳层（视图 2）**：
  - 职责：应用生命周期、IPC、刷新调度、`session.dat` 读写与清理；
  - 需实现：
    - 按 FL-02 调度 Refresh Token 刷新（3 小时 + 抖动 + 重试）、向前端下发新 Access Token；
    - 按 FL-04 在启动时调用原生模块读取 `session.dat`，执行完整性 + 2 小时阈值校验，并向前端广播 `session.status`；
    - 按 FL-05 / BR-07 / BR-08 在退出登录或封禁时清理本地会话文件和内存 Token，并广播退出状态。

- **原生模块（视图 3）**：
  - 职责：封装系统能力（文件 IO、DPAPI、设备标识等），向壳层暴露 `read_session_file` / `write_session_file` / `delete_session_file` 等接口；
  - 必须支持的错误码（PRD 13.3）：
    - `ERR_SESSION_NOT_FOUND`：本地无 `session.dat`；
    - `ERR_SESSION_CORRUPTED`：解密成功但结构 / 时间字段不合法；
  - 与 PRD 对齐点：BR-06 的本地会话文件结构、安全与过期规则。

### 2.2 后端服务职责（视图 4）

- 实体模型：User / Session / LocalSession / LoginLog（PRD 8 章）；
- 核心接口：API-01～API-05（PRD 9.1 / 9.2），建议按 README 中路径 + Method 实现；
- 关键业务规则：
  - BR-01：GUID 生成与唯一性；
  - BR-02：手机号登录/注册判定 + User.status 三态（1 / 0 / -1）；
  - BR-03 / 04 / 05：Access/Refresh 生命周期、刷新、验证规则；
  - BR-07：会话 TTL、退出幂等；
  - BR-08：封禁 = 立即全局失效（删 Redis 会话 + 客户端强制退出）；
  - ERR 13.1～13.4：错误码与 HTTP 状态映射。

### 2.3 测试与验收边界（视图 5 / PRD 17 章）

- 核心验收点：
  - AC-01：手机号登录/注册是否按 BR-02 正确区分“已有用户 / 新用户 / 封禁用户 / 注销用户”；
  - AC-02：跨客户端 SSO 在网吧 / 公共设备场景下**不发生串号**；
  - AC-03：退出登录是否实现“退出 = 全局退出”；
  - AC-04：网吧下机（Windows 注销）后，下一个用户是否不会继承前一用户的会话。
- 测试用例编写建议：
  - 以 FL-01～FL-05 为主线，结合 BR / ERR 构造正向 / 反向 / 异常用例；
  - 针对 Redis 故障（C-02）、多客户端并发刷新或退出、封禁等场景，确保幂等与一致性按 PRD 要求覆盖。

---

## 3. 开发期必须牢记的关键决策（Q / C 精简版）

### 3.1 产品层（Q-xx）

- **Q-01：SSO 有效期与范围** → 2 天 Refresh Token 生命周期内，同一 Windows 用户下九尾狐 / 游利社可互相自动登录。
- **Q-02：Token 安全** → Token 中必须有 `guid` / `user_type` / `account_source` / `app_id`，所有 Token 相关接口走 HTTPS，验证时必须校验 `app_id`。
- **Q-03 / Q-05 / Q-07 / Q-08 / Q-12：本地会话文件安全与清理** → Temp 短期 Token 依赖 Windows 注销清理；ProgramData 中的 `session.dat` 由客户端按照“完整性 + 2 小时阈值 + expires_at = created_at + 2 天”规则管理与清理。
- **Q-11 / Q-19：User.status 与封禁关系** → `1=正常, 0=封禁, -1=注销/删除`；封禁 = 立即删除 Redis 会话并禁止登录，客户端必须在收到封禁错误码后清理本地会话并退出。
- **Q-15 / Q-17：性能与监控** → 本地 SSO 登录需达成本地 P95 耗时目标 T（详见性能方案），并接入登录成功率、错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口错误率等监控指标。
- **Q-18：串号定义与验收** → 未通过当前用户手机号 + 验证码登录而直接进入其他用户账号的行为即为串号，AC-02 中要求覆盖网吧 / 共享设备场景，测试用例必须显式覆盖。

### 3.2 工程 / 架构层（C-xx）

- **C-01：注销用户登录行为** → `status = -1` 的账号不会被重新激活，同手机号再次登录视为“新注册”，生成新的 GUID，旧记录仅供审计 / 统计。
- **C-02：Redis 故障策略** → Redis 不可用或严重异常时，登录 / 刷新 / 验证统一失败并提示“稍后重试”，禁止绕过 Redis 仅凭本地 Token 放行。
- **C-03：SSO 有效期与网吧安全** → V1 采用“Refresh Token 2 天 + LocalSession 创建时间 2 小时阈值 + Temp 清理”的组合方案，进阶“网吧模式”留待后续版本评估。
- **C-05：ERR_SESSION_NOT_FOUND 复用** → 继续统一使用 `ERR_SESSION_NOT_FOUND` 表示“远端 Redis 无会话”与“本地无 session.dat”，但在日志与监控中必须依赖接口名 / 子系统等维度区分来源。

> 其它 C-xx（多用户切换、迁移、HA 细节）在 V1 中主要归属技术 / 架构文档，不直接改变产品语义，实现时参照对应视图与架构设计文档。

---

## 4. 开发阶段的文档更新与协作约定

1. **新增 / 修改需求**  
   - 先更新主 PRD 中相应章节并修改“变更记录”表；
   - 如存在新的模糊点或方案选择，先在 Q 文档中新增 Q-20 / Q-21… 进行审查记录，再回填 PRD；
   - 本开发入口整理仅在发生“影响整体理解路径”的变更时更新，例如：PRD 主版本变更（v1.x → v2.0）、新增一批 Q/C、引入重要新视图等。

2. **新增工程冲突 / 设计取舍**  
   - 继续沿用 C-xx 体系，在 C 文档中按 C-08 / C-09… 记录多视图讨论与决策；
   - 决策落地后更新 PRD 对应 BR / NFR / 数据模型 / 流程，并在第 19 章“冲突与决策结果”增加摘要。

3. **协作建议**  
   - 产品负责：主 PRD、Q 文档的更新与一致性；
   - RD / 架构负责：C 文档、工程视图文档，以及技术设计 / 架构 / 运维文档；
   - QA 负责：基于 PRD + Q/C 文档 + QA 视图，沉淀测试用例与自动化测试规范。

---

## 5. 历史会话整理索引

| 文档 | 对应 PRD / 阶段 | 覆盖范围 | 说明 |
| ---- | ---------------- | -------- | ---- |
| `passport-统一认证中心-会话关键内容整理.md` | PRD v1.1，多视图审查收敛完成后 | Q-01～Q-19 + C-01～C-07 + 6 视图的详细对齐说明 | 多视图已决策版整理，信息最全，适合深入理解背景与过程 |
| `passport-统一认证中心-会话关键内容整理-历史v1.md` | PRD v1.0（仅 Q-xx 已决策） | Q-01～Q-19 | 仅产品层决策的早期整理快照，不含 C-xx，不建议再作为开发参考 |

> 若你只关心“现在应该怎么做”，优先阅读本文件 + 主 PRD + Q/C 文档；
> 若你还想了解“当时都讨论过什么”，可以顺着上表继续往回翻历史会话整理。

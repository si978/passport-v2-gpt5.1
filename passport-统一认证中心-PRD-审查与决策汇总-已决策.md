# Passport 统一认证中心 - PRD 审查与决策汇总（已决策）

> 说明：本文件将《passport-统一认证中心-PRD-审查待决策.md》与《passport-统一认证中心-PRD-审查已决策.md》的内容合并，统一记录 Q-01 ～ Q-19 的问题背景、可选方案及**最终产品决策**，并标注已在《passport-统一认证中心-PRD-草稿.md》（V1 多视图对齐版）中的落地位置。  
> 本文件是 Q-01 ～ Q-19 审查与决策过程的**权威记录与索引文档**，但在项目开发 / 测试 / 运维中，如与《passport-统一认证中心-PRD-草稿.md》存在不一致，应一律以该 PRD 作为唯一权威需求文档（SSoT）。

---

## 0. 决策总览表

| 问题 ID | 章节位置（PRD 草稿） | 问题简述 | 选择方案 | 已落实位置（文档名称 + 模块 ID） |
| ------- | ------------------- | -------- | -------- | --------------------------------- |
| Q-01 | 1.3 本版本目标 G-02 / US-02 / FL-04 | “一次登录、多客户端共享会话的体验”缺少时间/客户端范围定义 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》1.3 G-02、US-02、FL-04 |
| Q-02 | 1.3 本版本目标 G-03 / BR-03～BR-05 | “安全可控的 Token 能力”表述笼统 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》1.3 G-03、BR-03～BR-05 |
| Q-03 | 1.3 本版本目标 G-04 / US-03 / BR-06 / 5.4 | “本地额外保险机制”未在目标处说明具体机制 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》1.3 G-04、US-03、BR-06、5.4 |
| Q-04 | 2.1 In Scope / 2.2 Out of Scope | “未来其他客户端”范围不清晰 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》2.1、2.2 |
| Q-05 | 2.3 前置假设 / US-03 / BR-06 | “清理用户临时目录，用于删除部分 Token 文件”中“部分”不清楚 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》2.3、US-03、BR-06 |
| Q-06 | 3.2 AC-17 / 8.4 LocalSession | “设备信息等”中“等”不明确 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》3.2、8.4 |
| Q-07 | US-03 / 5.4 网吧下机清理 / BR-06 | “本地 Token 文件被系统删除”未区分具体文件 | 方案 A+B | 《passport-统一认证中心-PRD-草稿.md》US-03、5.4、BR-06 |
| Q-08 | BR-06 本地会话文件规则 | “验证文件内容完整性”未给出可见规则 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》BR-06 |
| Q-09 | FL-02 Token 刷新流程 | “客户端每 3 小时自动刷新”起算点/容差不明确 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》FL-02 |
| Q-10 | 7.1 登录后状态与退出入口 | “明显的‘退出登录’入口”缺乏可测试标准 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》7.1 |
| Q-11 | 8.2 User.status 字段 / BR-08 | 类型定义为 string/int，语义和枚举值不清晰 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》8.2、BR-08 |
| Q-12 | 8.4 LocalSession.expires_at / BR-06 | “具体计算方式当前信息不足” | 方案 A | 《passport-统一认证中心-PRD-草稿.md》8.4、BR-06 |
| Q-13 | 8.5 LoginLog.logout_time | “未做心跳时可为空”含义不清 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》8.5 |
| Q-14 | 9.1 API 概览 | 多数接口仅有语义，无 HTTP Method/URL | 方案 A+B | 《passport-统一认证中心-PRD-草稿.md》9.1.1、9.2 |
| Q-15 | 10.1 性能 | “响应速度应明显优于远程校验”无法量化 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》10.1 |
| Q-16 | 11 权限与安全控制 | “封禁/解封等敏感操作”及后台角色不清 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》11 |
| Q-17 | 12.2 监控与告警 | 日志和监控指标大量以“需补充”带过 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》12.2 |
| Q-18 | 17 验收标准 AC-02 / US-03 / 5.4 | “不应出现异常账号串用”表述主观 | 方案 A+B | 《passport-统一认证中心-PRD-草稿.md》17 AC-02、US-03、5.4 |
| Q-19 | BR-08 管理后台封禁规则 / 6.6 会话管理 | 封禁与现有会话和已登录端关系未定义 | 方案 A | 《passport-统一认证中心-PRD-草稿.md》BR-08、6.6 |

> 详细论证与可选方案见下文第 1 章。

---

## 1. 逐条问题背景、可选方案与最终决策

> 本章基于原《passport-统一认证中心-PRD-审查待决策.md》第 3 章内容整理，并补充“最终决策”小节，与你确认的 Q1–Q19 方案保持一致。

### Q-01：G-02 一次登录、多客户端共享会话

- **问题回顾**：目前仅描述为“一次登录、多客户端共享会话”，未限定时间窗口、客户端范围、是否仅限同一 Windows 用户。
- **风险 / 影响**：
  - 若时间窗口过长，安全风险变大（尤其网吧共享设备场景）。
  - 若范围不清，未来新增客户端可能被误认为“天然支持 SSO”，带来额外交付压力。
- **可选方案**：
  - **方案 A：绑定 Refresh Token 生命周期（2 天）**  
    - 在 Refresh Token 有效期 2 天内，同一 Windows 用户下的所有已接入客户端均可复用本地会话文件完成免二次登录。  
    - 优点：实现简单，规则统一；与现有 Token 设计一致。  
    - 风险：2 天时间对网吧等公共场景可能偏长，需要依赖本地文件清理机制兜底。
  - **方案 B：绑定当前 Windows 登录会话 / 短窗口**  
    - 仅在当前 Windows 登录会话期间生效，一旦用户注销系统或超过例如 4 小时窗口，必须重新登录。  
    - 优点：安全性更高，更贴合网吧“下机即结束”的预期。  
    - 风险：实现上需要更精细的时间和会话管理，对家庭 PC 用户可能稍微打扰频率更高。
- **最终决策**：
  - 采用 **方案 A**：SSO 有效期与 Refresh Token 生命周期保持一致（2 天），在同一 Windows 用户下的已接入客户端（首期为九尾狐、游利社）可在此期间基于本地会话文件免二次登录；安全性由 2 小时会话文件强制删除机制和封禁策略兜底。

### Q-02：G-03 安全可控的 Token 能力

- **问题回顾**：“安全可控”缺少可验证的具体标准。
- **风险 / 影响**：安全评审和开发可能对“安全”的理解不一致，难以形成统一验收口径。
- **可选方案**：
  - **方案 A：列出最小安全要求清单**  
    - 必须绑定 `guid`、`user_type`、`account_source`、`app_id`；Access/Refresh 过期时间固定；必须通过 HTTPS 传输；Token 验证必须校验 `app_id` 与调用方一致。  
  - **方案 B：仅引用公司通用安全规范**，在 PRD 中只写“参见统一安全规范”。
- **最终决策**：
  - 采用 **方案 A**：在《passport-统一认证中心-PRD-草稿.md》1.3 G-03 明确列出最小安全要求，并在 BR-03～BR-05 中具体化，方便研发与测试直接对照验证。

### Q-03：G-04 本地额外保险机制

- **问题回顾**：“额外保险机制”在目标里是黑盒，不看 5.4 很难知道具体做法。
- **风险 / 影响**：目标层不透明，会让评审时低估该机制的重要性，影响优先级和实现质量。
- **可选方案**：
  - **方案 A：在目标中显式写出“2 小时阈值强制删除”**。  
  - **方案 B：仅在详细章节说明，不在目标中表述。**
- **最终决策**：
  - 采用 **方案 A**：将“客户端启动时，如检测到 session.dat 创建时间超过 2 小时则强制删除”写入 1.3 G-04，并在 US-03、BR-06、5.4 中具体展开，作为网吧安全的显式产品目标。

### Q-04：2.1 未来其他客户端

- **问题回顾**：“未来其他客户端”未限定清单，模糊了本期范围。
- **风险 / 影响**：
  - RD/QA/运维容易误以为对“所有潜在客户端”负责；
  - 新业务方可能误解为“一上来就能接入 Passport”。
- **可选方案**：
  - **方案 A：本期仅支持九尾狐 & 游利社，其他客户端不在范围内。**  
  - **方案 B：允许新增 1–2 个试点客户端，但需专门列入范围表。**
- **最终决策**：
  - 采用 **方案 A**：在 2.1 / 2.2 中明确本期仅支持九尾狐与游利社；其他客户端仅做架构预留，未来需通过新版本 PRD 单独评审。

### Q-05：2.3 “部分 Token 文件”位置不清

- **问题回顾**：未明确哪些文件放在 Temp，哪些在 ProgramData，会影响清理策略设计。
- **风险 / 影响**：
  - 误把 session.dat 设计到 Temp 会导致 SSO 无法持续；
  - 误以为系统会处理 ProgramData 会导致安全残留。
- **可选方案**：
  - **方案 A：缓存类 Token 在 Temp，核心会话在 ProgramData。**  
  - **方案 B：全部放 ProgramData，仅靠应用清理。**
- **最终决策**：
  - 采用 **方案 A**：在 2.3、US-03、BR-06 中明确：短期 Token 缓存（如 `tokens.dat`）存放 Temp，下机由 Windows 清理；核心会话文件 `session.dat` 存放 ProgramData，由客户端逻辑管理与清理。

### Q-06：AC-17 LocalSession 字段“等”

- **问题回顾**：“设备信息等”未明确具体字段，易造成字段随意扩展。
- **风险 / 影响**：
  - 新增字段影响兼容性；
  - 引入不必要的设备指纹数据风险。
- **可选方案**：
  - **方案 A：定义 LocalSession 字段白名单，不允许随意增加。**  
  - **方案 B：允许扩展字段，但必须带版本号并做兼容检查。**
- **最终决策**：
  - 采用 **方案 A**：在 AC-17 和 8.4 中固定字段集合（guid/phone/user_type/refresh_token/device_id/last_app/created_at/updated_at/expires_at），新增字段需通过版本评审。

### Q-07：US-03 “本地 Token 文件被系统删除”

- **问题回顾**：“本地 Token 文件”未具体到文件名与路径，可能与 session.dat 混淆。
- **风险 / 影响**：
  - 安全评审时误以为 session.dat 也由系统删除，实际却依赖客户端逻辑，造成认知差异。
- **可选方案**：
  - **方案 A：明确“仅限 Temp\\Passport\\tokens.dat 等临时文件”。**  
  - **方案 B：在 US-03 中同时说明 session.dat 的清理方式。**
- **最终决策**：
  - 采用 **方案 A + B**：在 US-03 与 5.4 中写清：系统仅自动删除 Temp 路径下的临时 Token 缓存文件，`C:\\ProgramData\\Passport\\session.dat` 由客户端在启动时按 2 小时规则和完整性校验主动清理。

### Q-08：BR-06 完整性校验黑盒

- **问题回顾**：仅说“验证文件内容完整性”，没有具体规则。
- **风险 / 影响**：
  - 实现可能只要 JSON 能解析就算通过，忽略必要字段和时间关系校验。
- **可选方案**：
  - **方案 A：结构级完整性校验（必选）。**  
  - **方案 B：在 A 基础上增加签名校验（HMAC sign 字段）。**
- **最终决策**：
  - 采用 **方案 A**：在 BR-06 中明确：读取 session.dat 时必须校验能解密为合法 JSON，包含必填字段且 `expires_at ≥ created_at`，否则删除文件并要求重新登录；是否增加签名由后续安全规范单独评估。

### Q-09：FL-02 刷新周期细节

- **问题回顾**：只说“每 3 小时自动刷新”，起算点、抖动、失败重试未定义。
- **风险 / 影响**：
  - 不同客户端实现不一致，可能导致服务端某个时间点刷新风暴；
  - 失败重试不当会导致长时间使用过期 Token。
- **可选方案**：
  - **方案 A：固定“从登录/上次刷新起每 3 小时 + 随机抖动”，并约定失败重试策略。**  
  - **方案 B：基于剩余有效期比例触发刷新。**
- **最终决策**：
  - 采用 **方案 A**：在 FL-02 中明确刷新从登录成功或上次刷新成功起每 3 小时触发，可加入 0～10 分钟随机抖动，失败时 5 分钟内最多重试 2 次，之后不再自动重试。

### Q-10：“明显的退出入口”的可测性

- **问题回顾**：“明显”是主观词，难以测试。
- **风险 / 影响**：
  - 退出入口被藏在不易发现位置，尤其网吧环境下用户无法顺利退出。
- **可选方案**：
  - **方案 A：约定“统一位置 + 2 步内可达”。**  
  - **方案 B：由 UX 提供单独规范，PRD 只引用。**
- **最终决策**：
  - 采用 **方案 A**：在 7.1 中明确“所有已登录页面，用户在不超过 2 次点击内，可从统一位置（如右上角头像菜单）找到退出入口”。

### Q-11：User.status 类型和枚举

- **问题回顾**：`status` 同时写成 string/int，且未列枚举值。
- **风险 / 影响**：
  - 数据清洗困难，封禁逻辑难以统一校验。
- **可选方案**：
  - **方案 A：统一为 int 枚举（1=正常，0=封禁，-1=注销）。**  
  - **方案 B：统一为 string 枚举。**
- **最终决策**：
  - 采用 **方案 A**：在 8.2 中定义 `status` 为 int，取值 1/0/-1，并在 BR-08 中引用该枚举做封禁与解封行为说明。

### Q-12：LocalSession.expires_at 计算

- **问题回顾**：未明确 expires_at 与 Refresh Token 的关系。
- **风险 / 影响**：
  - 本地会话与 Refresh Token 生命周期不一致，导致行为难以预期。
- **可选方案**：
  - **方案 A：expires_at = created_at + 2 天，与 Refresh Token 一致。**  
  - **方案 B：expires_at = min(created_at + 2 天, refresh_token_expires_at)。**
- **最终决策**：
  - 采用 **方案 A**：在 8.4 与 BR-06 中统一定义 `expires_at = created_at + 2 天`，与 Refresh Token 默认有效期保持一致。

### Q-13：LoginLog.logout_time 为空的处理

- **问题回顾**：只说“可为空”，未规定存储/展示/统计行为。
- **风险 / 影响**：
  - 统计在线时长或活跃度时容易误解“空值”的含义。
- **可选方案**：
  - **方案 A：DB 中使用 NULL 表示未知退出时间，前端按“暂无数据”展示。**  
  - **方案 B：使用特殊时间值（如 1970-01-01），前端隐藏。**
- **最终决策**：
  - 采用 **方案 A**：在 8.5 中约定 `logout_time` 未做心跳时存储为 NULL，前端展示“暂无数据”，报表统计时不将 NULL 视为依然在线。

### Q-14：API 概览缺少 Method/URL

- **问题回顾**：API 只有语义名，缺乏开发落地必需信息。
- **风险 / 影响**：
  - 多团队接入时各自定义 Path，无法统一网关与权限控制。
- **可选方案**：
  - **方案 A：在 PRD 中为每个 API 补充 Method + Path + 鉴权方式 + 幂等性。**  
  - **方案 B：在单独 API 规格文档中给出细节，PRD 只引用。**
- **最终决策**：
  - 采用 **方案 A + B**：在 9.1.1 中增加技术概要表（Method/Path/鉴权/幂等），并计划在后续的《Passport 统一认证中心 - API 技术规格》中给出完整请求/响应与错误码定义。

### Q-15：性能“明显优于”的量化

- **问题回顾**：“明显优于”不可度量。
- **风险 / 影响**：
  - 测试无法判断是否达标，性能优化缺乏目标。
- **可选方案**：
  - **方案 A：设定本地 SSO 登录 P95 耗时绝对阈值（T ms）。**  
  - **方案 B：设定相对远程校验方案的提升比例。**
- **最终决策**：
  - 采用 **方案 A**：在 10.1 中引入 P95 耗时目标 T（具体数值在性能测试方案中确定），作为本地 SSO 性能的基础验收标准。

### Q-16：后台角色与敏感操作

- **问题回顾**：“封禁/解封等敏感操作”的主体不清，缺乏角色与权限矩阵。
- **风险 / 影响**：
  - 运营/客服/技术之间可能出现越权操作；
  - 合规审计时难以解释“谁能做什么”。
- **可选方案**：
  - **方案 A：在 PRD 中定义运营/客服/技术支持 2–3 类角色及操作矩阵。**  
  - **方案 B：完全交给 IAM/权限系统配置，PRD 不定角色。**
- **最终决策**：
  - 采用 **方案 A**：在 11 章中列出运营/客服/技术支持三类角色及各自允许的操作（查看、封禁/解封、导出等），后续映射到公司统一权限系统。

### Q-17：监控与告警指标

- **问题回顾**：仅说“需补充”，没有列出最小监控集。
- **风险 / 影响**：
  - 上线后难以及时发现登录、Token 或三方通道故障。
- **可选方案**：
  - **方案 A：定义 Passport 最小监控指标集合。**  
  - **方案 B：只要求接入统一监控平台，不列具体指标。**
- **最终决策**：
  - 采用 **方案 A**：在 12.2 中枚举首批关键指标（登录成功率、登录错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口错误率），报警阈值由运维阶段进一步细化。

### Q-18：AC-02 “异常账号串用”定义

- **问题回顾**：“不应出现异常账号串用”是主观表述，没有可测试场景。
- **风险 / 影响**：
  - QA 难以设计覆盖串号场景的用例；
  - 线上一旦发生串号，也难以溯源是否 PRD 定义不清。
- **可选方案**：
  - **方案 A：列出典型“不允许出现”的串号场景。**  
  - **方案 B：给出判定规则（如 Windows 用户与 LocalSession 中 device_id/guid 不匹配时必须重新登录）。**
- **最终决策**：
  - 采用 **方案 A + B**：在 17 AC-02 中通过场景说明“账号串用”的含义（A 下机后 B 不能直接进 A 号），并要求在网吧/多用户共享设备下，只有通过当前用户手机号 + 验证码登录创建的新会话才可使用，LocalSession 与当前环境不匹配时必须重新登录。

### Q-19：封禁与现有会话联动

- **问题回顾**：未说明封禁对当前在线会话的影响。
- **风险 / 影响**：
  - 若封禁只影响后续登录，已有会话仍可继续调用接口，削弱封禁效果；
  - 若封禁立即踢下线，则需要额外实现会话销毁与客户端提示逻辑。
- **可选方案**：
  - **方案 A：封禁 = 立即全局失效**，删除 Redis 会话、通知客户端强制退出并删除本地 session.dat。  
  - **方案 B：封禁仅影响新登录，不主动清理已有会话。**
- **最终决策**：
  - 采用 **方案 A**：在 BR-08 中要求封禁操作立刻删除 `session:{guid}` 并使所有应用会话失效，客户端在收到封禁错误后需清理本地 session.dat 并退回登录页，实现“封禁 = 立即全局退出”。

# Passport 统一认证中心 - TDD 适配性分析（基于 Dev Plan & 测试用例 v1.1）

> 评估目标：判断当前 **需求文档（PRD）+ 开发计划（Dev Plan）+ 测试用例集** 是否满足 TDD（Test-Driven Development，测试驱动开发）实践的前置条件与约束要求。

---

## 一、TDD 模式的关键要求（评估基准）

从工程实践角度，本次评估关注以下 TDD 关键点：

1. **需求可测试性**：
   - PRD 中的 US / FL / BR / AC 是否都可以映射为可执行的断言（包含明确输入/输出与边界条件）。
2. **测试先行的可行性**：
   - 是否可以在未写业务代码前，根据开发计划与测试文档独立编写测试代码（单测/集成/E2E）。
3. **粒度与拆分**：
   - Story → FL → Task（Cycle） 的拆分是否足够细，使得可以在一个小的开发循环中实现“先写一个失败测试 → 再写最小实现 → 重构”。
4. **覆盖度与一致性**：
   - 测试用例是否覆盖所有关键 US/FL/BR/ERR 及主要 NFR（性能/监控/安全），避免“有需求无测试”。
5. **可追踪性**：
   - 测试用例是否能清晰追溯到对应的 Story/FL/Cycle，从而支持以“测试通过状态”驱动任务完成度。

本次分析仅基于文档，不判断团队是否会在实际编码中严格遵守“红-绿-重构”的操作习惯。

---

## 二、需求 → 开发计划 → 测试用例的链路检查

### 2.1 PRD → 开发计划

**结论：链路完整，满足 TDD 的“可测试需求”前置条件。**

- 全部用户故事 US-01～US-05 在 Dev Plan 中均有对应 Story：
  - [AUTH-01][US-01] 手机号登录/注册统一认证
  - [SSO-02][US-02] 同机跨客户端自动登录（SSO）
  - [SSO-02][US-03] 网吧下机后的安全退出
  - [SESS-03][US-04] 用户主动退出登录 = 全局退出
  - [ADMIN-04][US-05] 后台用户与活跃明细查询
- 所有 PRD 显式定义的 FL-01～FL-05 在 Dev Plan 中均有拆分（且逐一挂在 US 上）。
- 计划内新增的 FL-06/FL-07（验证码发送、后台查询/导出）补上了 PRD 中“仅用文字描述、未编号的后台流程和验证码发送流程”，使得这些需求也具备了“可测试单元”的身份。
- BR-01～BR-09 与 ERR 13.1～13.3 在 Dev Plan 的 Story/Task 描述中被多次引用（GUID、User.status、验证码规则、Token 生命周期、本地会话规则、退出/封禁等），为后续写测试提供了清晰约束。

### 2.2 开发计划 → 测试用例

**结论：Cycle1～Cycle29 全部在测试用例中有对应场景，可支持按 Cycle 先写测试再写实现。**

- 测试用例文件中显式为每个用例标注了：
  - 关联 Story/FL（例如 `[AUTH-01][US-01]，FL-01`）；
  - 关联 Cycle（如 `Cycle1/2/3`，`Cycle21～23`）。
- Cover Check：
  - AUTH-01（登录/刷新/验证）
    - FL-01：TC-AUTH-FL01-001…006，覆盖 Cycle1/2/3/21/22/23；
    - FL-02：TC-AUTH-FL02-001…004，覆盖 Cycle4/5/6/7；
    - FL-03：TC-AUTH-FL03-001…004，覆盖 Cycle8/9/10。
  - SSO-02（SSO + 网吧场景）
    - FL-04：TC-SSO-FL04-001…007，覆盖 Cycle11～15，并引入性能与 DPAPI/ACL 异常用例。
  - SESS-03（会话销毁 + 封禁联动）
    - FL-05：TC-SESS-FL05-001…004，覆盖 Cycle16～20，并覆盖 LoginLog 更新。
  - ADMIN-04（后台管理 + 活跃分析）
    - FL-06：TC-ADMIN-FL06-001…003，覆盖 Cycle24～26；
    - FL-07：TC-ADMIN-FL07-001…003，覆盖 Cycle27～29。

因此，从“文档/任务/测试三角”来看，每一个计划中的功能点（FL × ROLE × Cycle）都能找到至少一条对应的测试用例或 E2E 场景，满足 TDD 对“测试驱动任务完成”的要求。

---

## 三、粒度与可操作性：是否支持 TDD 的小步迭代

### 3.1 Task & Cycle 粒度

- 每个功能流程（FL）被拆分成多个按角色划分的 Task：
  - 例如 FL-01：
    - FE：Cycle1 实现前端表单与交互；
    - BE：Cycle2 实现登录/注册接口；
    - QA：Cycle3 编写 E2E 测试；
  - 类似模式贯穿 AUTH/SSO/SESS/ADMIN 四个模块。
- 测试用例层面大多是**端到端场景**（联测 FE+BE+SH/NM）：
  - TC-AUTH-FL01-001 等用例通常覆盖一整条链路，而不是仅针对单个函数；
  - 这更接近 **ATDD/BDD（验收测试驱动）** 的粒度，而非“单元测试级 TDD”。

### 3.2 对 TDD 的影响

- **可以做的**：
  - 在每个 Cycle 的实现前，先根据对应的用例编写自动化测试（API 测试、E2E 测试、集成测试）；
  - 将“用例是否通过”作为该 Cycle 完成的判定标准，从而达到“测试驱动任务完成”的效果。
- **尚欠缺的**：
  - 文档未对“单元测试级别”的拆分做细化 —— 即尚未给出例如“TokenService.generateAccessToken()”级别的测试设计；
  - 若团队想严格采用**经典 TDD（自内向外、小函数级）**，需要在设计/编码阶段进一步将这些 E2E/集成用例拆解为更细粒度的单元测试。

**小结**：当前计划非常适合 **Story/Feature 级的 TDD/ATDD**（先写场景用例再实现功能），但对于“函数级 TDD”还需要在具体设计阶段额外细化。文档本身并不阻碍 TDD。 

---

## 四、覆盖度与一致性：是否遗漏需求或冗余测试

### 4.1 覆盖情况

- **US & FL**：所有 US-01～US-05、FL-01～FL-05 + 规划内 FL-06/07 在测试集中都有对应章节。  
- **BR / ERR**：
  - BR-01～BR-09：均有正/反向用例覆盖（如 GUID 格式、User.status 三态、验证码规则、本地会话规则、TTL 与全局退出、封禁规则等）；
  - ERR 13.1～13.3：每个错误码都有明确触发场景测试（例如 ERR_CODE_INVALID / EXPIRED / TOO_FREQUENT、ERR_REFRESH_*、ERR_ACCESS_*、ERR_SESSION_*）。
- **NFR（性能/可用性/安全）**：
  - 性能：TC-SSO-FL04-006 针对“本地 SSO 启动 P95”给出了验证路径；
  - 可用性/Redis 故障：TC-AUTH-FL02-004 覆盖刷新场景下的 Redis 故障对策；
  - 安全：
    - Token 安全（签名错误、伪造、app_id 不匹配）在 TC-AUTH-FL03 系列中有覆盖；
    - 本地安全（DPAPI/ACL）在 TC-SSO-FL04-007 中有异常降级用例。
- **日志 & 监控**：
  - LoginLog 写入：TC-AUTH-FL01-006、TC-SESS-FL05-004 检查登录/退出/封禁后 LoginLog 的记录与退出时间；
  - 监控指标：TC-ADMIN-FL07-003 验证登录成功率/错误率、验证码发送失败率、Token 刷新失败率、Redis 会话错误率、接口错误率等指标的上报与一致性。

### 4.2 一致性与潜在风险

- **一致性优点**：
  - 所有用例都显式标注了关联 Story/FL/Cycle，便于回溯和维护；
  - 各模块之间的交叉（例如 AUTH 与 ADMIN 通过封禁、LoginLog 关联）在用例中有体现。
- **潜在风险点（但并非 TDD 阻碍）**：
  1. 部分 NFR（如具体 P95 阈值 T）仍在“性能方案”中待确定，用例中只能以“与 T 比较”的方式描述，需要后续填入具体数值。  
  2. Redis 故障场景目前主要在刷新流程中测试，如需对登录/退出也进行统一策略验证，可追加类似用例。  
  3. 一些日志检查在“预期结果”中是文字描述，是否在自动化测试中真正断言日志内容取决于实现阶段的测试框架选择。

总体上，这些风险更偏向“实现与执行细节”，不影响当前文档体系满足 TDD 的结构性要求。 

---

## 五、TDD 视角的综合结论

结合上述分析，可以得出以下综合判断：

1. **需求可测试性：达标**  
   - PRD 中的 US/FL/BR/AC 均已被映射到 Dev Plan 和测试用例，具备清晰的输入/输出与断言条件，可直接指导测试代码编写。

2. **测试先行的可行性：达标**  
   - 对每个 Cycle 都能找到对应的测试用例段落，QA/开发完全可以在编码前先根据这些用例编写自动化测试（集成/E2E/接口级）。

3. **粒度与拆分：适合 Story/Feature 级 TDD，单元级需二次细化**  
   - 当前文档非常适合“场景级 TDD/ATDD”：先写一个覆盖 US/FL/BR 的完整用例，再驱动 FE/BE/SH/NM 的实现；
   - 若团队希望在内部实现中进一步使用“函数级 TDD”，则需要在编码阶段从这些 E2E 用例拆解出更细粒度的单元测试，这属于设计/实现阶段的自然延伸，而非文档缺陷。

4. **覆盖度与一致性：满足 V1 质量门槛**  
   - 所有主要需求（功能 + 关键非功能）都找到了对应测试场景；
   - 用例与 Dev Plan、PRD 之间存在明确的编号与引用关系，支持基于测试通过情况进行任务追踪与验收。

5. **对 TDD 实施的建议**  
   - 在实际开发中，建议遵循以下实践以真正发挥 TDD 优势：
     - 对每个 Cycle，在开始写业务代码前，先根据对应用例实现至少一条自动化测试（API/E2E 或关键单元测试）；
     - 将“相关用例全部通过”作为该 Cycle 的 Done 标准，而不仅是代码合并；
     - 在实现过程中，必要时把复杂逻辑进一步拆解为可单测的函数/组件，并为其补充更细粒度的单元测试，依然遵循先写测试再写实现的顺序。

**总体结论**：

> 以当前的 PRD + 开发计划 + 测试用例体系，已经具备良好的 TDD 适配性，完全可以在实际项目中采用“以测试驱动 Story/Feature 完成度”的开发模式；若在编码阶段进一步细化到函数级单元测试，则可以实现更经典、更加彻底的 TDD 实践。 

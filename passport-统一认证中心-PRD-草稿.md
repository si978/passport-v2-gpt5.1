# Passport 统一认证中心 - PRD（V1 多视图对齐版）

> 说明：本 PRD 最初基于《passport统一认证中心 - 需求文档》整理而成，已根据 Q-01 ～ Q-19 的审查结论完成 V1 已决策版；当前文档在此基础上，进一步合并了 Web 前端、客户端壳层、原生模块、后端服务、测试工程、架构/产品六个视图的审查结论，形成 **V1 多视图对齐版**。本版本作为 Passport 统一认证中心在 V1 阶段的**唯一权威需求文档 / 单一事实源（SSoT）**：项目开发、测试与运维过程中，如其它文档（包括视图文档、历史版本、评审记录等）与本 PRD 存在不一致，应以本 PRD 的描述为准。对原文或当前阶段未明确的信息，仍以“当前信息不足，需补充”方式显式标注。

---

## 0. 文档元信息

- **文档名称**：Passport 统一认证中心 - PRD（V1 多视图对齐版）
- **产品/项目名称**：Passport 统一认证中心
- **版本号**：v1.1（V1 多视图对齐版）
- **文档地位**：项目开发 / 测试 / 运维的唯一权威需求文档（Single Source of Truth，简称 SSoT），其它说明性文档（视图文档、审查与决策文档、历史 PRD 等）与本 PRD 存在冲突时，一律以本 PRD 为裁决依据。
- **撰写人**：当前信息不足，需补充
- **评审人**：当前信息不足，需补充
- **创建日期**：当前信息不足，需补充
- **最近更新**：当前信息不足，需补充

**变更记录**

| 版本  | 日期           | 作者           | 变更说明 |
| ----- | -------------- | -------------- | -------- |
| v0.1  | 当前信息不足，需补充 | 当前信息不足，需补充 | 初稿     |
| v1.0  | 当前信息不足，需补充 | 当前信息不足，需补充 | V1 已决策版：根据 Q-01 ～ Q-19 审查结论更新主 PRD |
| v1.1  | 当前信息不足，需补充 | 当前信息不足，需补充 | V1 多视图对齐版：合并前端/壳层/原生/后端/测试/架构视图信息，补充错误码与分层职责，并固化 C-01 ～ C-07 多视图决策结果 |

---

## 1. 背景 & 目标（Why）

### 1.1 业务背景

公司旗下 **九尾狐**、**游利社** 两个 Windows 客户端产品当前采用分散的账号体系，存在如下问题：

1. 用户在不同产品间需要重复注册和登录，体验割裂。
2. 用户身份分散在各产品中，无法跨产品统一定位用户。
3. 账号体系扩展性差，新产品接入困难。

### 1.2 问题陈述

围绕现有账号体系存在的核心问题，可以归纳为：

- **跨产品无法统一识别用户**：同一自然人可能在九尾狐、游利社分别有账号，后续难以关联和运营。
- **登录体验割裂**：用户在同一台机器上使用多个客户端，需要分别登录，尤其在网吧场景下频繁上下机，体验较差。
- **统一治理与安全能力不足**：分散的账号体系难以统一做登录日志、风控、安全策略等集中管理（原文中已引出统一登录日志与管理后台需求）。

> 上述问题均直接来源于“分散账户体系”及其带来的现象，仅对原文用语做结构化表达。

### 1.3 本版本目标（Goals）

本版本目标围绕“Passport 统一认证中心”MVP 实现，原文已给出本版范围：

- **G-01：身份统一**  
  为所有用户生成跨产品通用的全局唯一 GUID，作为统一身份标识，且在手机号变更等场景下保持不变。

- **G-02：统一登录体验**  
  在同一台设备、同一 Windows 用户下，用户在任一已接入 Passport 的 Windows 客户端（本期为九尾狐、游利社）通过手机号 + 验证码登录成功后，在 **Refresh Token 2 天有效期内** 打开其他已接入客户端时，可基于本地会话文件自动登录，无需再次输入验证码。

- **G-03：提供安全可控的 Token 能力**  
  通过 JWT（Access Token / Refresh Token）统一管理访问凭证，包括签发、刷新、验证、存储等生命周期管理，并满足以下最小安全要求：  
  1）Token 中必须包含 `guid`、`user_type`、`account_source`、`app_id` 等关键信息；  
  2）所有与 Passport 服务端的 Token 相关接口必须通过 HTTPS 访问；  
  3）Access Token 有效期固定为 4 小时，Refresh Token 有效期固定为 2 天且不续期；  
  4）在验证 Token 时必须校验 `app_id` 与调用方标识一致，防止 Token 被跨应用滥用。

- **G-04：适配网吧场景的安全需求**  
  在网吧下机（Windows 注销）时，依赖系统清理机制删除本地临时 Token 文件，并在客户端启动时增加 **基于创建时间 2 小时阈值的本地会话文件强制删除机制**，避免下一个用户继承上一个用户的登录状态。

### 1.4 不在本版本范围的目标（Non-Goals）

原始文档未显式列出不在本版本范围的内容，结合现有信息，仅能明确：

- NG-01：**不支持除“手机号 + 验证码”以外的登录方式**（原文明确“手机号注册/登录（唯一登录方式）”）。
- 其它非手机号登录方式（如用户名密码、第三方 OAuth 等）是否规划在后续版本，当前信息不足，需补充。

---

## 2. 范围 & 约束（Scope & Constraints）

### 2.1 In Scope（在范围内）

- **用户群体**：
  - C 端个人用户（网吧用户、游戏玩家等），类型代码为 `user`。

- **接入客户端 / 系统**：
  - 九尾狐 Windows 客户端。
  - 游利社 Windows 客户端。
  - 其他客户端：当前版本仅在架构上预留接入能力，不纳入本期接入范围；后续如需新增客户端，将在新版本 PRD 中单独列出“接入客户端清单”并评审确认。

- **平台 / 环境**：
  - 主要运行环境为 Windows 客户端，依赖 Windows DPAPI 和本地文件系统。

- **本版功能范围（来自原文 1.3）**：
  - 手机号 + 验证码登录/注册（唯一登录方式）。
  - 统一身份标识（GUID）。
  - 跨客户端自动登录（基于本地会话文件共享）。
  - Token 管理（JWT：Access Token / Refresh Token）。
  - 网吧下机自动清理本地会话信息。

### 2.2 Out of Scope（不在范围内）

原文未直接说明的排除范围，当前仅能确认：

- 不支持 web 端登录/管理界面等非 Windows 客户端形态（是否规划为后续版本，当前信息不足，需补充）。
- 不覆盖除 C 端用户外的 B 端账户体系设计（仅提到 C 端用户类型 `user`，其它类型“后续添加”）。

### 2.3 前置假设 & 依赖

> 以下为基于原文陈述的显式及隐含前提，仅总结既有内容，不构成新增需求。

- 依赖 Windows 平台能力：
  - 存储本地会话文件：`C:\\ProgramData\\Passport\\session.dat`。
  - 使用 Windows DPAPI 做本地文件加密，仅当前登录用户可解密。
  - Windows 注销时会自动清理用户临时目录，用于删除位于 `C:\\Users\\{username}\\AppData\\Local\\Temp\\Passport\\tokens.dat` 等临时 Token 缓存文件；位于 `C:\\ProgramData\\Passport\\session.dat` 的本地会话文件不依赖该行为，由客户端逻辑负责管理和清理（详见本文件 BR-06 与 5.4 节）。

- 依赖基础设施与组件：
  - Redis（单机）用于会话数据、Token 缓存、验证码缓存。
  - MySQL 用于用户表、凭证表、验证码表、登录日志等结构化数据存储。
  - 短信通道用于发送手机验证码（原文引用验证码登录流程，具体通道方案未展开）。
  - 腾讯网关及网吧信息（在用户活跃表中使用），作为外部数据来源。

- 依赖已有客户端改造：
  - 九尾狐、游利社客户端需支持按统一方案读写本地会话文件，并调用 Passport 服务端相关接口。

### 2.4 客户端分层说明（Web 前端 / 壳层 / 原生模块）

> 目的：澄清“客户端”一词在不同技术视角下的职责分工，避免前端/壳层/原生模块职责边界模糊。（来源：前端视图、壳层视图、原生视图、架构视图）

- **Web 前端（React/Vue + TypeScript）**：负责 UI、表单校验、状态管理与路由，通过 HTTP/IPC 调用壳层和后端 API；不直接访问文件系统或 DPAPI。
- **客户端壳层（Electron 主进程 / WebView2 Host / CEF 进程）**：负责应用生命周期（单实例）、窗口管理、IPC 通道、集中调度 Token 刷新，以及调用原生模块完成本地会话文件读写与 DPAPI 加解密。
- **原生模块（C++/C#/Rust 等）**：封装系统能力（DPAPI、本地文件 IO、设备标识获取等），对壳层暴露 `read_session_file` / `write_session_file` / `delete_session_file` 等接口，不直接访问网络或后端服务。

---

## 3. 角色与术语（Actors & Concepts）

### 3.1 角色列表（Actors）

| ID    | 名称           | 描述 / 权限说明 |
| ----- | -------------- | -------------- |
| AC-01 | C 端用户       | 普通个人用户：网吧用户、游戏玩家等，通过九尾狐/游利社等客户端使用服务，仅能管理自己的登录状态。 |
| AC-02 | 客户端应用     | 九尾狐、游利社及其他接入 Passport 的客户端，负责本地会话文件读写、调用登录/Token 相关接口。 |
| AC-03 | Passport 服务端 | 提供统一认证、Token 管理、会话管理等能力，对外暴露接口供客户端调用。 |
| AC-04 | 后台使用人员   | 使用管理后台查看用户信息表、用户活跃表，进行封禁/解封等操作的后台用户统称。具体角色划分与权限矩阵详见第 11 章（运营 / 客服 / 技术支持角色）。 |

### 3.2 核心术语（Concepts / Entities）

| ID    | 名称              | 定义 / 说明 |
| ----- | ----------------- | ----------- |
| AC-10 | GUID              | 全局唯一用户标识，20 位数字字符串，结构为：日期（8 位）+ 用户类型（2 位）+ 随机序列号（10 位），跨业务系统通用且永久不变。 |
| AC-11 | 用户类型          | 当前定义 `user` 表示 C 端用户（普通个人用户），其它类型后续添加。 |
| AC-12 | 账户来源（account_source） | 区分用户注册来源系统：`jiuweihu`（九尾狐）、`youlishe`（游利社）、`passport`（直接在 Passport 注册）、以及后续待定的新业务。 |
| AC-13 | Access Token      | 用于访问业务接口的 JWT，默认有效期 4 小时，可通过 Refresh Token 刷新。 |
| AC-14 | Refresh Token     | 用于刷新 Access Token 的 JWT，有效期 2 天，不可续期，过期需重新登录。 |
| AC-15 | 会话（Session）   | 以 `guid` 为维度的统一会话数据，存储在 Redis `session:{guid}` 中，包含 Refresh Token 及各应用 Access Token 等。 |
| AC-16 | 应用（App）       | 接入 Passport 的业务应用，通过 `app_id` 标识，如 `jiuweihu`、`youlishe` 等。 |
| AC-17 | 本地会话文件      | 存储在 `C:\\ProgramData\\Passport\\session.dat` 的加密 JSON 文件，保存 GUID、手机号、用户类型、Refresh Token、device_id（MAC 地址）等字段，用于跨客户端 SSO；本版本 LocalSession 字段集合以 8.4 节定义为准，不允许随意扩展，新增字段需经版本评审确认。 |

---

## 4. 用户故事（User Stories，US）

> 本节仅将原文描述的核心场景转换为用户故事形式，未引入新场景。

### 4.1 核心用户故事列表

**US-01：手机号登录/注册**

- 角色：AC-01 C 端用户
- 场景：用户在网吧或本地机器上首次使用九尾狐/游利社客户端。
- 前置条件：用户能接收短信验证码；客户端已接入 Passport 统一认证中心。
- 触发：用户在客户端输入手机号，获取并输入验证码，同意用户协议后点击登录。
- 结果：
  - 若该手机号已存在，则直接登录成功，签发 Access Token 和 Refresh Token。
  - 若手机号不存在，则自动完成注册并登录，生成全局唯一 GUID，创建用户记录并签发 Token。

**US-02：跨客户端自动登录（SSO）**

- 角色：AC-01 C 端用户，AC-02 客户端应用
- 场景：用户已在九尾狐登录，随后在同一台机器上打开游利社客户端。
- 前置条件：九尾狐已按协议将会话信息写入本地加密文件，会话未过期；两客户端共用同一 Windows 用户环境。
- 触发：用户打开游利社客户端。
- 结果：
  - 游利社检测到本地会话文件并解密，校验会话未过期后，使用其中的 Refresh Token 获取自身的 Access Token，实现自动登录。
  - 若会话文件不存在或已过期，则直接展示登录页面。

**US-03：网吧下机后自动登出**

- 角色：AC-01 C 端用户，AC-02 客户端应用
- 场景：用户在网吧使用客户端后点击下机（Windows 注销）。
- 前置条件：Passport 已通过本地文件存储用户会话信息。
- 触发：Windows 用户注销或网吧计费系统触发下机流程。
- 结果：
  - Windows 自动清理用户临时目录，存放在 `C:\\Users\\{username}\\AppData\\Local\\Temp\\Passport\\` 下的临时 Token 缓存文件（如 `tokens.dat`）被系统删除。
  - 对于 `C:\\ProgramData\\Passport\\session.dat`，客户端在启动时会检查其创建时间，若超过 2 小时会强制删除，防止异常情况下残留会话文件。

**US-04：用户主动退出登录（全局退出）**

- 角色：AC-01 C 端用户
- 场景：用户在九尾狐客户端选择“退出登录”。
- 前置条件：用户当前已登录，Redis 中存在 `session:{guid}` 记录，本地存在 `session.dat` 文件和内存中的 Token。
- 触发：用户在客户端点击“退出登录”操作。
- 结果：
  - 客户端调用服务端 API 删除对应 Redis 会话（包含所有应用的 Access Token）。
  - 删除本地会话文件 `session.dat` 和内存中的 Token。
  - 当前客户端回到登录页面；其它客户端后续调用 API 会收到 401，需要重新登录。

**US-05：后台查看用户信息与活跃明细**

- 角色：AC-04 后台使用人员
- 场景：运营/客服需要按手机号、账户来源或登录渠道查看用户基本信息和登录记录。
- 前置条件：管理后台已接 Passport 数据库中的用户表、登录日志等数据。
- 触发：后台使用人员在管理后台中检索用户或导出活跃数据。
- 结果：
  - 在“用户信息表”中，通过手机号模糊搜索、账户来源筛选查看用户基本信息，并执行封禁/解封操作。
  - 在“用户活跃表”中，通过手机号、登录时间、登录渠道筛选登录记录，并可按筛选条件导出数据。

---

## 5. 业务规则（Business Rules，BR）

> 原始文档中的详细业务规则和异常处理部分主要以图片/电子表格形式呈现，本节仅整理文本中已明确的关键规则。图片中的具体枚举、错误码等需后续补充文字版。

### 5.1 规则列表概览

| ID    | 标题                          | 简要说明 |
| ----- | ----------------------------- | -------- |
| BR-01 | GUID 生成与唯一性规则        | 定义 GUID 格式与唯一性要求。 |
| BR-02 | 手机号登录/注册判定规则      | 定义手机号存在/不存在及 User.status 不同取值时的处理逻辑。 |
| BR-03 | Token 类型与有效期           | Access Token 与 Refresh Token 的用途和时效。 |
| BR-04 | Token 刷新规则               | 基于 Refresh Token 刷新 Access Token 的条件、限制与幂等性。 |
| BR-05 | Token 验证规则               | 验证 Access Token 有效性的步骤和校验点。 |
| BR-06 | 本地会话文件读写与过期规则   | 定义本地会话文件结构、加密和过期处理。 |
| BR-07 | 会话 TTL 与全局退出规则      | 指定 Redis 会话 TTL、退出登录行为及幂等性。 |
| BR-08 | 管理后台封禁/解封规则        | 管理后台对用户状态的变更规则。 |
| BR-09 | 手机号与验证码规则           | 定义手机号格式、验证码长度/有效期及频率限制等。 |

#### BR-01 GUID 生成与唯一性规则

- 条件：系统需要为新用户生成 GUID。
- 结果：
  - 生成 20 位数字字符串，格式为：
    - 前 8 位：年月日（例如 `20251114` 表示 2025-11-14）。
    - 中间 2 位：用户类型（例如 `01` 表示 C 端用户）。
    - 后 10 位：随机序列号。
  - 系统需保证 GUID 全局唯一，不可重复。
  - GUID 作为跨系统统一标识，后续无论手机号是否变更，GUID 均保持不变。

#### BR-02 手机号登录/注册判定规则

- 条件：用户在客户端提交手机号与验证码，并勾选同意用户协议。（来源：主 PRD US-01，前端视图，后端视图）
- 结果：
  - 若手机号在系统中已存在且 `User.status = 1（正常）`：
    - 执行登录流程，签发 Token，不再创建新用户记录。
  - 若手机号在系统中不存在：
    - 自动注册新用户，生成 GUID，创建用户记录，并完成登录。
  - 若手机号在系统中已存在且 `User.status = 0（封禁）`：
    - API-02 必须返回 HTTP 403，错误码 `ERR_USER_BANNED`，不签发任何 Token，不创建/更新会话。（来源：后端视图 2.2，QA 视图 FL-01，《passport-统一认证中心-多视图冲突与决策清单-已决策.md》C-01）
  - 若手机号在系统中已存在且 `User.status = -1（注销/删除）`：
    - 视为该手机号对应的历史账号已注销且不再参与登录流程；
    - 用户可以重新注册，系统按“新用户”逻辑创建新的用户记录并生成**新的 GUID**，原有 `status = -1` 的历史记录保留用于审计与统计，不再被重新激活。（决策：采纳方案 A，来源同上）
- 说明：手机号是本版本唯一的登录凭证类型，暂不支持其它登录方式。

#### BR-03 Token 类型与有效期

- Token 类型：
  - **Access Token**：
    - 用途：访问业务接口。
    - 有效期：4 小时（14400 秒）。
    - 可刷新：是（通过 Refresh Token 刷新）。
  - **Refresh Token**：
    - 用途：刷新 Access Token。
    - 有效期：2 天（172800 秒）。
    - 可刷新：否（不续期，过期后需要重新登录）。

#### BR-04 Token 刷新规则

- 条件：客户端持有有效的 Refresh Token，并发起刷新 Token 请求，需携带 `refresh_token` 与 `app_id`。（来源：主 PRD FL-02，后端视图，壳层视图）
- 结果：
  - 验证 Refresh Token 合法性并解析出 GUID；
  - 查询 Redis 会话 `session:{guid}`，检查 Refresh Token 是否匹配且在 2 天有效期内；
  - 若校验通过：
    - 为当前 `app_id` 生成新的 Access Token（4 小时有效），更新 Redis 中 `apps.{app_id}.access_token` 及 `token_expires_at`；
  - 若校验失败：
    - Refresh Token 过期 → 返回 `ERR_REFRESH_EXPIRED`（HTTP 401）；
    - Refresh Token 与 Redis 中记录不一致 → 返回 `ERR_REFRESH_MISMATCH`（HTTP 401）；
    - Token 中 `app_id` 与调用方不一致 → 返回 `ERR_APP_ID_MISMATCH`（HTTP 403）。
- 补充：
  - Refresh Token 在整个生命周期内不变，不会因刷新而续期；
  - 客户端侧建议由壳层统一调度刷新周期，每 ~3 小时（含抖动）调用一次 API-03，刷新失败超过重试阈值后通知前端回到登录页。（来源：壳层视图 FL-02，QA 视图 FL-02）

#### BR-05 Token 验证规则

- 条件：客户端携带 Access Token 调用业务接口，或显式调用 Token 验证接口 API-04。（来源：主 PRD FL-03，后端视图）
- 验证步骤：
  1. 解析 Access Token，获取 `guid` 与 `app_id` 等关键信息；
  2. 校验 Token 签名合法性；
  3. 校验 `app_id` 是否与调用方标识匹配；
  4. 查询 Redis：`session:{guid}`，检查会话中是否存在 `apps.{app_id}`；
  5. 比对 Redis 中存储的 Token 与传入的 Access Token 是否一致；
  6. 检查 Token 是否在 4 小时有效期内。
- 结果：
  - 若全部校验通过，则认为 Token 有效，并返回 `guid` 及过期时间等信息；
  - 若任一校验失败，则根据失败类型返回：
    - 过期 → `ERR_ACCESS_EXPIRED`（HTTP 401）；
    - 无法解析/签名错误 → `ERR_ACCESS_INVALID`（HTTP 401）；
    - `app_id` 不匹配 → `ERR_APP_ID_MISMATCH`（HTTP 403）。

#### BR-06 本地会话文件读写与过期规则

- 文件路径：`C:\\ProgramData\\Passport\\session.dat`。
- 内容结构（加密前 JSON 示例，字段来自原文）：

```json
{
  "guid": "20251114011234567890",
  "phone": "13800138000",
  "user_type": "user",
  "refresh_token": "...",
  "device_id": "00-16-EA-AE-3C-40",
  "last_app": "jiuweihu",
  "created_at": 1705298400,
  "updated_at": 1705298400,
  "expires_at": 1707890400
}
```

- 安全与过期规则：
  - 使用 Windows DPAPI 加密，只有当前 Windows 用户可解密；
  - 文件权限设置为当前用户独占访问；
  - 每次读取后需验证文件内容完整性，至少包含：  
    - 能成功解密为合法 JSON；  
    - JSON 中包含必填字段 `guid`、`phone`、`user_type`、`refresh_token`、`device_id`、`created_at`；  
    - `expires_at` 大于或等于 `created_at`；  
    任一校验失败时，应视为文件损坏；
  - 客户端启动时：
    - 若检测到会话文件存在且创建时间超过 2 小时，可视为异常残留，需强制删除，以防止网吧场景下下机未正常清理。（来源：主 PRD，QA 视图 FL-04）
- 分层职责与错误处理（来源：壳层视图，原生视图）：
  - 原生模块：
    - 提供 `read_session_file()` / `write_session_file()` / `delete_session_file()` 接口；
    - 发现文件不存在时返回 `ERR_SESSION_NOT_FOUND`；
    - 发现完整性校验失败时返回 `ERR_SESSION_CORRUPTED`，不直接删除文件。
  - 壳层：
    - 在应用启动和退出登录时调用上述接口；
    - 收到 `ERR_SESSION_CORRUPTED` 时负责删除 `session.dat`，并通过 IPC 通知前端 `session.status = "none"`；
    - 前端不直接访问文件系统，仅通过 IPC 与壳层交互。

#### BR-07 会话 TTL 与全局退出规则

- Redis 会话 Key：`session:{guid}`。
- TTL：2 天（与 Refresh Token 过期时间一致，过期后会话失效，需要重新登录）。
- 退出登录设计原则：
  - “退出 = 全局退出”：当用户在任一客户端执行退出登录时，视为该 GUID 在所有应用的会话都应失效；
  - 退出后，不应存在仍可用于自动登录的 Refresh Token 或 Access Token。
- 幂等与并发（来源：后端视图 2.5，QA 视图 FL-05）：
  - API-05（退出登录）以及封禁操作在删除 Redis 会话时必须是幂等的：若 `session:{guid}` 已不存在，仍视为成功，返回 200；
  - 当封禁与退出在短时间内并发发生时，以封禁后的最终状态为准，即用户被封禁后不得再登录；无论何种顺序，最终应保证 Redis 中不存在 `session:{guid}`。
- 退出流程结果（客户端侧）：
  - 删除 Redis 会话（包含所有 `apps.{app_id}.access_token`）；
  - 壳层删除本地会话文件 `session.dat`（包含 Refresh Token），并清空本地内存中的 Token；
  - 通过 IPC 向所有前端窗口广播 `session.status = "logged_out"` 或 `"banned"`，前端回到登录页并清理 UI 中的用户信息。（来源：壳层视图 2.4）

#### BR-08 管理后台封禁/解封规则

- 条件：后台使用人员在用户信息表中对某个用户执行“封禁”或“解封”操作。
- 结果：
  - 封禁：
    - 用户状态从“正常”变为“封禁”（对应 User.status 从 1 变为 0）。
    - 被封禁用户无法再登录；封禁操作执行时，服务端必须立即删除该用户的 Redis 会话 `session:{guid}`，后续该用户的任何接口请求应返回封禁相关错误码，客户端在收到该错误码时应清理本地 `session.dat` 并退回登录页。
  - 解封：
    - 用户状态从“封禁”恢复为“正常”（对应 User.status 从 0 变为 1）。
    - 用户可恢复正常登录。
  

---

## 6. 流程与状态（Flows & States）

### 6.1 业务流程（FL）

> 原文中多处以文字和图片形式给出流程，这里仅将文本部分抽象为流程编号。涉及到图片中细节（如异常分支、错误码等）需后续补全文本描述。

#### FL-01 手机号登录/注册流程

- 适用范围：AC-01 C 端用户在任一接入客户端首次或再次登录。
- 关联用户故事：US-01。
- 步骤（对应原文步骤）：
  1. 用户在客户端输入手机号。
  2. 用户获取并输入短信验证码。
  3. 用户勾选并同意用户协议。
  4. 系统判断：
     - 若手机号已存在：直接登录。
     - 若手机号不存在：自动注册并登录。
  5. 登录成功后：
     - 生成全局唯一 GUID（仅首次注册）。
     - 创建/更新用户记录。
     - 签发 Access Token 与 Refresh Token。
     - 写入 Redis 会话和本地会话文件。
- 异常分支：原文通过图片表格给出详细异常场景（如验证码错误、超时、频率限制等），当前文本未包含，需后续补充。

#### FL-02 Token 刷新流程

- 适用范围：客户端需要在 Access Token 临近过期时获取新的 Access Token。
- 关联用户故事：US-01、US-02。
- 步骤：
  1. 客户端在用户登录成功或最近一次刷新成功后，以该时间为起点每 3 小时（可加入 0～10 分钟随机抖动）发起一次刷新请求，携带 `refresh_token` 与 `app_id`。
  2. 服务端验证 Refresh Token，解析 GUID。
  3. 查询并校验 Redis 中 `session:{guid}` 与 Refresh Token 状态。
  4. 若校验通过，为对应 `app_id` 生成新的 Access Token，并更新 Redis 会话中的应用 Token 信息。
  5. 将新的 Access Token 与有效期返回客户端。
  6. 若刷新请求失败，客户端可在 5 分钟内按退避策略重试最多 2 次；仍失败则停止自动重试，等待用户重新登录或后续手动触发。

#### FL-03 Token 验证流程

- 适用范围：业务方需要校验某个 Access Token 是否有效。
- 步骤：
  1. 调用方提交 `access_token` 与 `app_id`。
  2. 服务端解析 Access Token 获取 GUID 与 `app_id` 信息。
  3. 校验 `app_id` 与调用方是否匹配。
  4. 查询 Redis `session:{guid}`，检查该应用是否存在对应 Token。
  5. 校验 Token 是否匹配及是否过期。
  6. 返回校验结果和相关信息（如有效性标记、过期时间等）。

#### FL-04 跨客户端 SSO 流程

- 适用范围：用户已在一个 Passport 集成客户端（如九尾狐）登录，随后在同一 Windows 用户环境下打开另一个客户端（如游利社）时，希望自动登录。
- 关联用户故事：US-02。

**壳层启动策略**：

1. 当 Passport 集成客户端进程启动且首次创建主窗口时：
   - 壳层调用原生模块 `read_session_file()`：
     - 若返回 `ERR_SESSION_NOT_FOUND`：通过 IPC 发送 `session.status = "none"` 给前端，前端展示登录页；
     - 若返回 `ERR_SESSION_CORRUPTED`：壳层删除 `session.dat`，发送 `session.status = "none"`；
     - 若返回合法 `LocalSession` 对象：继续执行步骤 2。
2. 壳层检查 LocalSession：若 `created_at` 距当前时间超过 2 小时，则删除 `session.dat`，并通知前端 `session.status = "none"`；否则通知前端 `session.status = "sso_available"`，并附带 `guid` 与 `refresh_token`。

**前端自动登录流程**：

3. 当前端收到 `session.status = "sso_available"` 时：
   - 使用壳层提供的 `refresh_token` 和自身 `app_id` 调用 API-03 刷新 Token；
   - 刷新成功后进入已登录态，并通过 IPC 通知壳层，壳层调用 `write_session_file()` 更新 `last_app`、`updated_at` 字段。
4. 若 API-03 刷新失败（例如 Refresh Token 过期或不匹配）：
   - 前端清空本地登录态，通知壳层执行 `clearSession()`，并展示登录页。

#### FL-05 会话销毁（退出登录）流程

- 适用范围：用户在任一客户端主动退出登录。
- 关联用户故事：US-04。
- 步骤（对应原文“会话销毁流程”）：
  1. 用户在九尾狐客户端点击“退出登录”。
  2. 客户端调用服务端 API 删除 `session:{guid}`。
  3. 删除本地会话文件 `session.dat`（含 Refresh Token）。
  4. 清空客户端内存中的 Token。
  5. 当前客户端返回登录页面。
  6. 其它客户端后续调用 API 收到 401 错误，尝试刷新 Token 也因本地文件不存在而失败，随后展示登录页面。

### 6.2 状态机（示意）

> 原文未给出正式的状态枚举，这里仅根据描述抽象“会话状态”示意，具体编码和更多状态（如冻结、黑名单）当前信息不足，需补充。

**状态对象：会话（Session）**

- ST-01：ACTIVE — 会话存在于 Redis，Refresh Token 在有效期内。
- ST-02：EXPIRED — Refresh Token 过期（TTL 到期），会话自然失效。
- ST-03：DESTROYED — 用户主动退出后，会话被服务端删除。

允许的状态流转：

- ST-01 → ST-02：
  - 条件：Refresh Token 超过 2 天有效期，Redis TTL 到期。
- ST-01 → ST-03：
  - 条件：用户在任一客户端主动退出登录，调用会话删除接口。

不允许的状态流转：

- ST-02 / ST-03 → ST-01：
  - 说明：过期或销毁的会话不能恢复，需要用户重新登录创建新会话。

---

## 7. 界面与交互（UI / UX）

> 原文主要从流程和表格角度描述，未提供具体界面原型和文案，仅能根据现有说明提炼关键界面，具体 UI 设计需后续补充。

### 7.1 客户端登录相关界面

1. **手机号登录界面**
   - 主要元素：
     - 手机号输入框。
     - 获取验证码按钮。
     - 验证码输入框。
     - 同意用户协议勾选框。
     - 登录按钮。
   - 行为：
     - 触发 FL-01 登录/注册流程。
     - 具体错误提示（如验证码错误、超时、发送频率限制）当前以图片/表格形式存在，文案需补充。

2. **登录后状态与退出入口**
   - 用户登录成功后，客户端需在统一位置（如右上角用户头像下拉菜单）提供“退出登录”入口，用户在不超过 2 次点击的情况下即可触达该入口，触发 FL-05 会话销毁流程。
   - 退出后的界面回到手机号登录界面。

### 7.2 管理后台界面

1. **用户信息表**
   - 主要功能：
     - 按手机号模糊搜索用户。
     - 按账户来源（如游利社、九尾狐）筛选用户列表。
   - 字段（来自原文表格）：
     - 用户ID、手机号、用户类型、账户来源、账户状态（正常/封禁）、注册时间、最后登录时间、登录次数、登录天数、操作（封禁/解封）。

2. **用户活跃表**
   - 主要功能：
     - 按手机号、登录时间、登录渠道筛选登录记录。
     - 支持按筛选条件导出数据。
   - 字段（来自原文表格）：
     - 用户ID、手机号、用户类型、登录渠道（九尾狐/游利社，SSO 情况下多条记录）、登录时间、退出时间（最后一次心跳时间或主动退出时间，当前未做心跳时可为空）、IP 地址、MAC 地址、腾讯网关、网吧名称。

---

## 8. 数据模型（Data Model，DM）

> 本节仅依据原文给出的示例 JSON、表格字段做结构化整理，未增加额外字段或约束。

### 8.1 主要实体一览

| ID    | 实体名        | 说明 |
| ----- | ------------- | ---- |
| DM-01 | User          | 用户基础信息。 |
| DM-02 | Session       | 统一会话（Redis 中的 `session:{guid}`）。 |
| DM-03 | LocalSession  | 本地会话文件 `session.dat` 的数据结构。 |
| DM-04 | LoginLog      | 登录日志/用户活跃记录。 |

### 8.2 User（DM-01）

> 字段来自“用户信息表”与基础定义部分；部分约束（如是否必填）原文未明确，以下仅标注“当前信息不足，需补充”。

| 字段名       | 类型      | 说明 |
| ------------ | --------- | ---- |
| guid         | string    | 全局唯一用户标识（GUID），20 位数字。 |
| phone        | string    | 用户手机号，作为账号标识，用于手机号登录。 |
| user_type    | string    | 用户类型，当前为 C 端用户 `user`，后续可扩展。 |
| account_source | string  | 账户来源：`jiuweihu`、`youlishe`、`passport` 等。 |
| status       | int        | 账户状态枚举：1=正常，0=封禁，-1=注销/删除。 |
| register_at  | datetime  | 注册时间。 |
| last_login_at | datetime | 最近一次登录时间。 |
| login_count  | int       | 累计登录次数（登录 1 次记 1）。 |
| login_days   | int       | 登录天数（1 天记 1 次）。 |

### 8.3 Session（DM-02）

> 来自原文 Redis JSON 示例。

实体：`session:{guid}`

| 字段名                    | 类型      | 说明 |
| ------------------------- | --------- | ---- |
| guid                      | string    | 用户 GUID。 |
| user_type                 | string    | 用户类型代码（示例为 `01`）。 |
| phone                     | string    | 用户手机号。 |
| created_at                | int       | 会话创建时间（Unix 时间戳）。 |
| last_active_at            | int       | 会话最后活跃时间。 |
| refresh_token             | string    | 共享的 Refresh Token。 |
| refresh_token_expires_at  | int       | Refresh Token 过期时间（Unix 时间戳）。 |
| apps                      | object    | 各应用 Access Token 信息，以 `app_id` 作为 key。 |

`apps.{app_id}` 子结构示例：

| 字段名          | 类型 | 说明 |
| --------------- | ---- | ---- |
| access_token    | string | 对应应用的 Access Token。 |
| token_expires_at| int | Access Token 过期时间。 |
| last_login_at   | int | 该应用最近登录时间。 |
| last_active_at  | int | 该应用最近活跃时间。 |

### 8.4 LocalSession（DM-03）

> 来自本地文件 JSON 示例。

| 字段名      | 类型   | 说明 |
| ----------- | ------ | ---- |
| guid        | string | 用户 GUID。 |
| phone       | string | 用户手机号。 |
| user_type   | string | 用户类型。 |
| refresh_token | string | 用于跨客户端获取各自 Access Token 的 Refresh Token。 |
| device_id   | string | 设备标识（示例为 MAC 地址）。 |
| last_app    | string | 最近一次登录或刷新 Token 的应用 `app_id`。 |
| created_at  | int    | 文件创建时间。 |
| updated_at  | int    | 文件最近更新时间。 |
| expires_at  | int    | 文件过期时间，计算规则为：`expires_at = created_at + 2 天`，与 Refresh Token 有效期保持一致。 |

### 8.5 LoginLog（DM-04）

> 数据结构可参考“用户活跃表”字段，原文未给出完整数据库表定义，这里仅列出前台可见字段。

| 字段名        | 类型     | 说明 |
| ------------- | -------- | ---- |
| guid          | string   | 用户 GUID。 |
| phone         | string   | 用户手机号。 |
| user_type     | string   | 用户类型。 |
| channel       | string   | 登录渠道：九尾狐或游利社，SSO 情况下分别记录。 |
| login_time    | datetime | 登录时间。 |
| logout_time   | datetime | 退出时间：最后一次心跳时间或主动退出时间；未做心跳时在数据库中存储为 NULL，前端展示为“暂无数据”。 |
| ip            | string   | 用户公网 IP 地址。 |
| mac           | string   | 客户端 MAC 地址。 |
| tencent_id    | string   | 腾讯网关账号。 |
| netbar_name   | string   | 网吧名称。 |

---

## 9. 接口 / API 概览（API）

> 原文提供了部分请求/响应 JSON 示例，但未给出具体 URL Path 和 HTTP Method，以下仅从语义上归类接口，路径与方法需在技术方案中补充。

### 9.1 接口列表（语义级）

| ID     | 功能             | 说明 |
| ------ | ---------------- | ---- |
| API-01 | 发送验证码       | 向指定手机号发送登录/注册用验证码。原文仅在流程中提及，未给出 JSON 示例。 |
| API-02 | 手机号登录/注册  | 依据手机号 + 验证码完成登录，若手机号不存在则自动注册后登录。 |
| API-03 | 刷新 Access Token | 使用 Refresh Token 刷新 Access Token。 |
| API-04 | 验证 Access Token | 验证 Access Token 有效性。 |
| API-05 | 退出登录（销毁会话） | 删除 Redis 会话并触发本地退出流程。 |

#### 9.1.1 接口技术概要（Method / Path / 鉴权 / 幂等性）

> 说明：下表给出本期接口的建议 Method、Path、鉴权方式和幂等性说明，最终实现细节可在 API 技术规格文档中进一步细化。

| ID     | Method | Path（建议）                     | 鉴权方式                          | 幂等性说明 |
| ------ | ------ | -------------------------------- | --------------------------------- | ---------- |
| API-01 | POST   | `/api/passport/send-code`        | 无需登录，需做人机验证与限流控制 | 对同一手机号 + 验证码用途 + 时间窗口内视为幂等 |
| API-02 | POST   | `/api/passport/login-by-phone`   | 无需 Token，使用短信验证码校验   | 对同一手机号 + 验证码组合在有效期内视为幂等 |
| API-03 | POST   | `/api/passport/refresh-token`    | 使用 Refresh Token + `app_id`    | 对同一 `refresh_token` + `app_id` 请求视为幂等 |
| API-04 | POST   | `/api/passport/verify-token`     | 使用 Access Token + `app_id`     | 纯查询接口，幂等 |
| API-05 | POST   | `/api/passport/logout`           | 需要有效 Access Token            | 对同一会话多次调用结果一致，幂等 |

> 详细的请求/响应字段及错误码，将在后续单独输出的《Passport 统一认证中心 - API 技术规格》文档中补充；本 PRD 仅保留概要信息。

### 9.2 示例接口说明（基于原文 JSON 示例）

#### API-02 手机号登录/注册

- Method: POST
- Path: `/api/passport/login-by-phone`
- 调用方：AC-02 客户端应用（Web 前端通过壳层发起 HTTP 请求）。
- 功能摘要：依据手机号 + 短信验证码完成登录；若手机号在 User 表中不存在，则自动注册后登录。

**请求体（JSON）**：

```json
{
  "phone": "13800138000",
  "code": "123456",
  "app_id": "jiuweihu"
}
```

**成功响应（HTTP 200, JSON）**：

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "guid": "20251114011234567890",
    "access_token": "...",
    "refresh_token": "...",
    "user_status": 1,
    "account_source": "jiuweihu"
  }
}
```

**失败响应示例**：

- 验证码错误/过期：
  - HTTP 400, `code = "ERR_CODE_INVALID"` 或 `"ERR_CODE_EXPIRED"`。
- 频率超限：
  - HTTP 429, `code = "ERR_CODE_TOO_FREQUENT"`。
- 用户被封禁（BR-08）：
  - HTTP 403, `code = "ERR_USER_BANNED"`。

> 错误码的完整列表与含义见第 13 章《异常处理 & 错误码（ERR）》。

#### API-03 刷新 Access Token（语义）

- 功能摘要：使用 Refresh Token 刷新 Access Token。
- 请求体示例：

```json
{
  "refresh_token": "...",
  "app_id": "jiuweihu"
}
```

- 响应体示例：

```json
{
  "code": 200,
  "message": "刷新成功",
  "data": {
    "access_token": "...",
    "expires_in": 14400
  }
}
```

#### API-04 验证 Access Token（语义）

- 功能摘要：验证 Access Token 是否有效，返回有效性与基础信息。
- 请求体示例：

```json
{
  "access_token": "...",
  "app_id": "jiuweihu"
}
```

- 响应体示例：

```json
{
  "code": 200,
  "message": "Token有效",
  "data": {
    "valid": true,
    "guid": "20251114011234567890",
    "expires_at": 1705327200
  }
}
```

> 其它接口（如发送验证码、手机号登录/注册、退出登录）的请求与响应格式，原文未给出完整 JSON 示例，当前信息不足，需补充。

---

## 10. 非功能需求（NFR）

> 原文未以“非功能需求”章节给出具体指标，这里仅整理已出现的相关约束，不新增数值型目标。

### 10.1 性能

- 本地 SSO：
  - 通过本地加密文件共享会话信息，无需进程间通信和额外网络请求；在标准测试环境下，从用户启动客户端到自动完成登录的 **P95 耗时应小于 1500 ms**（初始目标值，可在《passport-统一认证中心-性能与监控设计方案.md》中基于实际压测数据进行版本化调整），且预期明显优于仅依赖远程校验的方案。

### 10.2 可用性 / 稳定性

- Refresh Token 与 Redis TTL 统一为 2 天，确保在 Token 过期后会话自然失效，避免长期“脏会话”。
- 使用 Redis 作为会话存储：
  - 在 Redis 正常可用时，所有登录/刷新/验证操作必须依赖 Redis 进行会话校验；
  - 在 Redis 故障或不可达时，登录/刷新/验证请求统一失败，并向客户端返回相应错误与“稍后重试”提示，不引入绕过 Redis 的本地降级逻辑（安全优先策略，具体错误处理与告警由技术方案细化）。（决策：采纳保守策略，对应《passport-统一认证中心-多视图冲突与决策清单-已决策.md》C-02）

### 10.3 安全

- 本地安全：
  - 使用 Windows DPAPI 对本地会话文件加密，仅当前 Windows 用户可解密。
  - 本地会话文件权限限制为当前用户独占访问，并在客户端读取时进行完整性校验。 

- 服务端安全：
  - 所有客户端与 Passport 服务端交互走 HTTPS（在系统架构图中已注明）。
  - Token 验证需绑定 `app_id`，防止 Token 被跨应用滥用。

### 10.4 可维护性 / 可扩展性

- 用户类型、账户来源在设计上预留扩展空间（例如新增用户类型、接入新来源系统）。
- 会话结构以 `guid` 为主键，`apps.{app_id}` 为子结构，可逐步增加新应用而不影响已有业务。

---

## 11. 权限、角色与安全控制

> 原文主要从认证、会话和后台操作角度体现权限控制，本节仅做归纳。

- 客户端访问控制：
  - 客户端访问业务接口需携带有效的 Access Token，并在服务端通过 Token 验证流程。
  - 验证过程中需校验 `app_id` 与 Redis 中的会话记录，避免 Token 被其它应用复用。

- 后台操作权限：
  - 管理后台支持对用户执行封禁/解封等敏感操作。后台角色与权限建议如下（最终以权限系统配置为准）：

| 角色       | 说明           | 允许操作 |
| ---------- | -------------- | -------- |
| 运营       | 负责用户运营   | 查看用户信息、封禁/解封用户、导出用户与活跃数据 |
| 客服       | 负责用户咨询   | 查看用户信息与活跃记录，不允许封禁/解封 |
| 技术支持   | 负责问题排查   | 查看用户信息、登录日志与技术细节，不允许封禁/解封 |

- 会话与登出安全：
  - 退出登录设计为全局退出，确保 Redis 会话与本地 Token 同时被清除，防止残留会话在网吧场景下被误用。

---

## 12. 日志、监控与告警

> 原文明确提到“登录日志”以及用于统计用户活跃的数据表，但未给出监控与告警设计，以下仅整理已知部分。

### 12.1 日志

- 登录日志：
  - 记录登录时间、退出时间（最后一次心跳时间或主动退出时间）、登录渠道、IP、MAC、腾讯网关、网吧名称等信息。
  - 与“用户活跃表”字段一一对应。

- 其它关键行为日志（如验证码发送、Token 刷新失败、会话销毁失败等），原文未明确，当前信息不足，需补充。

### 12.2 监控与告警

- 最小监控指标集合（需在监控平台中统一接入，报警阈值由运维阶段确定）：
  - 登录成功率（按手机号登录接口统计）。
  - 登录错误率（含验证码错误、Token 失效等）。
  - 验证码发送失败率（含第三方短信通道错误）。
  - Token 刷新失败率（API-03）。
  - Redis 会话读写错误率。 
  - Passport 接口整体错误率（5xx 及关键 4xx 比例）。
- 对 Redis、MySQL、短信通道可用性的监控与告警策略需在运维与架构评审阶段进一步细化，当前仅要求上述关键指标必须接入统一监控与告警体系。

---

## 13. 异常处理 & 错误码（ERR）

> 说明：本章定义 Passport 统一认证中心对外暴露的主要错误码，便于前端、客户端壳层、后端和监控系统统一处理；HTTP 状态码为推荐值，具体细节可在 API 技术规格中进一步补充。

### 13.1 登录与验证码相关错误码

| 错误码              | HTTP 状态 | 适用接口           | 说明 |
|---------------------|-----------|--------------------|------|
| `ERR_CODE_INVALID`  | 400       | API-01, API-02     | 验证码错误（与发送的验证码不匹配），不创建/更新会话。 |
| `ERR_CODE_EXPIRED`  | 400       | API-02             | 验证码已过期（超出有效期），不创建/更新会话。 |
| `ERR_CODE_TOO_FREQUENT` | 429   | API-01             | 发送验证码过于频繁（命中频率限制），本次请求被拒绝。 |
| `ERR_PHONE_INVALID` | 400       | API-01, API-02     | 手机号格式不合法或不在支持范围内。 |
| `ERR_USER_BANNED`   | 403       | API-02             | 用户被封禁（User.status=0），不允许登录，也不签发 Token（参见 BR-08）。 |

> 说明：原始文档中的“业务规则/异常处理表格”可视为上述错误码的补充场景说明，后续可在 API 技术规格中按场景枚举。

### 13.2 Token 与会话相关错误码

| 错误码                  | HTTP 状态 | 适用接口       | 说明 |
|-------------------------|-----------|----------------|------|
| `ERR_REFRESH_EXPIRED`   | 401       | API-03         | Refresh Token 已过期（超出 2 天有效期），需要重新登录。 |
| `ERR_REFRESH_MISMATCH`  | 401       | API-03         | 提交的 Refresh Token 与 Redis 中记录不一致，可能为伪造或旧 Token。 |
| `ERR_ACCESS_EXPIRED`    | 401       | API-04 及业务接口 | Access Token 已过期（超出 4 小时），需要刷新或重新登录。 |
| `ERR_ACCESS_INVALID`    | 401       | API-04 及业务接口 | Access Token 无法解析或签名验证失败。 |
| `ERR_APP_ID_MISMATCH`   | 403       | API-03, API-04 | Token 中的 `app_id` 与调用方标识不一致，拒绝访问。 |
| `ERR_SESSION_NOT_FOUND` | 401/404   | API-03, API-04, API-05 | Redis 中不存在 `session:{guid}`，视为会话已失效或未登录。HTTP 具体状态在技术实现中可按场景区分。 |

> 说明：上表错误码应在 BR-04（Token 刷新）、BR-05（Token 验证）、BR-07（会话 TTL 与退出）中被引用，用于区分“需刷新 Token”与“需重新登录”等不同处理分支。

### 13.3 本地会话文件 / 原生模块相关错误码（对壳层暴露）

> 以下错误码通常不会直接返回给业务前端，而是原生模块/壳层内部使用，用于配合 FL-04（SSO）和 BR-06 的完整性校验与清理逻辑。

| 错误码                   | 适用场景              | 说明 |
|--------------------------|-----------------------|------|
| `ERR_SESSION_NOT_FOUND`  | `read_session_file()` | 本地未找到 `session.dat` 文件或文件为空。壳层应视为“无可用会话”，回退到登录页。 |
| `ERR_SESSION_CORRUPTED`  | `read_session_file()` | 文件解密成功但 JSON 结构或必填字段/时间逻辑不合法。壳层需删除 `session.dat` 并要求重新登录。 |

> 与前文 FL-04 中的描述保持一致：`ERR_SESSION_NOT_FOUND` / `ERR_SESSION_CORRUPTED` 由原生模块返回，壳层据此删除文件或通知前端展示登录界面。

### 13.4 通用错误码（占位）

> 以下为常见通用错误码占位，具体是否采用以及与公司统一错误码规范的映射，需在技术方案中补充。

| 错误码            | HTTP 状态 | 说明 |
|-------------------|-----------|------|
| `ERR_INTERNAL`    | 500       | 内部未知错误，如非预期异常；需要记录详细日志并告警。 |
| `ERR_BAD_REQUEST` | 400       | 通用参数错误，未命中更具体的错误码时使用。 |
| `ERR_UNAUTHORIZED`| 401       | 未携带任何有效认证信息（既无 Access Token 也无 Refresh Token）。 |
| `ERR_FORBIDDEN`   | 403       | 已认证但无访问权限（例如某些管理后台操作超出当前角色权限）。 |

---

## 14. 兼容性 & 迁移

- 现有账号体系与 Passport 统一认证中心之间的账号迁移、GUID 生成策略（对已有用户）、历史登录数据迁移等，在原始文档中未提及，当前信息不足，需补充。

---

## 15. 依赖 & 外部接口

- 基础设施依赖：
  - Redis 单机实例（会话、Token 缓存、验证码缓存）。
  - MySQL 数据库（用户表、凭证表、验证码表、登录日志等）。

- 外部服务依赖：
  - 短信网关：用于发送登录验证码（具体供应商、限流等规则当前信息不足，需补充）。
  - 腾讯网关与网吧信息：用于记录用户登录的网吧名称等信息（获取方式与接口当前信息不足，需补充）。

---

## 16. 风险与假设（RISK & ASSUMPTIONS）

> 本节根据原文中提及的场景与约束做归纳，不新增额外场景。

### 16.1 已知假设

- 假设-01：客户端运行在支持 Windows DPAPI 的环境中，且本地文件系统权限配置合理。
- 假设-02：网吧环境中，Windows 注销能够正常清理用户临时文件；若未清理，则依靠客户端启动时的创建时间检查进行补救。
- 假设-03：Redis 单机实例在现阶段足以承载 Passport 会话规模（扩容方案未在原文中说明）。

### 16.2 风险概览

- RISK-01：本地文件异常残留风险
  - 说明：若 Windows 未正常清理临时目录，旧用户的会话文件可能残留在机器上。
  - 缓解：客户端在启动时根据文件创建时间超过 2 小时则强制删除，作为额外保险措施。

- RISK-02：单点 Redis 故障风险
  - 说明：会话数据依赖单机 Redis，若出现故障会影响登录和 Token 验证。
  - 说明：本 PRD 仅在业务语义层约束“Redis 不可用时登录/刷新/验证统一失败并提示稍后重试”（见 10.2），不规定具体 Redis 高可用架构与主从/集群策略；高可用与扩容方案由后续《架构设计 / 运维方案》文档定义并实施。

- RISK-03：本地文件/DPAPI 失败风险（来源：原生视图 2.3）
  - 场景：当前 Windows 用户对 `C:\\ProgramData\\Passport` 无写权限、磁盘只读或满、DPAPI 调用失败等；
  - 原则：此类异常视为“无法提供本地 SSO 能力”，但不应影响在线登录本身；原生模块需返回明确错误码，壳层记录日志并降级为“仅支持本次在线登录，不写入本地会话文件”。

- RISK-04：错误码/监控指标不统一导致运维困难（来源：架构视图 3.2）
  - 场景：前后端或不同客户端对同一错误使用不同 code 或文案，导致监控与报表无法统一聚合；
  - 缓解：严格按照本 PRD 第 13 章定义的错误码进行实现，并在监控系统中以错误码为主键统计。

- RISK-05：多客户端/多实例并发刷新 Token 或退出/封禁时的一致性问题（来源：架构视图 3.2，后端视图 2.5，QA 视图）
  - 场景：同一 GUID 在多个客户端或多进程中同时刷新 Token 或执行退出/封禁操作；
  - 缓解：后端在实现 API-03、API-05 及封禁逻辑时需保证幂等性，并通过 Redis 原子操作或事务机制避免“半更新”，具体方案在技术设计文档中补充。

---

## 17. 验收标准（Acceptance Criteria）

> 以下验收点均直接对应已有流程描述，不新增新的业务行为。

- AC-01：手机号登录/注册
  - 当用户在九尾狐或游利社客户端输入合法手机号和有效期内的验证码，并同意用户协议时：
    - 若手机号已存在，系统应完成登录并签发 Access Token 与 Refresh Token。
    - 若手机号不存在，系统应创建新用户（生成 GUID）、写入用户表，并完成登录和 Token 签发。

- AC-02：跨客户端自动登录
  - 当用户在九尾狐客户端登录成功后，在同一 Windows 用户环境下打开游利社客户端时：
    - 若本地会话文件存在且未过期，则游利社客户端应通过 Refresh Token 获取自身的 Access Token，并在无需重新输入验证码的情况下完成登录。
    - 若会话文件不存在或已过期，则应直接展示登录页面，不应出现异常账号串用。其中“账号串用”定义为：在未经过当前用户手机号 + 验证码登录的前提下，客户端直接进入上一个用户的账号会话（例如 A 用户退出或下机后，B 用户在同一机器打开客户端即自动进入 A 的账号）。测试需针对上述场景设计用例验证不会发生。

- AC-03：退出登录的全局效果
  - 当用户在任一客户端执行退出登录后：
    - Redis 中对应 GUID 的会话记录应被删除。 
    - 本地会话文件 `session.dat` 和内存中的 Token 被清理。
    - 其它客户端调用接口应收到未登录/Token 失效的响应，并引导用户重新登录。

- AC-04：网吧下机自动清理
  - 当网吧用户下机（Windows 注销）后，下一个用户登录同一台机器时：
    - 临时目录中的 Token 文件应被系统清理。
    - 若 `session.dat` 因异常未被清理，客户端在启动时应根据创建时间超过约定阈值（原文示例为 2 小时）进行强制删除，确保不会串号。

---

## 18. 发布 & 里程碑

> 原文仅对“本版本实现”的能力进行了枚举，未给出分期规划和时间点。本节只提炼 MVP 范围，不扩展后续版本规划。

- **MVP / V1 范围（对应本 PRD）**：
  - 手机号 + 验证码登录/注册（唯一登录方式）。
  - GUID 身份体系与账户来源管理。 
  - JWT Token 体系（Access Token / Refresh Token）及生命周期管理。
  - 跨客户端 SSO（基于本地加密会话文件）。
  - 网吧场景适配与下机自动清理机制。
  - 管理后台基础能力：用户信息表、用户活跃表（含封禁/解封操作、查询与导出）。

- **后续版本（占位）**：
  - 原始文档未给出明确计划，当前信息不足，需补充。

---

## 19. 冲突与决策结果（多视图汇总）

> 本节对应《passport-统一认证中心-多视图冲突与决策清单-已决策.md》中 C-01 ～ C-07 的最终决策结果，便于在阅读 PRD 时快速理解关键实现/架构层面的选择。（来源：多视图冲突与决策清单-已决策）

### 19.1 主要决策结果摘要

1. **C-01：User.status = -1（注销/删除）时的登录行为（BR-02）**  
   - 决策：采纳方案 A —— 对于 `status = -1` 的历史用户账号，后续登录时视为“新注册”，创建新的用户记录并生成新的 GUID，旧记录保留为审计/统计用但不再参与登录。（详见 BR-02 与《passport-统一认证中心-多视图冲突与决策清单-已决策.md》C-01）

2. **C-02：Redis 故障时的业务降级策略（NFR/16 章）**  
   - 决策：采纳保守策略 —— 当 Redis 不可用时，登录/刷新/验证请求统一失败并提示“稍后重试”，不允许绕过 Redis 仅基于本地 Token 放行；具体错误处理、重试与告警在技术方案中细化。（见 10.2、16.2 与决策清单 C-02）

3. **C-03：SSO 有效期 2 天 vs 网吧安全（G-02/G-03/BR-03）**  
   - 决策：保持现状 —— V1 仍采用 Refresh Token 有效期 2 天 + LocalSession 创建时间 2 小时阈值 + Windows 注销清理 Temp 的组合；未来版本中再评估“网吧模式/公共设备模式”等增强方案。（见 1.3、BR-03、16.2 与决策清单 C-03）

4. **C-04：多 Windows 用户切换下 LocalSession 行为（BR-06 / FL-04）**  
   - 决策：保持现状 —— 不在 PRD 层新增约束，视为实现与安全评审问题；要求在技术方案与测试计划中显式覆盖“多用户切换/远程桌面”等场景，验证 DPAPI 与权限配置不会导致跨用户可读。（见 BR-06、FL-04 与决策清单 C-04）

5. **C-05：`ERR_SESSION_NOT_FOUND` 双重语义（13.2 vs 13.3）**  
   - 决策：采纳方案 A —— 继续使用同一错误码字符串 `ERR_SESSION_NOT_FOUND` 覆盖“Redis 无会话”（远端）与“本地无 session.dat”（本地）两类场景，但要求在日志与监控中至少按“接口名/子系统/调用点”维度区分来源，避免统计混淆。（见 13.2、13.3 与决策清单 C-05）

6. **C-06：兼容性与迁移策略（14 章）**  
   - 决策：保持现状 —— 在本 PRD 中维持 14 章为占位，迁移细节放入独立的《Passport 统一认证中心 - 迁移方案》文档中制定；制定完成后，再将核心结论回填到 PRD 14 章与决策清单中。（见 14 章与决策清单 C-06）

7. **C-07：Redis 高可用与多机部署一致性（BR-04/BR-07/6.2）**  
   - 决策：保持现状 —— PRD 只约束业务语义上的幂等和一致性（如“退出 = 全局退出”、“封禁后不得再登录”），具体 Redis 高可用方案与一致性保证策略交由架构/运维设计文档定义，不在本 PRD 中硬编码技术选型。（见 BR-04、BR-07、6.2、16.2 与决策清单 C-07）

### 19.2 与既有决策文档的关系说明

- 《passport-统一认证中心-PRD-审查与决策汇总-已决策.md》：
  - 主要记录 Q-01 ～ Q-19 对原始需求模糊点的产品/业务层决策；
  - 是 V1 业务语义与范围的**主决策源**。
- 《passport-统一认证中心-多视图冲突与决策清单-已决策.md》：
  - 记录 C-01 ～ C-07 等多工程角色视角下的实现/架构层决策结果，与本节保持一一对应；
  - 不改变 Q-01 ～ Q-19 已有业务决策，仅在其基础上补充跨端实现约束与设计选择。

